{% extends "base.html" %}

{% block title %}Team Preferences Analysis - WUSA 7U{% endblock %}

{% block page_title %}WUSA 7U - Team Preferences Analysis{% endblock %}

{% block content %}
    <div class="container mt-4">
        <div class="row">
            <div class="col-lg-10 offset-lg-1">
                <div class="card shadow">
                    <div class="card-body">
                        <div id="errorAlert" class="alert alert-danger" style="display: none;">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <span id="errorMessage"></span>
                        </div>

                        <div id="successAlert" class="alert alert-success" style="display: none;">
                            <i class="bi bi-check-circle me-2"></i>
                            <span id="successMessage"></span>
                        </div>

                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>How This Works:</strong> Below is a proposed distribution of teams to managers. It was comprised by building a random ranking of all managers, and then attempting to best satisfy each manager's submitted preferences, starting from the first randomly ranked manager. You can change any assignment you like. Once you click the button at the bottom of this page, the assignments defined will be set.
                        </div>

                        <div id="loadingMessage" class="text-center my-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Running analysis...</p>
                        </div>

                        <div id="analysisResults" style="display: none;">
                            <div class="table-responsive">
                                <table class="table table-striped table-bordered">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Manager</th>
                                            <th>Team</th>
                                        </tr>
                                    </thead>
                                    <tbody id="assignmentsTable">
                                        <!-- Results will be inserted here -->
                                    </tbody>
                                </table>
                            </div>

                            <div class="mt-4 text-end">
                                <button type="button" class="btn btn-success btn-lg" id="assignBtn">
                                    <i class="bi bi-check2-square me-2"></i>Assign Managers to Teams
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script>
        let currentAssignments = [];
        let allTeams = [];

        // Run analysis automatically on page load
        document.addEventListener('DOMContentLoaded', function() {
            runAnalysis();
        });

        function runAnalysis() {
            // Hide previous alerts
            document.getElementById('errorAlert').style.display = 'none';
            document.getElementById('successAlert').style.display = 'none';
            document.getElementById('loadingMessage').style.display = 'block';
            document.getElementById('analysisResults').style.display = 'none';

            fetch('{% url "players:run_team_analysis" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/x-www-form-urlencoded'
                }
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('loadingMessage').style.display = 'none';

                if (data.success) {
                    currentAssignments = data.assignments;
                    allTeams = data.all_teams;
                    displayResults(data.assignments);
                } else {
                    showError(data.error);
                }
            })
            .catch(error => {
                document.getElementById('loadingMessage').style.display = 'none';
                showError('An unexpected error occurred: ' + error.message);
            });
        }

        function displayResults(assignments) {
            const tableBody = document.getElementById('assignmentsTable');
            tableBody.innerHTML = '';

            assignments.forEach((assignment, index) => {
                const row = document.createElement('tr');

                // Manager column
                const managerCell = document.createElement('td');
                managerCell.textContent = assignment.manager_name;
                if (assignment.has_preferences) {
                    managerCell.innerHTML += ' <span class="badge bg-success">Submitted</span>';
                } else {
                    managerCell.innerHTML += ' <span class="badge bg-warning text-dark">No Preferences Submitted</span>';
                }
                row.appendChild(managerCell);

                // Team dropdown column
                const teamCell = document.createElement('td');
                const select = document.createElement('select');
                select.className = 'form-select';
                select.setAttribute('data-index', index);
                select.addEventListener('change', handleTeamChange);

                // Add "No Team Selected" option
                const noTeamOption = document.createElement('option');
                noTeamOption.value = '';
                noTeamOption.textContent = '-- No Team Selected --';
                select.appendChild(noTeamOption);

                // Add options for all teams
                allTeams.forEach(team => {
                    const option = document.createElement('option');
                    option.value = team.id;
                    option.textContent = team.name;
                    if (team.id === assignment.team_id) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });

                teamCell.appendChild(select);
                row.appendChild(teamCell);

                tableBody.appendChild(row);
            });

            // Update available options for all dropdowns
            updateAllDropdowns();

            document.getElementById('analysisResults').style.display = 'block';
        }

        function handleTeamChange(event) {
            const index = parseInt(event.target.getAttribute('data-index'));
            const newTeamValue = event.target.value;

            if (newTeamValue === '') {
                // No team selected
                currentAssignments[index].team_id = null;
                currentAssignments[index].team_name = null;
            } else {
                const newTeamId = parseInt(newTeamValue);
                currentAssignments[index].team_id = newTeamId;
                const selectedTeam = allTeams.find(t => t.id === newTeamId);
                if (selectedTeam) {
                    currentAssignments[index].team_name = selectedTeam.name;
                }
            }

            // Update all dropdowns to reflect new availability
            updateAllDropdowns();
        }

        function updateAllDropdowns() {
            // Get all currently assigned team IDs (filter out nulls)
            const assignedTeamIds = currentAssignments.map(a => a.team_id).filter(id => id !== null);

            // Update each dropdown
            const selects = document.querySelectorAll('#assignmentsTable select');
            selects.forEach((select, index) => {
                const currentlySelectedId = currentAssignments[index].team_id;
                const options = select.querySelectorAll('option');

                options.forEach(option => {
                    // Skip the "No Team Selected" option
                    if (option.value === '') {
                        return;
                    }

                    const teamId = parseInt(option.value);
                    // Disable if team is assigned to someone else
                    if (assignedTeamIds.includes(teamId) && teamId !== currentlySelectedId) {
                        option.disabled = true;
                        option.textContent = option.textContent.split(' (Assigned)')[0] + ' (Assigned)';
                    } else {
                        option.disabled = false;
                        option.textContent = option.textContent.split(' (Assigned)')[0];
                    }
                });
            });
        }

        document.getElementById('assignBtn').addEventListener('click', function() {
            if (!currentAssignments || currentAssignments.length === 0) {
                showError('No assignments to save. Please run the analysis first.');
                return;
            }

            // Check if all managers have teams assigned
            const unassignedManagers = currentAssignments.filter(a => a.team_id === null);
            if (unassignedManagers.length > 0) {
                showError(`Cannot assign: ${unassignedManagers.length} manager(s) have no team selected. Please assign teams to all managers.`);
                return;
            }

            const btn = this;
            const originalHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Assigning...';

            // Hide previous alerts
            document.getElementById('errorAlert').style.display = 'none';
            document.getElementById('successAlert').style.display = 'none';

            const formData = new FormData();
            formData.append('assignments', JSON.stringify(currentAssignments));
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

            fetch('{% url "players:assign_managers_to_teams" %}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                btn.disabled = false;
                btn.innerHTML = originalHtml;

                if (data.success) {
                    showSuccess(data.message);
                    // Disable the assign button after successful assignment
                    btn.disabled = true;
                } else {
                    showError(data.error);
                }
            })
            .catch(error => {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
                showError('An unexpected error occurred: ' + error.message);
            });
        });

        function showError(message) {
            const errorAlert = document.getElementById('errorAlert');
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = message;
            errorAlert.style.display = 'block';

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function showSuccess(message) {
            const successAlert = document.getElementById('successAlert');
            const successMessage = document.getElementById('successMessage');
            successMessage.textContent = message;
            successAlert.style.display = 'block';

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    </script>
{% endblock %}
