{% extends "base.html" %}
{% load custom_filters %}

{% block title %}Run Draft - WUSA 7U{% endblock %}

{% block page_title %}WUSA 7U - Run Draft{% endblock %}

{% block extra_css %}
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
    <style>
        .draft-grid {
            overflow-x: auto;
        }
        .draft-table {
            min-width: 100%;
        }
        .draft-cell {
            text-align: center;
            vertical-align: middle;
            padding: 20px;
            border: 1px solid #dee2e6;
            cursor: pointer;
            position: relative;
            width: 150px;
            min-width: 150px;
            max-width: 150px;
            white-space: nowrap;
            overflow: hidden;
        }
        .team-name {
            font-weight: 500;
            color: #212529;
        }
        .add-icon {
            font-size: 1rem;
            color: #0d6efd;
            display: none;
        }
        .draft-cell:hover .team-name {
            display: none;
        }
        .draft-cell:hover .add-icon {
            display: inline;
        }
        .draft-table thead th {
            background-color: #f8f9fa;
        }
        .draft-table thead th.hat-pick-round {
            background-color: #fff3cd;
            border-left: 3px solid #ffc107;
            border-right: 3px solid #ffc107;
        }
        .draft-table tbody td:first-child {
            background-color: #f8f9fa;
            width: 150px;
            min-width: 150px;
            max-width: 150px;
        }
        .draft-table thead th:first-child {
            width: 150px;
            min-width: 150px;
            max-width: 150px;
        }
        .draft-cell.hat-pick-round {
            background-color: #fffbef;
            border-left: 3px solid #ffc107;
            border-right: 3px solid #ffc107;
        }
        .draft-cell.hat-pick-round.picked {
            background-color: #ffeaa7;
        }
        .draft-cell.picked {
            background-color: #d1e7dd;
        }
        .draft-cell.picked .add-icon {
            display: none !important;
        }
        .draft-cell.picked .team-name {
            display: inline !important;
        }
        .draft-cell.picked:hover .team-name {
            text-decoration: underline;
            cursor: pointer;
        }
        .select2-container {
            z-index: 9999;
        }
        .select2-container--bootstrap-5 .select2-selection {
            min-height: calc(1.5em + 0.75rem + 2px);
        }
        .current-pick {
            position: relative;
            animation: glowAndBorder 2s ease-in-out infinite;
            box-shadow: 0 0 15px rgba(255, 140, 0, 0.8) !important;
            background-color: rgba(255, 140, 0, 0.1) !important;
            border-width: 3px !important;
            border-style: solid !important;
        }
        @keyframes glowAndBorder {
            0% {
                box-shadow: 0 0 15px rgba(255, 140, 0, 0.6);
                background-color: rgba(255, 140, 0, 0.1);
                border-color: rgba(20, 20, 20, 1);
            }
            25% {
                border-color: rgba(220, 38, 38, 1);
            }
            50% {
                box-shadow: 0 0 30px rgba(255, 140, 0, 1);
                background-color: rgba(255, 140, 0, 0.2);
                border-color: rgba(20, 20, 20, 1);
            }
            75% {
                border-color: rgba(220, 38, 38, 1);
            }
            100% {
                box-shadow: 0 0 15px rgba(255, 140, 0, 0.6);
                background-color: rgba(255, 140, 0, 0.1);
                border-color: rgba(20, 20, 20, 1);
            }
        }
    </style>
{% endblock %}

{% block navbar_actions %}
    <div class="d-flex gap-2">
        <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#configureDraftOrderModal">
            Configure Draft Order
        </button>
        <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#reorderTeamsModal">
            Reorder Teams
        </button>
        <form method="POST" action="{% url 'players:toggle_draft_portal' %}" class="d-inline">
            {% csrf_token %}
            <button type="submit" class="btn {% if portal_open %}btn-danger{% else %}btn-success{% endif %}">
                {% if portal_open %}Close Manager Draft Portal{% else %}Open Manager Draft Portal{% endif %}
            </button>
        </form>
        <button type="button" class="btn btn-info" id="simulateDraftBtn">
            Simulate Draft
        </button>
        <button type="button" class="btn btn-warning" id="resetDraftBtn">
            Reset Draft
        </button>
        <button type="button" class="btn btn-danger" id="openAssignPlayersBtn">
            Draft Complete - Assign Players to Teams
        </button>
    </div>
{% endblock %}

{% block content %}
    <div class="container-fluid mt-4">
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}

        {% if undrafted_daughters %}
            <div id="undraftedDaughtersAlert" class="alert alert-danger alert-dismissible fade show" role="alert">
                <h5 class="alert-heading"><i class="bi bi-exclamation-triangle me-2"></i>Manager's Daughters Not Yet Drafted (<span id="undraftedDaughtersCount">{{ undrafted_daughters|length }}</span>)</h5>
                <p class="mb-0">The draft should not begin until all manager's daughters have been preset into a draft position. <a href="#undraftedDaughtersList" data-bs-toggle="collapse" class="alert-link">Show list</a></p>
                <div class="collapse" id="undraftedDaughtersList">
                    <p class="mb-2 mt-3">The following manager's daughters have not been drafted yet:</p>
                    <ul class="mb-3" id="undraftedDaughtersListItems">
                        {% for item in undrafted_daughters %}
                            <li data-player-id="{{ item.daughter.id }}"><strong>{{ item.daughter.first_name }} {{ item.daughter.last_name }}</strong> (Manager: {{ item.manager.first_name }} {{ item.manager.last_name }})</li>
                        {% endfor %}
                    </ul>
                    <p class="mb-0">Click the <strong>Manager's Daughters Rankings</strong> button above to review the rankings and manually assign these players to draft positions.</p>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endif %}

        {% if players_with_teams_count > 0 %}
            <div class="alert alert-warning alert-dismissible fade show" role="alert">
                <h5 class="alert-heading"><i class="bi bi-exclamation-triangle me-2"></i>Players Already Assigned to Teams</h5>
                <p class="mb-0">
                    <strong>{{ players_with_teams_count }}</strong> player{{ players_with_teams_count|pluralize }} {{ players_with_teams_count|pluralize:"is,are" }} currently assigned to teams.
                    If you are starting a fresh draft, you may want to <a href="{% url 'players:list' %}" class="alert-link">reset teams</a> before beginning the draft.
                </p>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endif %}

        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-end align-items-center">
                    <div class="d-flex align-items-center gap-3">
                        <div class="text-white">
                            <small>
                                <strong>Players Selected:</strong> <span id="playersSelected">{{ drafted_players_count }}</span>
                            </small>
                        </div>
                        <div class="text-white">
                            <small>
                                <strong>Players Remaining:</strong> <span id="playersRemaining">{{ remaining_players_count }}</span>
                            </small>
                        </div>
                        <div class="text-white">
                            <small>
                                <strong>Manager's Daughters Drafted:</strong> <span id="daughtersDrafted">{{ daughters_drafted_count }}</span>/<span id="totalDaughters">{{ total_daughters_count }}</span>
                            </small>
                        </div>
                        <div>
                            <select class="form-select form-select-sm text-white bg-primary border-white" id="currentPickSelect" style="min-width: 200px;">
                                <option value="">Select Current Pick</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body">
                {% if show_grid %}
                    <div class="draft-grid">
                        <table class="table table-bordered draft-table">
                            <thead>
                                <tr>
                                    <th class="text-center">Pick</th>
                                    {% for round_num in rounds %}
                                        <th class="text-center{% if round_num in hat_pick_rounds %} hat-pick-round{% endif %}">
                                            Round {{ round_num }}
                                            {% if round_num in hat_pick_rounds %}
                                                <br><small class="badge bg-warning text-dark">Hat Pick</small>
                                            {% endif %}
                                        </th>
                                    {% endfor %}
                                    {% if has_final_round %}
                                        <th class="text-center hat-pick-round">
                                            Round {{ final_round_number }}
                                            <br><small class="badge bg-warning text-dark">Hat Pick</small>
                                        </th>
                                    {% endif %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for pick_num in picks %}
                                    <tr>
                                        <td class="text-center"><strong>{{ pick_num }}</strong></td>
                                        {% for round_num in rounds %}
                                            {% with team=pick_assignments|get_item:round_num|get_item:pick_num %}
                                                {% with existing_pick=draft_picks_map|get_item:round_num|get_item:pick_num %}
                                                    <td class="draft-cell{% if existing_pick %} picked{% endif %}{% if round_num in hat_pick_rounds %} hat-pick-round{% endif %}{% if not team %} bg-light{% endif %}"
                                                        {% if team %}data-practice-slot="{% if team.practice_slot %}{{ team.practice_slot.practice_slot }}{% else %}Not set{% endif %}"
                                                        data-team-name="{{ team }}"
                                                        data-manager-name="{% if team.manager %}{{ team.manager.first_name }} {{ team.manager.last_name }}{% else %}No manager{% endif %}"{% endif %}
                                                        {% if existing_pick %}data-player-id="{{ existing_pick.player_id }}" data-player-name="{{ existing_pick.player_name }}"{% endif %}>
                                                        {% if team %}<span class="team-name">{% if existing_pick %}{{ existing_pick.player_name }}{% else %}{{ team }}{% endif %}</span>
                                                        <i class="bi bi-plus-circle add-icon"></i>{% endif %}
                                                    </td>
                                                {% endwith %}
                                            {% endwith %}
                                        {% endfor %}
                                        {% if has_final_round %}
                                            {% if pick_num in final_round_valid_picks %}
                                                {% with team=pick_assignments|get_item:final_round_number|get_item:pick_num %}
                                                    {% if team %}
                                                        {% with existing_pick=draft_picks_map|get_item:final_round_number|get_item:pick_num %}
                                                            <td class="draft-cell hat-pick-round{% if existing_pick %} picked{% endif %}"
                                                                data-practice-slot="{% if team.practice_slot %}{{ team.practice_slot.practice_slot }}{% else %}Not set{% endif %}"
                                                                data-team-name="{{ team }}"
                                                                data-manager-name="{% if team.manager %}{{ team.manager.first_name }} {{ team.manager.last_name }}{% else %}No manager{% endif %}"
                                                                {% if existing_pick %}data-player-id="{{ existing_pick.player_id }}" data-player-name="{{ existing_pick.player_name }}"{% endif %}>
                                                                <span class="team-name">{% if existing_pick %}{{ existing_pick.player_name }}{% else %}{{ team }}{% endif %}</span>
                                                                <i class="bi bi-plus-circle add-icon"></i>
                                                            </td>
                                                        {% endwith %}
                                                    {% else %}
                                                        <td class="bg-light"></td>
                                                    {% endif %}
                                                {% endwith %}
                                            {% else %}
                                                <td class="bg-light"></td>
                                            {% endif %}
                                        {% endif %}
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Pick Player Modal -->
    <div class="modal fade" id="pickPlayerModal" tabindex="-1" aria-labelledby="pickPlayerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="pickPlayerModalLabel">Pick Player</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <div><strong>Team:</strong> <span id="teamNameDisplay"></span></div>
                        <div><strong>Manager:</strong> <span id="managerNameDisplay"></span></div>
                        <div><strong>Round:</strong> <span id="roundDisplay"></span></div>
                        <div><strong>Pick:</strong> <span id="pickDisplay"></span></div>
                    </div>
                    <div class="mb-3">
                        <select class="form-select" id="playerSelect">
                            <option value="">Loading players...</option>
                        </select>
                    </div>
                    <div id="conflictInfo" class="alert alert-warning" style="display: none;">
                        <strong>Player Conflict:</strong> <span id="conflictText"></span>
                    </div>
                    <div id="practiceSlotInfo" class="alert alert-primary" style="display: none;">
                        <strong>Team Practice:</strong> <span id="practiceSlotText"></span>
                    </div>
                    <div id="siblingInfo" class="alert alert-warning" style="display: none; background-color: #ff8c00; color: white; border-color: #ff8c00;">
                        <strong>Sibling Notice:</strong> Player has a sibling that must be drafted by the same team.
                    </div>
                    <div id="notDraftableWarning" class="alert alert-danger" style="display: none;">
                        <strong>Player is not draftable.</strong>
                    </div>
                </div>
                <div class="modal-footer justify-content-end">
                    <button type="button" class="btn btn-danger" id="undraftPlayerBtn" style="display: none;">Undraft Player</button>
                    <button type="button" class="btn btn-info" id="randomPickBtn">Random Pick</button>
                    <button type="button" class="btn btn-primary" id="confirmPickBtn" disabled>Pick Player</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Assign Players to Teams Modal -->
    <div class="modal fade" id="assignPlayersModal" tabindex="-1" aria-labelledby="assignPlayersModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="assignPlayersModalLabel">Draft Complete - Assign Players to Teams</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <p class="mb-0">
                            Clicking "Assign Players to Teams" below will assign all players to the teams that drafted them.
                            This action is difficult to undo — do not proceed until the draft board is 100% correct.
                        </p>
                        <p class="mb-0 mt-2">
                            <small>(Note: One-off trades can still be completed AFTER clicking the button below.)</small>
                        </p>
                    </div>

                    <!-- Warning 1: Undrafted players (does not block) -->
                    <div id="undraftedWarning" class="alert alert-warning" style="display: none;">
                        <strong>Warning:</strong> There <span id="undraftedVerb">are</span> still <span id="undraftedCount">0</span> unassigned/undrafted <span id="undraftedNoun">players</span>.
                        Are you sure you want to continue?
                    </div>

                    <!-- Warning 2: Pre-assigned players (BLOCKS action) -->
                    <div id="preAssignedWarning" class="alert alert-danger" style="display: none;">
                        <strong>Warning:</strong> There are <span id="preAssignedCount">0</span> players that — prior to this draft —
                        were already assigned to a team. These players must be unassigned from all teams before you can proceed.
                    </div>

                    <!-- Warning 3: Already assigned via draft (BLOCKS action) -->
                    <div id="alreadyAssignedWarning" class="alert alert-danger" style="display: none;">
                        <strong>Warning:</strong> <span id="alreadyAssignedCount">0</span> draft picks have already been assigned to teams.
                        The draft assignment has already been completed. You cannot assign players again unless you first reset the teams.
                    </div>
                </div>
                <div class="modal-footer justify-content-start">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel - Do Not Proceed</button>
                    <button type="button" class="btn btn-success" id="confirmAssignPlayersBtn">Assign Players to Teams</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Simulate Draft Modal -->
    <div class="modal fade" id="simulateDraftModal" tabindex="-1" aria-labelledby="simulateDraftModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title" id="simulateDraftModalLabel">Simulate Draft (Testing Only)</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <strong>Testing Feature:</strong> This feature should only be used for testing purposes.
                        It will randomly assign all players to teams in the draft.
                    </div>
                    <div id="simulateDraftError" class="alert alert-danger" style="display: none;">
                        <strong>Error:</strong> <span id="simulateDraftErrorText"></span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-info" id="confirmSimulateDraftBtn">Simulate Draft</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reset Draft Modal -->
    <div class="modal fade" id="resetDraftModal" tabindex="-1" aria-labelledby="resetDraftModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="resetDraftModalLabel">Danger Zone: Reset Draft</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <strong>Warning:</strong> If you proceed, ALL draft picks submitted will be reset, with no record kept of any prior picks.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmResetDraftBtn">Proceed</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Manager's Daughters Rankings Modal -->
    <div class="modal fade" id="managerDaughterRankingsModal" tabindex="-1" aria-labelledby="managerDaughterRankingsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="managerDaughterRankingsModalLabel">Manager's Daughters Rankings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Manager Submission Status -->
                    {% if managers_without_count > 0 %}
                        <div class="alert alert-warning mb-4">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <span
                                data-bs-toggle="tooltip"
                                data-bs-placement="top"
                                data-bs-html="true"
                                title="<strong>Managers who did not submit:</strong><br>{% for manager in managers_without_rankings %}{{ manager.first_name }} {{ manager.last_name }}<br>{% endfor %}"
                                style="cursor: help; text-decoration: underline dotted;">
                                {{ managers_without_count }} manager(s) have not submitted manager daughter rankings
                            </span>
                        </div>
                    {% else %}
                        <div class="alert alert-success mb-4">
                            <i class="bi bi-check-circle me-2"></i>
                            All managers have submitted manager daughter rankings
                        </div>
                    {% endif %}

                    <!-- Top 20 Players Ranking -->
                    <h5 class="mb-3">Top 20 Players (Based on Manager Daughter Rankings)</h5>

                    <div class="alert alert-info mb-4">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>How Rankings Are Calculated:</strong>
                        <ul class="mb-0 mt-2">
                            <li><strong>Borda Count:</strong> A voting system where each rank position earns points. Rank 1 earns the most points, rank 2 earns slightly fewer, and so on. Players are sorted by their total points.</li>
                            <li><strong>Suggested Draft Round:</strong> Calculated as the median (middle value) of all the rounds that managers assigned to each player. This represents the consensus view of which round each player should be drafted in.</li>
                        </ul>
                    </div>

                    {% if top_players %}
                        <div class="table-responsive">
                            <table class="table table-striped table-bordered">
                                <thead class="table-dark">
                                    <tr>
                                        <th style="width: 80px;" class="text-center">Rank</th>
                                        <th style="width: 200px;" class="text-center">Player Name</th>
                                        <th style="width: 120px;" class="text-center">Suggested Round</th>
                                        <th style="width: 150px;" class="text-center">Average Score</th>
                                        <th style="width: 120px;" class="text-center">Rankings Received</th>
                                        <th style="width: 120px;" class="text-center">Borda Count</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in top_players %}
                                        <tr>
                                            <td class="text-center">{{ forloop.counter }}</td>
                                            <td>{{ item.player.first_name }} {{ item.player.last_name }}</td>
                                            <td class="text-center">
                                                {% if item.suggested_round %}
                                                    <span class="badge bg-success">Round {{ item.suggested_round }}</span>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td class="text-center">{{ item.average_rank|floatformat:1 }}</td>
                                            <td class="text-center">{{ item.num_rankings }}</td>
                                            <td class="text-center"><strong>{{ item.borda_count }}</strong></td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            No manager daughter rankings have been submitted yet.
                        </div>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        const pickPlayerModal = new bootstrap.Modal(document.getElementById('pickPlayerModal'));
        const assignPlayersModal = new bootstrap.Modal(document.getElementById('assignPlayersModal'));
        const resetDraftModal = new bootstrap.Modal(document.getElementById('resetDraftModal'));
        const simulateDraftModal = new bootstrap.Modal(document.getElementById('simulateDraftModal'));
        let currentRound, currentPick, currentTeamId, currentCell, isEditMode, currentPlayerId;
        const picksPerRound = {{ draft.picks_per_round|default:"0" }};

        function openPickModal(cell, isEdit = false) {
            const row = cell.closest('tr');
            const rowIndex = Array.from(row.parentNode.children).indexOf(row);
            const cellIndex = Array.from(row.children).indexOf(cell) - 1; // -1 to exclude first column

            currentRound = cellIndex + 1;
            currentPick = rowIndex + 1;
            currentCell = cell;
            isEditMode = isEdit;
            currentPlayerId = cell.dataset.playerId || null;

            // Calculate overall pick number
            const overallPick = (currentRound - 1) * picksPerRound + currentPick;

            // Get team name and manager name from data attributes (not from .team-name which shows player name when picked)
            const teamName = cell.dataset.teamName;
            const managerName = cell.dataset.managerName || 'No manager';
            const practiceSlot = cell.dataset.practiceSlot || 'Not set';

            // Update modal
            document.getElementById('teamNameDisplay').textContent = teamName;
            document.getElementById('managerNameDisplay').textContent = managerName;
            document.getElementById('roundDisplay').textContent = currentRound;
            document.getElementById('pickDisplay').textContent = overallPick;
            document.getElementById('practiceSlotText').textContent = practiceSlot;

            // Reset and hide conflict and practice slot boxes
            document.getElementById('conflictInfo').style.display = 'none';
            document.getElementById('practiceSlotInfo').style.display = 'none';
            document.getElementById('siblingInfo').style.display = 'none';
            document.getElementById('notDraftableWarning').style.display = 'none';
            document.getElementById('conflictText').textContent = '';

            // Update button text and show/hide undraft button
            document.getElementById('confirmPickBtn').textContent = isEdit ? 'Update Player' : 'Pick Player';
            document.getElementById('undraftPlayerBtn').style.display = isEdit ? 'inline-block' : 'none';

            // Load available players
            loadAvailablePlayers(currentPlayerId);

            // Show modal
            pickPlayerModal.show();
        }

        // Helper function to update player counts
        function updatePlayerCounts() {
            // Count actual drafted players (cells with player data), not draft slots
            const pickedCells = document.querySelectorAll('.draft-cell.picked').length;
            const totalPlayers = {{ total_players }};
            const remainingPlayers = totalPlayers - pickedCells;

            document.getElementById('playersSelected').textContent = pickedCells;
            document.getElementById('playersRemaining').textContent = remainingPlayers;
        }

        // Helper function to update manager's daughters tracking
        function updateManagersDaughters(playerId, action) {
            const totalDaughtersElem = document.getElementById('totalDaughters');
            const daughtersDraftedElem = document.getElementById('daughtersDrafted');
            const undraftedCountElem = document.getElementById('undraftedDaughtersCount');
            const undraftedListElem = document.getElementById('undraftedDaughtersListItems');
            const alertElem = document.getElementById('undraftedDaughtersAlert');

            if (!totalDaughtersElem || !daughtersDraftedElem) return;

            const totalDaughters = parseInt(totalDaughtersElem.textContent);
            let daughtersDrafted = parseInt(daughtersDraftedElem.textContent);

            if (action === 'drafted') {
                daughtersDrafted++;
                // Remove from undrafted list
                if (undraftedListElem) {
                    const listItem = undraftedListElem.querySelector(`li[data-player-id="${playerId}"]`);
                    if (listItem) {
                        listItem.remove();
                    }
                }
            } else if (action === 'undrafted') {
                daughtersDrafted--;
                // For undrafting, we need to fetch the updated list from the server
                // to get the player name and manager info
                fetch('/draft/undrafted-daughters/')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && undraftedListElem) {
                            // Clear and rebuild the list
                            undraftedListElem.innerHTML = '';
                            data.undrafted_daughters.forEach(item => {
                                const li = document.createElement('li');
                                li.setAttribute('data-player-id', item.player_id);
                                li.innerHTML = `<strong>${item.player_name}</strong> (Manager: ${item.manager_name})`;
                                undraftedListElem.appendChild(li);
                            });
                        }
                    })
                    .catch(error => console.error('Error fetching undrafted daughters:', error));
            }

            // Update the drafted count
            daughtersDraftedElem.textContent = daughtersDrafted;

            // Update the undrafted count
            const undraftedCount = totalDaughters - daughtersDrafted;
            if (undraftedCountElem) {
                undraftedCountElem.textContent = undraftedCount;
            }

            // Hide/show the alert based on whether there are undrafted daughters
            if (alertElem) {
                if (undraftedCount === 0) {
                    alertElem.style.display = 'none';
                } else {
                    alertElem.style.display = 'block';
                }
            }
        }

        // Helper function to get cell by round and pick
        function getCellByRoundPick(round, pick) {
            const rows = document.querySelectorAll('.draft-table tbody tr');
            if (pick <= 0 || pick > rows.length) return null;

            const row = rows[pick - 1];
            const cells = row.querySelectorAll('.draft-cell');
            if (round <= 0 || round > cells.length) return null;

            return cells[round - 1];
        }

        // Helper function to find next unpicked cell
        function findNextUnpickedCell() {
            const numRounds = {{ draft.rounds|default:"0" }};
            const numPicks = {{ draft.picks_per_round|default:"0" }};

            for (let round = 1; round <= numRounds; round++) {
                for (let pick = 1; pick <= numPicks; pick++) {
                    const cell = getCellByRoundPick(round, pick);
                    if (cell && !cell.classList.contains('picked')) {
                        return { round, pick, cell };
                    }
                }
            }
            return null;
        }

        // Function to set current pick
        function setCurrentPick(round, pick) {
            // Remove current-pick class from all cells
            document.querySelectorAll('.draft-cell').forEach(cell => {
                cell.classList.remove('current-pick');
            });

            // Add current-pick class to selected cell
            const cell = getCellByRoundPick(round, pick);
            if (cell) {
                cell.classList.add('current-pick');
            }

            // Update dropdown value
            const currentPickSelect = document.getElementById('currentPickSelect');
            currentPickSelect.value = `${round}_${pick}`;
        }

        // Add click handlers
        document.addEventListener('DOMContentLoaded', function() {
            // Populate current pick dropdown
            const currentPickSelect = document.getElementById('currentPickSelect');
            const numRounds = {{ draft.rounds|default:"0" }};
            const numPicks = {{ draft.picks_per_round|default:"0" }};

            for (let round = 1; round <= numRounds; round++) {
                for (let pick = 1; pick <= numPicks; pick++) {
                    const overallPick = (round - 1) * numPicks + pick;
                    const option = document.createElement('option');
                    option.value = `${round}_${pick}`;
                    option.textContent = `Round ${round} - Pick ${overallPick}`;
                    currentPickSelect.appendChild(option);
                }
            }

            // Handle current pick selection change
            currentPickSelect.addEventListener('change', function() {
                if (this.value) {
                    const [round, pick] = this.value.split('_').map(Number);
                    setCurrentPick(round, pick);
                } else {
                    // Clear current pick highlight
                    document.querySelectorAll('.draft-cell').forEach(cell => {
                        cell.classList.remove('current-pick');
                    });
                }
            });

            // Auto-select first unpicked cell on load
            const firstUnpicked = findNextUnpickedCell();
            if (firstUnpicked) {
                setCurrentPick(firstUnpicked.round, firstUnpicked.pick);
            }

            // Update player counts on load
            updatePlayerCounts();

            // Click on + icon for new picks
            document.querySelectorAll('.add-icon').forEach(icon => {
                icon.addEventListener('click', function(e) {
                    const cell = e.target.closest('.draft-cell');
                    if (!cell.classList.contains('picked')) {
                        openPickModal(cell, false);
                    }
                });
            });

            // Click on player name for editing
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('team-name')) {
                    const cell = e.target.closest('.draft-cell');
                    if (cell && cell.classList.contains('picked')) {
                        openPickModal(cell, true);
                    }
                }
            });
        });

        // Load available players
        function loadAvailablePlayers(selectedPlayerId = null) {
            const playerSelect = $('#playerSelect');

            // Destroy existing Select2 instance if it exists
            if (playerSelect.hasClass("select2-hidden-accessible")) {
                playerSelect.select2('destroy');
            }

            playerSelect.html('<option value="">Loading players...</option>');
            document.getElementById('confirmPickBtn').disabled = true;

            const url = selectedPlayerId
                ? `/draft/available-players/?include_player=${selectedPlayerId}`
                : '/draft/available-players/';

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        playerSelect.html('<option value=""></option>');
                        data.players.forEach(player => {
                            const option = document.createElement('option');
                            option.value = player.id;
                            option.textContent = `${player.first_name} ${player.last_name}`;
                            option.dataset.conflict = player.conflict || '';
                            option.dataset.draftable = player.draftable;
                            option.dataset.hasSiblingRequirement = player.has_sibling_requirement || false;

                            // Pre-select if this is the current player in edit mode
                            if (selectedPlayerId && player.id == selectedPlayerId) {
                                option.selected = true;
                            }

                            playerSelect.append(option);
                        });

                        // Initialize Select2 with Bootstrap 5 theme
                        playerSelect.select2({
                            theme: 'bootstrap-5',
                            dropdownParent: $('#pickPlayerModal'),
                            width: '100%',
                            placeholder: 'Search by name...'
                        });

                        // If editing and player is selected, trigger change event
                        if (selectedPlayerId) {
                            playerSelect.trigger('change');
                        }
                    } else {
                        playerSelect.html('<option value="">Error loading players</option>');
                    }
                });
        }

        // Handle player selection (using jQuery for Select2 compatibility)
        $('#playerSelect').on('change', function(e) {
            const selectedOption = this.options[this.selectedIndex];
            const conflict = selectedOption ? selectedOption.dataset.conflict : '';
            const draftable = selectedOption ? selectedOption.dataset.draftable === 'true' : true;
            const hasSiblingRequirement = selectedOption ? selectedOption.dataset.hasSiblingRequirement === 'true' : false;
            const conflictInfo = document.getElementById('conflictInfo');
            const practiceSlotInfo = document.getElementById('practiceSlotInfo');
            const siblingInfo = document.getElementById('siblingInfo');
            const notDraftableWarning = document.getElementById('notDraftableWarning');
            const confirmBtn = document.getElementById('confirmPickBtn');

            if (this.value) {
                confirmBtn.disabled = false;

                // Always show conflict info when player is selected
                document.getElementById('conflictText').textContent = conflict || 'None';
                conflictInfo.style.display = 'block';

                // Show practice slot info
                practiceSlotInfo.style.display = 'block';

                // Show/hide sibling info
                if (hasSiblingRequirement) {
                    siblingInfo.style.display = 'block';
                } else {
                    siblingInfo.style.display = 'none';
                }

                // Show/hide not draftable warning
                if (!draftable) {
                    notDraftableWarning.style.display = 'block';
                } else {
                    notDraftableWarning.style.display = 'none';
                }
            } else {
                confirmBtn.disabled = true;
                conflictInfo.style.display = 'none';
                practiceSlotInfo.style.display = 'none';
                siblingInfo.style.display = 'none';
                notDraftableWarning.style.display = 'none';
            }
        });

        // Handle pick confirmation
        document.getElementById('confirmPickBtn').addEventListener('click', function() {
            const playerId = document.getElementById('playerSelect').value;
            const teamName = currentCell.dataset.teamName;

            if (!playerId) return;

            // Disable button during request
            this.disabled = true;
            this.textContent = 'Picking...';

            // Submit the pick
            fetch('/draft/make-pick/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    round: currentRound,
                    pick: currentPick,
                    player_id: playerId,
                    team_name: teamName
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update the cell with player name
                    const teamNameSpan = currentCell.querySelector('.team-name');
                    teamNameSpan.textContent = data.player_name;

                    // Mark cell as picked and store player ID
                    currentCell.classList.add('picked');
                    currentCell.dataset.playerId = playerId;
                    currentCell.dataset.playerName = data.player_name;

                    // Close modal
                    pickPlayerModal.hide();

                    // Reset button
                    this.disabled = false;
                    this.textContent = 'Pick Player';

                    // Update player counts
                    updatePlayerCounts();

                    // Update manager's daughters tracking if applicable
                    if (data.is_managers_daughter) {
                        updateManagersDaughters(data.player_id, 'drafted');
                    }

                    // Auto-progress to next unpicked cell
                    const nextUnpicked = findNextUnpickedCell();
                    if (nextUnpicked) {
                        setCurrentPick(nextUnpicked.round, nextUnpicked.pick);
                    } else {
                        // Draft is complete, clear current pick highlight
                        document.querySelectorAll('.draft-cell').forEach(cell => {
                            cell.classList.remove('current-pick');
                        });
                        document.getElementById('currentPickSelect').value = '';
                    }
                } else {
                    alert('Error: ' + data.error);
                    this.disabled = false;
                    this.textContent = 'Pick Player';
                }
            })
            .catch(error => {
                alert('Error making pick');
                this.disabled = false;
                this.textContent = 'Pick Player';
            });
        });

        // Handle undraft button
        document.getElementById('undraftPlayerBtn').addEventListener('click', function() {
            if (!confirm('Are you sure you want to undraft this player?')) {
                return;
            }

            const teamName = currentCell.dataset.teamName;

            // Disable button during request
            this.disabled = true;
            this.textContent = 'Undrafting...';

            // Submit the undraft request
            fetch('/draft/undraft-pick/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    round: currentRound,
                    pick: currentPick,
                    team_name: teamName
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Clear the cell
                    const teamNameSpan = currentCell.querySelector('.team-name');
                    teamNameSpan.textContent = teamName;

                    // Mark cell as unpicked and remove player data
                    currentCell.classList.remove('picked');
                    delete currentCell.dataset.playerId;
                    delete currentCell.dataset.playerName;

                    // Close modal
                    pickPlayerModal.hide();

                    // Reset button
                    this.disabled = false;
                    this.textContent = 'Undraft Player';

                    // Update player counts
                    updatePlayerCounts();

                    // Update manager's daughters tracking if applicable
                    if (data.is_managers_daughter && data.player_id) {
                        updateManagersDaughters(data.player_id, 'undrafted');
                    }
                } else {
                    alert('Error: ' + data.error);
                    this.disabled = false;
                    this.textContent = 'Undraft Player';
                }
            })
            .catch(error => {
                alert('Error undrafting player');
                this.disabled = false;
                this.textContent = 'Undraft Player';
            });
        });

        // Handle random pick button
        document.getElementById('randomPickBtn').addEventListener('click', function() {
            const playerSelect = document.getElementById('playerSelect');
            const options = Array.from(playerSelect.options).filter(opt => opt.value !== '');

            if (options.length === 0) {
                alert('No players available for random selection');
                return;
            }

            // Select a random player
            const randomIndex = Math.floor(Math.random() * options.length);
            const randomOption = options[randomIndex];

            // Set the value in the select
            playerSelect.value = randomOption.value;

            // Trigger the change event to update conflict info and enable the pick button
            $('#playerSelect').trigger('change');
        });

        // Handle opening assign players modal
        document.getElementById('openAssignPlayersBtn').addEventListener('click', function() {
            // Fetch validation data
            fetch('/draft/validate-assignment/')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // Get all required elements first
                        const undraftedWarning = document.getElementById('undraftedWarning');
                        const undraftedCount = document.getElementById('undraftedCount');
                        const undraftedVerb = document.getElementById('undraftedVerb');
                        const undraftedNoun = document.getElementById('undraftedNoun');
                        const preAssignedWarning = document.getElementById('preAssignedWarning');
                        const preAssignedCount = document.getElementById('preAssignedCount');
                        const alreadyAssignedWarning = document.getElementById('alreadyAssignedWarning');
                        const alreadyAssignedCount = document.getElementById('alreadyAssignedCount');
                        const confirmBtn = document.getElementById('confirmAssignPlayersBtn');

                        // Check if elements exist (they might have been removed after a previous assignment)
                        if (!undraftedWarning || !preAssignedWarning || !alreadyAssignedWarning) {
                            // Modal was previously used for assignment - reload page to reset modal state
                            alert('Please reload the page before opening the validation modal again.');
                            return;
                        }

                        // Handle warning 1: Undrafted players (does not block)
                        if (data.undrafted_count > 0) {
                            undraftedCount.textContent = data.undrafted_count;
                            undraftedVerb.textContent = data.undrafted_count === 1 ? 'is' : 'are';
                            undraftedNoun.textContent = data.undrafted_count === 1 ? 'player' : 'players';
                            undraftedWarning.style.display = 'block';
                        } else {
                            undraftedWarning.style.display = 'none';
                        }

                        // Handle warning 2: Pre-assigned players (BLOCKS action)
                        if (data.pre_assigned_count > 0) {
                            preAssignedCount.textContent = data.pre_assigned_count;
                            preAssignedWarning.style.display = 'block';
                            confirmBtn.disabled = true;
                        } else {
                            preAssignedWarning.style.display = 'none';
                        }

                        // Handle warning 3: Already assigned via draft (BLOCKS action)
                        if (data.already_assigned_count > 0) {
                            alreadyAssignedCount.textContent = data.already_assigned_count;
                            alreadyAssignedWarning.style.display = 'block';
                            confirmBtn.disabled = true;
                        } else {
                            alreadyAssignedWarning.style.display = 'none';
                        }

                        // Enable button only if no blocking warnings
                        if (data.pre_assigned_count === 0 && data.already_assigned_count === 0) {
                            confirmBtn.disabled = false;
                        }

                        // Show the modal
                        assignPlayersModal.show();
                    } else {
                        let errorMsg = 'Error loading validation data: ' + (data.error || 'Unknown error');
                        if (data.traceback) {
                            console.error('Server traceback:', data.traceback);
                        }
                        alert(errorMsg);
                    }
                })
                .catch(error => {
                    alert('Error loading validation data: ' + error.message);
                    console.error('Fetch error:', error);
                });
        });

        // Handle confirm assign players button (placeholder - no action yet)
        document.getElementById('confirmAssignPlayersBtn').addEventListener('click', function() {
            const btn = this;
            btn.disabled = true;
            btn.textContent = 'Assigning...';

            fetch('/draft/assign-players/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                btn.disabled = false;
                btn.textContent = 'Assign Players to Teams';

                if (data.success) {
                    // Build summary report
                    const summary = data.summary;
                    let reportHTML = '<div class="alert alert-success"><h5>Assignment Complete!</h5>';
                    reportHTML += `<p><strong>Newly Assigned:</strong> ${summary.newly_assigned} players</p>`;

                    if (summary.already_assigned > 0) {
                        reportHTML += `<p><strong>Already Assigned:</strong> ${summary.already_assigned} players (skipped)</p>`;
                    }

                    if (summary.incomplete_picks > 0) {
                        reportHTML += `<p class="text-warning"><strong>Incomplete Picks:</strong> ${summary.incomplete_picks} draft picks without player or team assignment</p>`;
                    }

                    if (summary.errors > 0) {
                        reportHTML += `<p class="text-danger"><strong>Errors:</strong> ${summary.errors} players could not be assigned</p>`;
                        reportHTML += '<ul>';
                        data.error_details.forEach(err => {
                            reportHTML += `<li>Round ${err.round}, Pick ${err.pick}: ${err.player} to ${err.team} - ${err.error}</li>`;
                        });
                        reportHTML += '</ul>';
                    }

                    reportHTML += '</div>';

                    // Replace modal body content with report
                    document.querySelector('#assignPlayersModal .modal-body').innerHTML = reportHTML;

                    // Change footer buttons
                    document.querySelector('#assignPlayersModal .modal-footer').innerHTML =
                        '<button type="button" class="btn btn-primary" data-bs-dismiss="modal" id="closeAssignModalBtn">Close</button>';

                    // Reload page when modal is closed to update button state
                    document.getElementById('closeAssignModalBtn').addEventListener('click', function() {
                        location.reload();
                    });
                } else {
                    alert('Error assigning players: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                btn.disabled = false;
                btn.textContent = 'Assign Players to Teams';
                alert('Network error: ' + error.message);
            });
        });

        // Handle simulate draft button click
        document.getElementById('simulateDraftBtn').addEventListener('click', function() {
            const errorDiv = document.getElementById('simulateDraftError');
            const errorText = document.getElementById('simulateDraftErrorText');
            const confirmBtn = document.getElementById('confirmSimulateDraftBtn');

            // Check if draft picks exist
            const filledCells = document.querySelectorAll('.draft-cell.picked').length;

            if (filledCells > 0) {
                // Show warning that picks already exist
                errorText.textContent = 'Draft picks already exist. Please reset the draft before simulating.';
                errorDiv.style.display = 'block';
                confirmBtn.disabled = true;
            } else {
                // Hide warning and enable button
                errorDiv.style.display = 'none';
                confirmBtn.disabled = false;
            }

            simulateDraftModal.show();
        });

        // Handle confirm simulate draft button
        document.getElementById('confirmSimulateDraftBtn').addEventListener('click', function() {
            const btn = this;
            const errorDiv = document.getElementById('simulateDraftError');
            const errorText = document.getElementById('simulateDraftErrorText');

            // Hide any previous errors
            errorDiv.style.display = 'none';

            btn.disabled = true;
            btn.textContent = 'Simulating...';

            fetch('/draft/simulate/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Close modal and reload the page to show simulated draft
                    simulateDraftModal.hide();
                    window.location.reload();
                } else {
                    // Show error in modal
                    errorText.textContent = data.error || 'Unknown error';
                    errorDiv.style.display = 'block';
                    btn.disabled = false;
                    btn.textContent = 'Simulate Draft';
                }
            })
            .catch(error => {
                errorText.textContent = 'An unexpected error occurred. Please try again.';
                errorDiv.style.display = 'block';
                console.error('Error:', error);
                btn.disabled = false;
                btn.textContent = 'Simulate Draft';
            });
        });

        // Handle reset draft button click
        document.getElementById('resetDraftBtn').addEventListener('click', function() {
            resetDraftModal.show();
        });

        // Handle confirm reset draft button
        document.getElementById('confirmResetDraftBtn').addEventListener('click', function() {
            const btn = this;
            btn.disabled = true;
            btn.textContent = 'Resetting...';

            fetch('/draft/reset/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Reload the page to show empty draft board
                    window.location.reload();
                } else {
                    alert('Error resetting draft: ' + (data.error || 'Unknown error'));
                    btn.disabled = false;
                    btn.textContent = 'Proceed';
                }
            })
            .catch(error => {
                alert('Error resetting draft');
                console.error('Error:', error);
                btn.disabled = false;
                btn.textContent = 'Proceed';
            });
        });

        // Helper function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Initialize tooltips for Manager's Daughters Rankings modal
        document.addEventListener('DOMContentLoaded', function() {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        });
    </script>

    <!-- Configure Draft Order Modal -->
    <div class="modal fade" id="configureDraftOrderModal" tabindex="-1" aria-labelledby="configureDraftOrderModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="configureDraftOrderModalLabel">Configure Draft Order & Manager's Daughter Placements</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Loading indicator -->
                    <div id="draftOrderLoading" class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Checking draft status...</p>
                    </div>

                    <!-- Error message (if draft picks exist) -->
                    <div id="draftOrderError" class="alert alert-danger" style="display: none;">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>This feature cannot be used because some draft picks have already been made.</strong>
                        <p class="mb-0 mt-2">Please reset the draft before configuring the draft order.</p>
                    </div>

                    <!-- Main content (shown when no picks exist) -->
                    <div id="draftOrderContent" style="display: none;">
                        <div class="mb-4">
                            <p>The draft pick assigned to any given team is based on their Draft Priority Score. How this score is calculated depends on which classification a team falls under:</p>

                            <p><strong>Classification #1: The team has an "elite" manager's daughter</strong></p>
                            <ul>
                                <li>"Elite" = one of the top <span id="topPlayerCount">__</span> players based on the collective manager rankings of all players</li>
                                <li>Team's Priority Score = (Daughter's Overall Player Borda Score) - (Daughter's Borda Score Among Manager's Daughters × 0.5)</li>
                                <li>Higher scores = Later (lower) draft picks</li>
                            </ul>

                            <p><strong>Classification #2: The team does not have an "elite" manager's daughter</strong></p>
                            <ul>
                                <li>Priority Score = -(Daughter's Borda Score Among All Daughters)</li>
                                <li>More negative scores = earlier (better) picks. In other words: worse daughter ranking = earlier pick in the draft</li>
                            </ul>

                            <p>Teams are sorted by priority score: <strong>lowest scores pick first, highest scores pick last</strong>.</p>

                            <p>In addition to the above, each manager's daughter is automatically assigned to a specific round based on the <strong>median</strong> of all managers' suggested draft rounds for that player. A manager must use their designated pick in that round to draft their daughter. Pick number within that round is determined by the team's draft order position (accounting for snake draft: odd rounds follow draft order, even rounds reverse it).</p>

                            <p><strong>Overall goal:</strong> Teams with daughters ranked lower relative to the overall player pool get earlier draft positions to build competitive rosters, while teams with elite daughters pick later since they already have strong players.</p>

                            <p class="mt-3">Click the "Proceed" button below to (1) set the draft's order, and (2) assign each manager's daughter to a specific round and pick. Note that, once these are set, you can still modify them as needed on the draft board.</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-success" id="setDraftOrderBtn" style="display: none;">
                        <i class="bi bi-check-circle me-2"></i>Proceed
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reorder Teams Modal -->
    <div class="modal fade" id="reorderTeamsModal" tabindex="-1" aria-labelledby="reorderTeamsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="reorderTeamsModalLabel">Reorder Draft Teams</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted mb-3">Drag and drop teams to reorder the draft. Snake draft logic will be maintained, and existing picks will stay locked in place.</p>

                    <!-- Loading indicator -->
                    <div id="reorderLoading" class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading draft order...</p>
                    </div>

                    <!-- Error message -->
                    <div id="reorderError" class="alert alert-danger" style="display: none;">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <span id="reorderErrorMessage"></span>
                    </div>

                    <!-- Draggable team list -->
                    <div id="reorderContent" style="display: none;">
                        <ul id="teamOrderList" class="list-group">
                            <!-- Teams will be populated here by JavaScript -->
                        </ul>
                        <div class="mt-3 text-muted small">
                            <i class="bi bi-info-circle me-1"></i>
                            Tip: Drag teams up or down to change their draft position. The draft board will update automatically when you save.
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="saveReorderBtn" style="display: none;">
                        <i class="bi bi-check-circle me-2"></i>Save New Order
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Include SortableJS from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <script>
        // Configure Draft Order Modal Logic
        const configureDraftOrderModal = document.getElementById('configureDraftOrderModal');

        configureDraftOrderModal.addEventListener('show.bs.modal', function (event) {
            // Show loading, hide content/error
            document.getElementById('draftOrderLoading').style.display = 'block';
            document.getElementById('draftOrderError').style.display = 'none';
            document.getElementById('draftOrderContent').style.display = 'none';
            document.getElementById('setDraftOrderBtn').style.display = 'none';

            // Check if any draft picks exist
            fetch('/api/check-draft-picks/')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    document.getElementById('draftOrderLoading').style.display = 'none';

                    if (data.error) {
                        // Show error from server
                        document.getElementById('draftOrderError').innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>' + data.error;
                        document.getElementById('draftOrderError').style.display = 'block';
                    } else if (data.picks_exist) {
                        // Show error message
                        document.getElementById('draftOrderError').style.display = 'block';
                    } else {
                        // Show content and button
                        document.getElementById('draftOrderContent').style.display = 'block';
                        document.getElementById('setDraftOrderBtn').style.display = 'inline-block';

                        // Update dynamic values
                        document.getElementById('topPlayerCount').textContent = data.top_player_count;
                    }
                })
                .catch(error => {
                    console.error('Error checking draft picks:', error);
                    document.getElementById('draftOrderLoading').style.display = 'none';
                    document.getElementById('draftOrderError').innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>An error occurred while checking draft status: ' + error.message;
                    document.getElementById('draftOrderError').style.display = 'block';
                });
        });

        // Handle Set Draft Order button click
        document.getElementById('setDraftOrderBtn').addEventListener('click', function() {
            const btn = this;
            const originalHtml = btn.innerHTML;

            // Disable button and show loading
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';

            fetch('/api/set-draft-order-and-daughters/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Close modal
                    bootstrap.Modal.getInstance(configureDraftOrderModal).hide();

                    // Reload the page to show updated draft board
                    location.reload();
                } else {
                    alert('Error: ' + (data.error || 'Failed to set draft order'));
                    btn.disabled = false;
                    btn.innerHTML = originalHtml;
                }
            })
            .catch(error => {
                console.error('Error setting draft order:', error);
                alert('An unexpected error occurred');
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            });
        });

        // Reorder Teams Modal Logic
        const reorderTeamsModal = document.getElementById('reorderTeamsModal');
        let sortableInstance = null;

        reorderTeamsModal.addEventListener('show.bs.modal', function (event) {
            // Show loading, hide content/error
            document.getElementById('reorderLoading').style.display = 'block';
            document.getElementById('reorderError').style.display = 'none';
            document.getElementById('reorderContent').style.display = 'none';
            document.getElementById('saveReorderBtn').style.display = 'none';

            // Fetch current draft order
            fetch('/draft/get-draft-order/')
                .then(response => {
                    if (!response.ok) {
                        // Return the response JSON even if not OK so we can get error details
                        return response.json().then(data => {
                            throw {status: response.status, data: data};
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    document.getElementById('reorderLoading').style.display = 'none';

                    if (data.error) {
                        // Show error from server
                        let errorMsg = data.error;
                        if (data.traceback) {
                            errorMsg += '\n\nTechnical details:\n' + data.traceback;
                        }
                        document.getElementById('reorderErrorMessage').textContent = errorMsg;
                        document.getElementById('reorderError').style.display = 'block';
                    } else {
                        // Populate the team list
                        const teamOrderList = document.getElementById('teamOrderList');
                        teamOrderList.innerHTML = '';

                        data.teams.forEach((team, index) => {
                            const li = document.createElement('li');
                            li.className = 'list-group-item d-flex justify-content-between align-items-center';
                            li.setAttribute('data-team-id', team.id);
                            li.style.cursor = 'move';
                            li.innerHTML = `
                                <div>
                                    <i class="bi bi-grip-vertical text-muted me-2"></i>
                                    <strong>${index + 1}.</strong> ${team.name}
                                </div>
                                <span class="badge bg-secondary">${team.manager_name || 'No manager'}</span>
                            `;
                            teamOrderList.appendChild(li);
                        });

                        // Initialize SortableJS
                        if (sortableInstance) {
                            sortableInstance.destroy();
                        }
                        sortableInstance = new Sortable(teamOrderList, {
                            animation: 150,
                            handle: 'li',
                            ghostClass: 'bg-light',
                            onEnd: function(evt) {
                                // Update the position numbers
                                const items = teamOrderList.querySelectorAll('li');
                                items.forEach((item, index) => {
                                    const strongTag = item.querySelector('strong');
                                    strongTag.textContent = `${index + 1}.`;
                                });
                            }
                        });

                        // Show content and save button
                        document.getElementById('reorderContent').style.display = 'block';
                        document.getElementById('saveReorderBtn').style.display = 'inline-block';
                    }
                })
                .catch(error => {
                    console.error('Error loading draft order:', error);
                    document.getElementById('reorderLoading').style.display = 'none';

                    // Check if we have detailed error info from the server
                    let errorMsg;
                    if (error.data && error.data.error) {
                        errorMsg = error.data.error;
                        if (error.data.traceback) {
                            errorMsg += '\n\nTechnical details:\n' + error.data.traceback;
                        }
                    } else if (error.message) {
                        errorMsg = 'An error occurred while loading draft order: ' + error.message;
                    } else {
                        errorMsg = 'An unexpected error occurred while loading draft order';
                    }

                    document.getElementById('reorderErrorMessage').textContent = errorMsg;
                    document.getElementById('reorderError').style.display = 'block';
                });
        });

        // Handle Save New Order button click
        document.getElementById('saveReorderBtn').addEventListener('click', function() {
            const btn = this;
            const originalHtml = btn.innerHTML;

            // Disable button and show loading
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';

            // Get the new order of team IDs
            const teamOrderList = document.getElementById('teamOrderList');
            const teamIds = Array.from(teamOrderList.querySelectorAll('li')).map(li => li.getAttribute('data-team-id'));

            fetch('/draft/save-draft-order/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    team_order: teamIds
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Close modal
                    bootstrap.Modal.getInstance(reorderTeamsModal).hide();

                    // Reload the page to show updated draft board
                    location.reload();
                } else {
                    alert('Error: ' + (data.error || 'Failed to save draft order'));
                    btn.disabled = false;
                    btn.innerHTML = originalHtml;
                }
            })
            .catch(error => {
                console.error('Error saving draft order:', error);
                alert('An unexpected error occurred');
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            });
        });
    </script>
{% endblock %}
