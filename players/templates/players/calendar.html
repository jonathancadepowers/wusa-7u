{% extends "base.html" %}
{% load static %}

{% block title %}Calendar - WUSA 7U{% endblock %}

{% block page_title %}WUSA 7U - Calendar{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- FullCalendar Container -->
    <div id="calendar"></div>
</div>

<!-- Create Event Modal -->
<div class="modal fade" id="createEventModal" tabindex="-1" aria-labelledby="createEventModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createEventModalLabel">Create New Event</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger d-none" id="createEventError"></div>
                <form id="createEventForm">
                    <div class="mb-3">
                        <label for="eventName" class="form-label">Event Name *</label>
                        <input type="text" class="form-control" id="eventName" required>
                    </div>
                    <div class="mb-3">
                        <label for="eventType" class="form-label">Event Type *</label>
                        <select class="form-control" id="eventType" required>
                            <option value="">Select event type...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="eventLocation" class="form-label">Location</label>
                        <input type="text" class="form-control" id="eventLocation">
                    </div>
                    <div class="mb-3">
                        <label for="eventStartDate" class="form-label">Start Date *</label>
                        <input type="date" class="form-control" id="eventStartDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="eventStartTime" class="form-label">Start Time</label>
                        <input type="time" class="form-control" id="eventStartTime">
                    </div>
                    <div class="mb-3">
                        <label for="eventEndDate" class="form-label">End Date (for multi-day events)</label>
                        <input type="date" class="form-control" id="eventEndDate">
                    </div>
                    <div class="mb-3">
                        <label for="eventDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="eventDescription" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="createEventBtn">Create Event</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Event Modal -->
<div class="modal fade" id="editEventModal" tabindex="-1" aria-labelledby="editEventModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editEventModalLabel">Edit Event</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger d-none" id="editEventError"></div>
                <form id="editEventForm">
                    <input type="hidden" id="editEventId">
                    <div class="mb-3">
                        <label for="editEventName" class="form-label">Event Name *</label>
                        <input type="text" class="form-control" id="editEventName" required>
                    </div>
                    <div class="mb-3">
                        <label for="editEventType" class="form-label">Event Type *</label>
                        <select class="form-control" id="editEventType" required>
                            <option value="">Select event type...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editEventLocation" class="form-label">Location</label>
                        <input type="text" class="form-control" id="editEventLocation">
                    </div>
                    <div class="mb-3">
                        <label for="editEventStartDate" class="form-label">Start Date *</label>
                        <input type="date" class="form-control" id="editEventStartDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="editEventStartTime" class="form-label">Start Time</label>
                        <input type="time" class="form-control" id="editEventStartTime">
                    </div>
                    <div class="mb-3">
                        <label for="editEventEndDate" class="form-label">End Date (for multi-day events)</label>
                        <input type="date" class="form-control" id="editEventEndDate">
                    </div>
                    <div class="mb-3">
                        <label for="editEventDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="editEventDescription" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" id="deleteEventBtn">Delete</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="updateEventBtn">Update Event</button>
            </div>
        </div>
    </div>
</div>

<!-- Manage Event Types Modal (keeping existing functionality) -->
<div class="modal fade" id="modifyEventTypesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Manage Event Types</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <button type="button" class="btn btn-success btn-sm" id="createNewEventTypeBtn">
                        <i class="bi bi-plus-circle"></i> Create New Event Type
                    </button>
                </div>
                <div id="eventTypesList"></div>
            </div>
        </div>
    </div>
</div>

<style>
#calendar {
    max-width: 1200px;
    margin: 0 auto;
}

/* Remove underlines from day headers and day numbers */
.fc .fc-col-header-cell-cushion,
.fc .fc-daygrid-day-number {
    text-decoration: none !important;
}

/* Remove underline on hover too */
.fc .fc-col-header-cell-cushion:hover,
.fc .fc-daygrid-day-number:hover {
    text-decoration: none !important;
}

/* Add left padding to event content and truncate with ellipsis */
.fc-event-main {
    padding-left: 4px !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
    white-space: nowrap !important;
}

.fc .fc-daygrid-event {
    padding-left: 4px !important;
    overflow: hidden !important;
}

.fc .fc-daygrid-event-harness {
    padding-left: 4px !important;
}

/* Ensure event title content doesn't overflow */
.fc .fc-event-title,
.fc .fc-daygrid-event-dot {
    overflow: hidden !important;
    text-overflow: ellipsis !important;
    white-space: nowrap !important;
}

/* Make all calendar buttons the same color - override ALL FullCalendar defaults */
.fc-button-group > .fc-button,
.fc-toolbar-chunk > .fc-button,
.fc .fc-button-primary,
.fc .fc-button,
.fc .fc-today-button,
button.fc-today-button.fc-button.fc-button-primary {
    background-color: #2c3e50 !important;
    border-color: #2c3e50 !important;
    border-radius: 4px !important;
    color: white !important;
}

.fc-button-group > .fc-button:hover,
.fc-toolbar-chunk > .fc-button:hover,
.fc .fc-button-primary:hover,
.fc .fc-button:hover,
.fc .fc-today-button:hover,
button.fc-today-button.fc-button.fc-button-primary:hover {
    background-color: #34495e !important;
    border-color: #34495e !important;
}

.fc-button-group > .fc-button:not(:disabled).fc-button-active,
.fc-button-group > .fc-button:not(:disabled):active,
.fc-button-group > .fc-button.fc-button-active,
.fc-toolbar-chunk > .fc-button:not(:disabled).fc-button-active,
.fc-toolbar-chunk > .fc-button:not(:disabled):active,
.fc-toolbar-chunk > .fc-button.fc-button-active,
.fc .fc-button-primary:not(:disabled).fc-button-active,
.fc .fc-button-primary:not(:disabled):active,
.fc .fc-button-primary.fc-button-active,
.fc .fc-button:not(:disabled).fc-button-active,
.fc .fc-button:not(:disabled):active,
.fc .fc-button.fc-button-active,
.fc .fc-today-button:not(:disabled).fc-button-active,
.fc .fc-today-button:not(:disabled):active,
.fc .fc-today-button.fc-button-active,
button.fc-today-button.fc-button.fc-button-primary:not(:disabled).fc-button-active,
button.fc-today-button.fc-button.fc-button-primary:not(:disabled):active,
button.fc-today-button.fc-button.fc-button-primary.fc-button-active,
.fc .fc-button-active {
    background-color: #1a252f !important;
    border-color: #1a252f !important;
    box-shadow: none !important;
    color: white !important;
}

/* Add spacing between custom buttons */
.fc .fc-createEvent-button {
    margin-right: 10px !important;
}

/* Hide admin buttons when not authenticated */
.hide-admin-buttons .fc-createEvent-button,
.hide-admin-buttons .fc-manageEventTypes-button {
    display: none !important;
}
</style>

<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Check for master password
    const masterPasswordCookie = document.cookie.split('; ').find(row => row.startsWith('master_password='));
    console.log('Master password cookie:', masterPasswordCookie);

    // Function to load event types into dropdowns
    async function loadEventTypeOptions() {
        try {
            const response = await fetch('{% url "players:get_event_types" %}');
            const result = await response.json();

            if (result.success) {
                const eventTypes = result.event_types;

                // Update create event modal dropdown
                const createSelect = document.getElementById('eventType');
                const createCurrentValue = createSelect.value;
                createSelect.innerHTML = '<option value="">Select event type...</option>';
                eventTypes.forEach(et => {
                    const option = document.createElement('option');
                    option.value = et.id;
                    option.textContent = et.name;
                    createSelect.appendChild(option);
                });
                if (createCurrentValue) createSelect.value = createCurrentValue;

                // Update edit event modal dropdown
                const editSelect = document.getElementById('editEventType');
                const editCurrentValue = editSelect.value;
                editSelect.innerHTML = '<option value="">Select event type...</option>';
                eventTypes.forEach(et => {
                    const option = document.createElement('option');
                    option.value = et.id;
                    option.textContent = et.name;
                    editSelect.appendChild(option);
                });
                if (editCurrentValue) editSelect.value = editCurrentValue;
            }
        } catch (error) {
            console.error('Error loading event types:', error);
        }
    }

    // Load event types on page load
    loadEventTypeOptions();

    // Reload event types when create modal opens
    const createEventModal = document.getElementById('createEventModal');
    createEventModal.addEventListener('show.bs.modal', function() {
        loadEventTypeOptions();
    });

    // Reload event types when edit modal opens
    const editEventModal = document.getElementById('editEventModal');
    editEventModal.addEventListener('show.bs.modal', function() {
        loadEventTypeOptions();
    });

    // Initialize FullCalendar
    const calendarEl = document.getElementById('calendar');
    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'createEvent,manageEventTypes dayGridMonth,timeGridWeek,timeGridDay'
        },
        customButtons: {
            createEvent: {
                text: 'Create Event',
                click: function() {
                    const modal = new bootstrap.Modal(document.getElementById('createEventModal'));
                    modal.show();
                }
            },
            manageEventTypes: {
                text: 'Manage Event Types',
                click: function() {
                    const modal = new bootstrap.Modal(document.getElementById('modifyEventTypesModal'));
                    modal.show();
                }
            }
        },
        buttonText: {
            today: 'Today',
            month: 'Month',
            week: 'Week',
            day: 'Day'
        },
        editable: masterPasswordCookie ? true : false,
        selectable: masterPasswordCookie ? true : false,
        selectMirror: true,
        dayMaxEvents: true,
        events: '{% url "players:calendar_events_api" %}',

        // Custom event content to display icons and times
        // Pattern: <Icon> <Time> <Event Name>
        eventContent: function(arg) {
            let arrayOfDomNodes = [];

            // 1. Create icon element if icon exists
            if (arg.event.extendedProps.icon) {
                let iconEl = document.createElement('i');
                iconEl.className = 'bi bi-' + arg.event.extendedProps.icon + ' me-1';
                arrayOfDomNodes.push(iconEl);
            }

            // 2. Add time if event has specific start time (not all-day)
            // Format: 7pm (lowercase, no space, no minutes if :00)
            if (arg.event.start && !arg.event.allDay) {
                let timeEl = document.createElement('span');
                timeEl.className = 'me-1';
                let hours = arg.event.start.getHours();
                let minutes = arg.event.start.getMinutes();
                let ampm = hours >= 12 ? 'pm' : 'am';
                hours = hours % 12;
                hours = hours ? hours : 12; // 0 should be 12

                // Only show minutes if not :00
                let timeStr = minutes === 0 ? hours + ampm : hours + ':' + (minutes < 10 ? '0' + minutes : minutes) + ampm;
                timeEl.innerHTML = timeStr;
                arrayOfDomNodes.push(timeEl);
            }

            // 3. Create title element
            let titleEl = document.createElement('span');
            titleEl.innerHTML = arg.event.title;
            arrayOfDomNodes.push(titleEl);

            return { domNodes: arrayOfDomNodes };
        },

        // Show tooltip on mouse enter
        eventMouseEnter: function(info) {
            const event = info.event;
            let tooltipContent = `<strong>${event.title}</strong>`;

            // Add start time
            if (event.start) {
                const startTime = event.start.toLocaleString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                });
                tooltipContent += `<br><i class="bi bi-clock me-1"></i>${startTime}`;
            }

            // Add end date if different from start
            if (event.end && event.end.toDateString() !== event.start.toDateString()) {
                const endTime = event.end.toLocaleString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });
                tooltipContent += `<br><i class="bi bi-calendar-check me-1"></i>Ends: ${endTime}`;
            }

            // Add location if exists
            if (event.extendedProps.location) {
                tooltipContent += `<br><i class="bi bi-geo-alt me-1"></i>${event.extendedProps.location}`;
            }

            // Add description if exists
            if (event.extendedProps.description) {
                tooltipContent += `<br><i class="bi bi-info-circle me-1"></i>${event.extendedProps.description}`;
            }

            // Create tooltip element
            const tooltip = document.createElement('div');
            tooltip.className = 'event-tooltip';
            tooltip.innerHTML = tooltipContent;
            tooltip.style.position = 'absolute';
            tooltip.style.zIndex = '10000';
            tooltip.style.backgroundColor = 'rgba(0, 0, 0, 0.9)';
            tooltip.style.color = 'white';
            tooltip.style.padding = '10px';
            tooltip.style.borderRadius = '6px';
            tooltip.style.fontSize = '13px';
            tooltip.style.lineHeight = '1.6';
            tooltip.style.maxWidth = '300px';
            tooltip.style.boxShadow = '0 4px 12px rgba(0,0,0,0.3)';
            tooltip.style.pointerEvents = 'none';

            // Position tooltip near the event
            const rect = info.el.getBoundingClientRect();
            tooltip.style.left = (rect.left + window.scrollX) + 'px';
            tooltip.style.top = (rect.bottom + window.scrollY + 5) + 'px';

            // Store tooltip on element for removal
            info.el.tooltip = tooltip;
            document.body.appendChild(tooltip);
        },

        // Remove tooltip on mouse leave
        eventMouseLeave: function(info) {
            if (info.el.tooltip) {
                info.el.tooltip.remove();
                info.el.tooltip = null;
            }
        },

        // When user clicks on a date (creates new event)
        select: function(info) {
            console.log('Select event triggered:', info);
            const modal = new bootstrap.Modal(document.getElementById('createEventModal'));
            modal.show();
            document.getElementById('eventStartDate').value = info.startStr;
            if (info.endStr && info.endStr !== info.startStr) {
                // Multi-day selection
                const endDate = new Date(info.endStr);
                endDate.setDate(endDate.getDate() - 1); // FullCalendar end is exclusive
                document.getElementById('eventEndDate').value = endDate.toISOString().split('T')[0];
            }
        },

        // When user clicks on an existing event
        eventClick: function(info) {
            console.log('Event clicked:', info.event.id, 'Has master password:', !!masterPasswordCookie);
            if (masterPasswordCookie) {
                loadEventForEdit(info.event.id);
            }
        },

        // When user starts dragging an event
        eventDragStart: function(info) {
            // Remove any existing tooltips
            if (info.el.tooltip) {
                info.el.tooltip.remove();
                info.el.tooltip = null;
            }
        },

        // When user drags an event to a new date/time
        eventDrop: function(info) {
            console.log('Event dropped:', info.event.id);
            updateEventDateTime(info.event);
        },

        // When user starts resizing an event
        eventResizeStart: function(info) {
            // Remove any existing tooltips
            if (info.el.tooltip) {
                info.el.tooltip.remove();
                info.el.tooltip = null;
            }
        },

        // When user resizes an event
        eventResize: function(info) {
            console.log('Event resized:', info.event.id);
            updateEventDateTime(info.event);
        }
    });

    calendar.render();

    // Hide admin buttons if no master password
    if (!masterPasswordCookie) {
        calendarEl.classList.add('hide-admin-buttons');
    }

    // Force Today button to use the same active color as other buttons
    // This needs to happen after render and on any view change
    function forceButtonColors() {
        const todayButton = document.querySelector('.fc-today-button');
        if (todayButton && todayButton.classList.contains('fc-button-active')) {
            todayButton.style.backgroundColor = '#1a252f';
            todayButton.style.borderColor = '#1a252f';
        }
    }

    // Apply immediately after render
    setTimeout(forceButtonColors, 100);

    // Reapply when calendar changes views
    const observer = new MutationObserver(forceButtonColors);
    observer.observe(calendarEl, { childList: true, subtree: true, attributes: true });

    // Create Event
    document.getElementById('createEventBtn').addEventListener('click', async function() {
        const name = document.getElementById('eventName').value;
        const eventType = document.getElementById('eventType').value;
        const location = document.getElementById('eventLocation').value;
        const startDate = document.getElementById('eventStartDate').value;
        const startTime = document.getElementById('eventStartTime').value;
        const endDate = document.getElementById('eventEndDate').value;
        const description = document.getElementById('eventDescription').value;

        if (!name || !eventType || !startDate) {
            alert('Please fill in all required fields');
            return;
        }

        const formData = new FormData();
        formData.append('name', name);
        formData.append('event_type_id', eventType);
        formData.append('location', location);
        formData.append('timestamp', startDate + (startTime ? 'T' + startTime : 'T00:00'));
        if (endDate) formData.append('end_date', endDate);
        formData.append('description', description);

        try {
            const response = await fetch('{% url "players:create_event" %}', {
                method: 'POST',
                headers: {'X-CSRFToken': getCookie('csrftoken')},
                body: formData
            });

            const result = await response.json();
            if (result.success) {
                const modal = bootstrap.Modal.getInstance(document.getElementById('createEventModal'));
                modal.hide();
                calendar.refetchEvents();
                document.getElementById('createEventForm').reset();
            } else {
                document.getElementById('createEventError').textContent = result.error;
                document.getElementById('createEventError').classList.remove('d-none');
            }
        } catch (error) {
            alert('Error creating event: ' + error.message);
        }
    });

    // Load event for editing
    async function loadEventForEdit(eventId) {
        try {
            console.log('Loading event for edit:', eventId);
            const response = await fetch(`{% url "players:get_event" %}?id=${eventId}`);
            const result = await response.json();
            console.log('Get event result:', result);

            if (result.success) {
                const event = result.event;
                document.getElementById('editEventId').value = event.id;
                document.getElementById('editEventName').value = event.name;
                document.getElementById('editEventType').value = event.event_type_id || '';
                document.getElementById('editEventLocation').value = event.location || '';

                const timestamp = new Date(event.timestamp);
                document.getElementById('editEventStartDate').value = timestamp.toISOString().split('T')[0];
                const timeStr = timestamp.toISOString().split('T')[1].substring(0, 5);
                if (timeStr !== '00:00') {
                    document.getElementById('editEventStartTime').value = timeStr;
                }

                document.getElementById('editEventEndDate').value = event.end_date || '';
                document.getElementById('editEventDescription').value = event.description || '';

                const modal = new bootstrap.Modal(document.getElementById('editEventModal'));
                modal.show();
            }
        } catch (error) {
            alert('Error loading event: ' + error.message);
        }
    }

    // Update Event
    document.getElementById('updateEventBtn').addEventListener('click', async function() {
        const eventId = document.getElementById('editEventId').value;
        const name = document.getElementById('editEventName').value;
        const eventType = document.getElementById('editEventType').value;
        const location = document.getElementById('editEventLocation').value;
        const startDate = document.getElementById('editEventStartDate').value;
        const startTime = document.getElementById('editEventStartTime').value;
        const endDate = document.getElementById('editEventEndDate').value;
        const description = document.getElementById('editEventDescription').value;

        const formData = new FormData();
        formData.append('event_id', eventId);
        formData.append('name', name);
        formData.append('event_type_id', eventType);
        formData.append('location', location);
        formData.append('timestamp', startDate + (startTime ? 'T' + startTime : 'T00:00'));
        if (endDate) formData.append('end_date', endDate);
        formData.append('description', description);

        try {
            const response = await fetch('{% url "players:update_event" %}', {
                method: 'POST',
                headers: {'X-CSRFToken': getCookie('csrftoken')},
                body: formData
            });

            const result = await response.json();
            if (result.success) {
                const modal = bootstrap.Modal.getInstance(document.getElementById('editEventModal'));
                modal.hide();
                calendar.refetchEvents();
            } else {
                document.getElementById('editEventError').textContent = result.error;
                document.getElementById('editEventError').classList.remove('d-none');
            }
        } catch (error) {
            alert('Error updating event: ' + error.message);
        }
    });

    // Delete Event
    document.getElementById('deleteEventBtn').addEventListener('click', async function() {
        if (!confirm('Are you sure you want to delete this event?')) return;

        const eventId = document.getElementById('editEventId').value;
        const formData = new FormData();
        formData.append('event_id', eventId);

        try {
            const response = await fetch('{% url "players:delete_event" %}', {
                method: 'POST',
                headers: {'X-CSRFToken': getCookie('csrftoken')},
                body: formData
            });

            const result = await response.json();
            if (result.success) {
                const modal = bootstrap.Modal.getInstance(document.getElementById('editEventModal'));
                modal.hide();
                calendar.refetchEvents();
            } else {
                alert('Error deleting event: ' + result.error);
            }
        } catch (error) {
            alert('Error deleting event: ' + error.message);
        }
    });

    // Update event date/time after drag or resize
    async function updateEventDateTime(event) {
        const formData = new FormData();
        formData.append('event_id', event.id);
        formData.append('timestamp', event.start.toISOString());
        if (event.end) {
            const endDate = new Date(event.end);
            endDate.setDate(endDate.getDate() - 1); // FullCalendar end is exclusive
            formData.append('end_date', endDate.toISOString().split('T')[0]);
        }

        try {
            const response = await fetch('{% url "players:move_event_date" %}', {
                method: 'POST',
                headers: {'X-CSRFToken': getCookie('csrftoken')},
                body: formData
            });

            const result = await response.json();
            if (!result.success) {
                alert('Error moving event: ' + result.error);
                calendar.refetchEvents(); // Revert
            }
        } catch (error) {
            alert('Error moving event: ' + error.message);
            calendar.refetchEvents(); // Revert
        }
    }

    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Event Types Management
    const modifyEventTypesModal = document.getElementById('modifyEventTypesModal');

    // Load event types when modal is opened
    modifyEventTypesModal.addEventListener('show.bs.modal', function() {
        loadEventTypes();
    });

    // Load and display event types
    async function loadEventTypes() {
        try {
            const response = await fetch('{% url "players:get_event_types" %}');
            const result = await response.json();

            if (result.success) {
                displayEventTypes(result.event_types);
            }
        } catch (error) {
            console.error('Error loading event types:', error);
        }
    }

    // Display event types in the list
    function displayEventTypes(eventTypes) {
        const listContainer = document.getElementById('eventTypesList');
        listContainer.innerHTML = '';

        if (eventTypes.length === 0) {
            return;
        }

        eventTypes.forEach(eventType => {
            const card = document.createElement('div');
            card.className = 'card mb-2';
            card.innerHTML = `
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="d-flex align-items-center">
                                ${eventType.bootstrap_icon_id ? `<i class="bi bi-${eventType.bootstrap_icon_id} me-2" style="font-size: 1.5rem; color: ${eventType.color}"></i>` : ''}
                                <div>
                                    <h6 class="mb-0">${eventType.name}</h6>
                                    <small class="text-muted">
                                        Color: <span class="badge" style="background-color: ${eventType.color}">&nbsp;&nbsp;&nbsp;</span> ${eventType.color}
                                        ${eventType.bootstrap_icon_id ? `| Icon: ${eventType.bootstrap_icon_id}` : ''}
                                    </small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-sm btn-primary me-2" onclick="editEventType(${eventType.id})">
                                <i class="bi bi-pencil"></i> Edit
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteEventType(${eventType.id}, '${eventType.name}')">
                                <i class="bi bi-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
            `;
            listContainer.appendChild(card);
        });
    }

    // Create New Event Type button
    document.getElementById('createNewEventTypeBtn').addEventListener('click', function() {
        showEventTypeForm();
    });

    // Show event type form for creating/editing
    function showEventTypeForm(eventType = null) {
        const listContainer = document.getElementById('eventTypesList');

        const formHtml = `
            <div class="card border-primary" id="eventTypeFormCard">
                <div class="card-header bg-primary text-white">
                    ${eventType ? 'Edit Event Type' : 'Create New Event Type'}
                </div>
                <div class="card-body">
                    <form id="eventTypeForm">
                        <input type="hidden" id="eventTypeId" value="${eventType ? eventType.id : ''}">
                        <div class="mb-3">
                            <label for="eventTypeName" class="form-label">Name *</label>
                            <input type="text" class="form-control" id="eventTypeName" required value="${eventType ? eventType.name : ''}">
                        </div>
                        <div class="mb-3">
                            <label for="eventTypeColor" class="form-label">Color *</label>
                            <input type="color" class="form-control" id="eventTypeColor" required value="${eventType ? eventType.color : '#0d6efd'}">
                        </div>
                        <div class="mb-3">
                            <label for="eventTypeIcon" class="form-label">Bootstrap Icon ID</label>
                            <input type="text" class="form-control" id="eventTypeIcon" value="${eventType ? eventType.bootstrap_icon_id : ''}" placeholder="e.g., calendar-event, trophy, flag">
                            <small class="form-text text-muted">Browse icons at <a href="https://icons.getbootstrap.com/" target="_blank">icons.getbootstrap.com</a></small>
                        </div>
                        <div class="d-flex gap-2 justify-content-end">
                            <button type="button" class="btn btn-secondary" id="cancelEventTypeBtn">
                                <i class="bi bi-x-lg"></i> Cancel
                            </button>
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-check-lg"></i> ${eventType ? 'Update' : 'Create'}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;

        listContainer.innerHTML = formHtml;

        document.getElementById('eventTypeForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            await saveEventType(eventType ? eventType.id : null);
        });

        document.getElementById('cancelEventTypeBtn').addEventListener('click', function() {
            loadEventTypes();
        });
    }

    // Edit event type
    window.editEventType = async function(eventTypeId) {
        try {
            const response = await fetch('{% url "players:get_event_types" %}');
            const result = await response.json();

            if (result.success) {
                const eventType = result.event_types.find(et => et.id === eventTypeId);
                if (eventType) {
                    showEventTypeForm(eventType);
                }
            }
        } catch (error) {
            alert('Error loading event type: ' + error.message);
        }
    };

    // Delete event type
    window.deleteEventType = async function(eventTypeId, eventTypeName) {
        if (!confirm(`Are you sure you want to delete the event type "${eventTypeName}"?\n\nThis will remove this type from all events that use it.`)) {
            return;
        }

        const formData = new FormData();
        formData.append('event_type_id', eventTypeId);

        try {
            const response = await fetch('{% url "players:delete_event_type" %}', {
                method: 'POST',
                headers: {'X-CSRFToken': getCookie('csrftoken')},
                body: formData
            });

            const result = await response.json();

            if (result.success) {
                alert(`Event type "${eventTypeName}" has been deleted.`);
                loadEventTypes();
                calendar.refetchEvents(); // Refresh calendar to show updated events
            } else {
                alert('Error: ' + result.error);
            }
        } catch (error) {
            alert('Error deleting event type: ' + error.message);
        }
    };

    // Save event type (create or update)
    async function saveEventType(eventTypeId) {
        const name = document.getElementById('eventTypeName').value.trim();
        const color = document.getElementById('eventTypeColor').value;
        const icon = document.getElementById('eventTypeIcon').value.trim();

        if (!name) {
            alert('Please enter a name');
            return;
        }

        const formData = new FormData();
        formData.append('name', name);
        formData.append('color', color);
        formData.append('bootstrap_icon_id', icon);

        const url = eventTypeId
            ? '{% url "players:update_event_type" %}'
            : '{% url "players:create_event_type" %}';

        if (eventTypeId) {
            formData.append('event_type_id', eventTypeId);
        }

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {'X-CSRFToken': getCookie('csrftoken')},
                body: formData
            });

            const result = await response.json();

            if (result.success) {
                loadEventTypes();
                calendar.refetchEvents(); // Refresh calendar to show updated colors/icons
            } else {
                alert('Error: ' + result.error);
            }
        } catch (error) {
            alert('Error saving event type: ' + error.message);
        }
    }
});
</script>
{% endblock %}
