{% extends "base.html" %}

{% block title %}Calendar - WUSA 7U{% endblock %}

{% block page_title %}WUSA 7U - Calendar{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card shadow">
        <div class="card-body">
            <!-- Admin Action Buttons (only shown if master password cookie exists) -->
            <div id="adminButtons" class="mb-3" style="display: none;">
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createEventModal">
                    <i class="bi bi-plus-circle me-1"></i>Create Event
                </button>
                <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createEventTypeModal">
                    <i class="bi bi-plus-circle me-1"></i>Create Event Type
                </button>
            </div>

            <!-- Month Navigation -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <a href="?year={{ prev_year }}&month={{ prev_month }}" class="btn btn-outline-primary">
                    <i class="bi bi-chevron-left"></i> Previous
                </a>
                <h2 class="mb-0">{{ month_name }} {{ year }}</h2>
                <a href="?year={{ next_year }}&month={{ next_month }}" class="btn btn-outline-primary">
                    Next <i class="bi bi-chevron-right"></i>
                </a>
            </div>

            <!-- Calendar Grid -->
            <div class="table-responsive">
                <table class="table table-bordered calendar-table">
                    <thead class="table-light">
                        <tr>
                            <th class="text-center">Sunday</th>
                            <th class="text-center">Monday</th>
                            <th class="text-center">Tuesday</th>
                            <th class="text-center">Wednesday</th>
                            <th class="text-center">Thursday</th>
                            <th class="text-center">Friday</th>
                            <th class="text-center">Saturday</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for week in calendar %}
                        <tr>
                            {% for day in week %}
                            <td class="calendar-day {% if day == 0 %}empty-day{% endif %} {% if day == today.day and month == today.month and year == today.year %}today{% endif %}" style="height: 120px; vertical-align: top;">
                                {% if day != 0 %}
                                    <div class="day-number {% if day == today.day and month == today.month and year == today.year %}text-primary fw-bold{% endif %}">
                                        {{ day }}
                                    </div>
                                    <div class="events-container">
                                        {# Events will be displayed here in the future #}
                                    </div>
                                {% endif %}
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<style>
.calendar-table {
    font-size: 0.9rem;
}

.calendar-day {
    padding: 0.5rem;
    position: relative;
}

.calendar-day.empty-day {
    background-color: #f8f9fa;
}

.calendar-day.today {
    background-color: #e7f3ff;
}

.day-number {
    font-size: 1.1rem;
    margin-bottom: 0.5rem;
}

.events-container {
    font-size: 0.85rem;
}

.event-badge {
    display: block;
    padding: 0.25rem 0.5rem;
    margin-bottom: 0.25rem;
    border-radius: 0.25rem;
    cursor: pointer;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.event-badge:hover {
    opacity: 0.8;
}
</style>

<!-- Create Event Modal -->
<div class="modal fade" id="createEventModal" tabindex="-1" aria-labelledby="createEventModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createEventModalLabel">Create New Event</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createEventForm">
                    <div class="mb-3">
                        <label for="eventName" class="form-label">Event Name</label>
                        <input type="text" class="form-control" id="eventName" required>
                    </div>
                    <div class="mb-3">
                        <label for="eventType" class="form-label">Event Type</label>
                        <select class="form-select" id="eventType" required>
                            <option value="">Select event type...</option>
                            {% for event_type in event_types %}
                            <option value="{{ event_type.id }}">{{ event_type.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="eventLocation" class="form-label">Location</label>
                        <input type="text" class="form-control" id="eventLocation">
                    </div>
                    <div class="mb-3">
                        <label for="eventTimestamp" class="form-label">
                            Date & Time
                            <i class="bi bi-info-circle text-muted"
                               data-bs-toggle="tooltip"
                               data-bs-placement="right"
                               title="Enter date and time in {{ display_timezone_name }} timezone"></i>
                        </label>
                        <input type="datetime-local" class="form-control" id="eventTimestamp" required>
                    </div>
                    <div class="mb-3">
                        <label for="eventDescription" class="form-label">Description (Optional)</label>
                        <textarea class="form-control" id="eventDescription" rows="3"></textarea>
                    </div>
                </form>
                <div id="createEventError" class="alert alert-danger d-none" role="alert"></div>
                <div id="createEventSuccess" class="alert alert-success d-none" role="alert"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveEventBtn">Create Event</button>
            </div>
        </div>
    </div>
</div>

<!-- Create Event Type Modal -->
<div class="modal fade" id="createEventTypeModal" tabindex="-1" aria-labelledby="createEventTypeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createEventTypeModalLabel">Create New Event Type</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createEventTypeForm">
                    <div class="mb-3">
                        <label for="eventTypeName" class="form-label">Name</label>
                        <input type="text" class="form-control" id="eventTypeName" required>
                    </div>
                    <div class="mb-3">
                        <label for="eventTypeIcon" class="form-label">Bootstrap Icon ID</label>
                        <input type="text" class="form-control" id="eventTypeIcon" placeholder="e.g., bi-calendar-event" required>
                        <small class="form-text text-muted">
                            Find icons at <a href="https://icons.getbootstrap.com/" target="_blank">Bootstrap Icons</a>
                        </small>
                    </div>
                </form>
                <div id="createEventTypeError" class="alert alert-danger d-none" role="alert"></div>
                <div id="createEventTypeSuccess" class="alert alert-success d-none" role="alert"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="saveEventTypeBtn">Create Event Type</button>
            </div>
        </div>
    </div>
</div>

<script>
// Check if master password cookie exists and show admin buttons
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Bootstrap tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    });

    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    }

    // Show admin buttons if master password cookie exists
    if (getCookie('master_password')) {
        document.getElementById('adminButtons').style.display = 'block';
    }

    // Create Event Type
    document.getElementById('saveEventTypeBtn').addEventListener('click', async function() {
        const name = document.getElementById('eventTypeName').value.trim();
        const icon = document.getElementById('eventTypeIcon').value.trim();
        const errorDiv = document.getElementById('createEventTypeError');
        const successDiv = document.getElementById('createEventTypeSuccess');
        const btn = this;

        errorDiv.classList.add('d-none');
        successDiv.classList.add('d-none');

        if (!name || !icon) {
            errorDiv.textContent = 'Please fill in all fields.';
            errorDiv.classList.remove('d-none');
            return;
        }

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Creating...';

        try {
            const formData = new FormData();
            formData.append('name', name);
            formData.append('bootstrap_icon_id', icon);

            const response = await fetch('{% url "players:create_event_type" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: formData
            });

            const result = await response.json();

            if (response.ok && result.success) {
                successDiv.textContent = result.message;
                successDiv.classList.remove('d-none');
                document.getElementById('createEventTypeForm').reset();

                // Reload event types in the event modal
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                errorDiv.textContent = result.error || 'Failed to create event type.';
                errorDiv.classList.remove('d-none');
            }
        } catch (error) {
            errorDiv.textContent = 'An error occurred. Please try again.';
            errorDiv.classList.remove('d-none');
        } finally {
            btn.disabled = false;
            btn.innerHTML = 'Create Event Type';
        }
    });

    // Create Event
    document.getElementById('saveEventBtn').addEventListener('click', async function() {
        const name = document.getElementById('eventName').value.trim();
        const eventType = document.getElementById('eventType').value;
        const location = document.getElementById('eventLocation').value.trim();
        const timestamp = document.getElementById('eventTimestamp').value;
        const description = document.getElementById('eventDescription').value.trim();
        const errorDiv = document.getElementById('createEventError');
        const successDiv = document.getElementById('createEventSuccess');
        const btn = this;

        errorDiv.classList.add('d-none');
        successDiv.classList.add('d-none');

        if (!name || !eventType || !timestamp) {
            errorDiv.textContent = 'Please fill in all required fields (Name, Event Type, and Date & Time).';
            errorDiv.classList.remove('d-none');
            return;
        }

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Creating...';

        try {
            const formData = new FormData();
            formData.append('name', name);
            formData.append('event_type_id', eventType);
            formData.append('location', location);
            formData.append('timestamp', timestamp);
            formData.append('description', description);

            const response = await fetch('{% url "players:create_event" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: formData
            });

            const result = await response.json();

            if (response.ok && result.success) {
                successDiv.textContent = result.message;
                successDiv.classList.remove('d-none');
                document.getElementById('createEventForm').reset();

                // Reload page to show new event
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                errorDiv.textContent = result.error || 'Failed to create event.';
                errorDiv.classList.remove('d-none');
            }
        } catch (error) {
            errorDiv.textContent = 'An error occurred. Please try again.';
            errorDiv.classList.remove('d-none');
        } finally {
            btn.disabled = false;
            btn.innerHTML = 'Create Event';
        }
    });
});
</script>
{% endblock %}
