{% extends "base.html" %}

{% block title %}Calendar - WUSA 7U{% endblock %}

{% block page_title %}WUSA 7U - Calendar{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Admin Action Buttons (only shown if master password cookie exists) -->
    <div id="adminButtons" class="mb-3 d-flex justify-content-end" style="display: none !important;">
        <button type="button" class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#createEventModal">
            <i class="bi bi-plus-circle me-1"></i>Create Event
        </button>
        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modifyEventTypesModal">
            <i class="bi bi-pencil-square me-1"></i>Modify Event Types
        </button>
    </div>

    <div class="card shadow">
        <div class="card-body">
            <!-- Month Navigation -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <a href="?year={{ prev_year }}&month={{ prev_month }}" class="btn btn-outline-primary">
                    <i class="bi bi-chevron-left"></i> Previous
                </a>
                <h2 class="mb-0">{{ month_name }} {{ year }}</h2>
                <a href="?year={{ next_year }}&month={{ next_month }}" class="btn btn-outline-primary">
                    Next <i class="bi bi-chevron-right"></i>
                </a>
            </div>

            <!-- Calendar Grid -->
            <div class="table-responsive">
                <table class="table table-bordered calendar-table">
                    <thead class="table-light">
                        <tr>
                            <th class="text-center">Sunday</th>
                            <th class="text-center">Monday</th>
                            <th class="text-center">Tuesday</th>
                            <th class="text-center">Wednesday</th>
                            <th class="text-center">Thursday</th>
                            <th class="text-center">Friday</th>
                            <th class="text-center">Saturday</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for week in calendar %}
                        <tr>
                            {% for day in week %}
                            <td class="calendar-day {% if day == 0 %}empty-day{% endif %} {% if day == today.day and month == today.month and year == today.year %}today{% endif %}" {% if day != 0 %}onclick="openCreateEventModal({{ year }}, {{ month }}, {{ day }})"{% endif %}>
                                {% if day != 0 %}
                                    <i class="bi bi-plus-circle-fill add-event-icon"></i>
                                    <div class="day-number {% if day == today.day and month == today.month and year == today.year %}text-primary fw-bold{% endif %}" style="position: relative; z-index: 2;">
                                        {{ day }}
                                    </div>
                                    <div class="events-container" style="position: relative; z-index: 2;">
                                        {% for event_day, event_list in events_by_day.items %}
                                            {% if event_day == day %}
                                                {% for event_data in event_list %}
                                                    {% if forloop.counter <= 3 %}
                                                    <div class="event-badge text-white {% if needs_master_password_challenge == False %}event-editable{% endif %}"
                                                         style="background-color: {% if event_data.event.event_type %}{{ event_data.event.event_type.color }}{% else %}#0d6efd{% endif %};"
                                                         data-event-id="{{ event_data.event.id }}"
                                                         data-bs-toggle="tooltip"
                                                         data-bs-placement="top"
                                                         data-bs-html="true"
                                                         title="<strong>{{ event_data.event.name }}</strong><br>
                                                                {% if event_data.event.event_type %}<i class='bi {{ event_data.event.event_type.bootstrap_icon_id }}'></i> {{ event_data.event.event_type.name }}<br>{% endif %}
                                                                {% if event_data.has_time %}<i class='bi bi-clock'></i> {{ event_data.local_time|date:'g:i A' }}<br>{% endif %}
                                                                {% if event_data.event.location %}<i class='bi bi-geo-alt'></i> {{ event_data.event.location }}<br>{% endif %}
                                                                {% if event_data.event.description %}{{ event_data.event.description|truncatewords:20 }}{% endif %}">
                                                        <i class="bi {% if event_data.event.event_type %}{{ event_data.event.event_type.bootstrap_icon_id }}{% else %}bi-calendar-event{% endif %}"></i>
                                                        {{ event_data.event.name|truncatewords:3 }}
                                                    </div>
                                                    {% endif %}
                                                {% endfor %}
                                                {% if event_list|length > 3 %}
                                                <div class="more-events-link" onclick="event.stopPropagation(); showDayEvents({{ day }}, '{{ month_name }}', {{ year }});">
                                                    +{{ event_list|length|add:"-3" }} more...
                                                </div>
                                                {% endif %}
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<style>
.calendar-table {
    font-size: 0.9rem;
    table-layout: fixed;
    width: 100%;
}

.calendar-table th,
.calendar-table td {
    width: 14.28%; /* 100% / 7 days */
}

.calendar-day {
    padding: 0.5rem;
    position: relative;
    height: 150px;
    width: 100%;
    vertical-align: top;
    overflow: hidden;
    cursor: pointer;
}

.calendar-day.empty-day {
    background-color: #f8f9fa;
    cursor: default;
}

.calendar-day.today {
    background-color: #e7f3ff;
}

.calendar-day:not(.empty-day):hover {
    background-color: #f0f0f0;
}

.calendar-day:not(.empty-day):hover .add-event-icon {
    opacity: 1;
}

.add-event-icon {
    position: absolute;
    bottom: 8px;
    right: 8px;
    font-size: 1.2rem;
    color: #198754;
    opacity: 0;
    transition: opacity 0.2s;
    pointer-events: none;
    z-index: 1;
}

.day-number {
    font-size: 1.1rem;
    margin-bottom: 0.5rem;
}

.events-container {
    font-size: 0.85rem;
    max-height: 110px;
    overflow-y: auto;
    overflow-x: hidden;
}

.event-badge {
    display: block;
    padding: 0.25rem 0.5rem;
    margin-bottom: 0.25rem;
    border-radius: 0.25rem;
    cursor: pointer;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.event-badge:hover {
    opacity: 0.8;
}

.color-swatch {
    width: 40px;
    height: 40px;
    border-radius: 0.25rem;
    cursor: pointer;
    border: 3px solid transparent;
    transition: all 0.2s;
}

.color-swatch:hover {
    transform: scale(1.1);
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.color-swatch.selected {
    border-color: #000;
    box-shadow: 0 0 0 2px #fff, 0 0 0 4px #000;
}

/* Custom tooltip styling for calendar events */
.tooltip-inner {
    max-width: 400px !important;
    text-align: left !important;
}

.more-events-link {
    font-size: 0.75rem;
    color: #0d6efd;
    cursor: pointer;
    padding: 0.25rem 0.5rem;
    text-decoration: underline;
}

.more-events-link:hover {
    color: #0a58ca;
}
</style>

<!-- Create Event Modal -->
<div class="modal fade" id="createEventModal" tabindex="-1" aria-labelledby="createEventModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createEventModalLabel">Create New Event</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createEventForm">
                    <div class="mb-3">
                        <label for="eventName" class="form-label">Event Name</label>
                        <input type="text" class="form-control" id="eventName" required>
                    </div>
                    <div class="mb-3">
                        <label for="eventType" class="form-label">Event Type</label>
                        <select class="form-select" id="eventType" required>
                            <option value="">Select event type...</option>
                            {% for event_type in event_types %}
                            <option value="{{ event_type.id }}">{{ event_type.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="eventLocation" class="form-label">Location (Optional)</label>
                        <input type="text" class="form-control" id="eventLocation">
                    </div>
                    <div class="mb-3">
                        <label for="eventDate" class="form-label">
                            Date
                            <i class="bi bi-info-circle text-muted"
                               data-bs-toggle="tooltip"
                               data-bs-placement="right"
                               title="Enter date in {{ display_timezone_name }} timezone"></i>
                        </label>
                        <input type="date" class="form-control" id="eventDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="eventTime" class="form-label">Time (Optional)</label>
                        <input type="time" class="form-control" id="eventTime">
                    </div>
                    <div class="mb-3">
                        <label for="eventDescription" class="form-label">Description (Optional)</label>
                        <textarea class="form-control" id="eventDescription" rows="3"></textarea>
                    </div>
                </form>
                <div id="createEventError" class="alert alert-danger d-none" role="alert"></div>
                <div id="createEventSuccess" class="alert alert-success d-none" role="alert"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveEventBtn">Create Event</button>
            </div>
        </div>
    </div>
</div>

<!-- Modify Event Types Modal -->
<div class="modal fade" id="modifyEventTypesModal" tabindex="-1" aria-labelledby="modifyEventTypesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modifyEventTypesModalLabel">Modify Event Types</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Create New Event Type Section -->
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0"><i class="bi bi-plus-circle me-2"></i>Create New Event Type</h6>
                    </div>
                    <div class="card-body">
                        <form id="createEventTypeForm">
                            <div class="mb-3">
                                <label for="newEventTypeName" class="form-label">Name</label>
                                <input type="text" class="form-control" id="newEventTypeName" required>
                            </div>
                            <div class="mb-3">
                                <label for="newEventTypeIcon" class="form-label">Bootstrap Icon ID</label>
                                <input type="text" class="form-control" id="newEventTypeIcon" placeholder="e.g., bi-calendar-event" required>
                                <small class="form-text text-muted">
                                    Find icons at <a href="https://icons.getbootstrap.com/" target="_blank">Bootstrap Icons</a>
                                </small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Display Color</label>
                                <div id="newColorSwatches" class="d-flex flex-wrap gap-2 mb-2">
                                    <div class="color-swatch" data-color="#0d6efd" style="background-color: #0d6efd;" title="Blue"></div>
                                    <div class="color-swatch" data-color="#6610f2" style="background-color: #6610f2;" title="Indigo"></div>
                                    <div class="color-swatch" data-color="#6f42c1" style="background-color: #6f42c1;" title="Purple"></div>
                                    <div class="color-swatch" data-color="#d63384" style="background-color: #d63384;" title="Pink"></div>
                                    <div class="color-swatch" data-color="#dc3545" style="background-color: #dc3545;" title="Red"></div>
                                    <div class="color-swatch" data-color="#fd7e14" style="background-color: #fd7e14;" title="Orange"></div>
                                    <div class="color-swatch" data-color="#ffc107" style="background-color: #ffc107;" title="Yellow"></div>
                                    <div class="color-swatch" data-color="#198754" style="background-color: #198754;" title="Green"></div>
                                    <div class="color-swatch" data-color="#20c997" style="background-color: #20c997;" title="Teal"></div>
                                    <div class="color-swatch" data-color="#0dcaf0" style="background-color: #0dcaf0;" title="Cyan"></div>
                                    <div class="color-swatch" data-color="#6c757d" style="background-color: #6c757d;" title="Gray"></div>
                                    <div class="color-swatch" data-color="#495057" style="background-color: #495057;" title="Dark"></div>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="newCustomColorToggle">
                                    <label class="form-check-label" for="newCustomColorToggle">
                                        Use custom color code
                                    </label>
                                </div>
                                <input type="text" class="form-control mt-2 d-none" id="newCustomColorInput" placeholder="#0d6efd" pattern="^#[0-9A-Fa-f]{6}$">
                                <input type="hidden" id="newEventTypeColor" value="#0d6efd">
                            </div>
                            <button type="button" class="btn btn-success btn-sm" id="createNewEventTypeBtn">
                                <i class="bi bi-plus-circle me-1"></i>Create Event Type
                            </button>
                        </form>
                        <div id="createEventTypeError" class="alert alert-danger d-none mt-3" role="alert"></div>
                        <div id="createEventTypeSuccess" class="alert alert-success d-none mt-3" role="alert"></div>
                    </div>
                </div>

                <!-- Existing Event Types Section -->
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0"><i class="bi bi-pencil-square me-2"></i>Edit Existing Event Types</h6>
                    </div>
                    <div class="card-body">
                        <div id="existingEventTypesList">
                            <div class="text-center py-3">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                        <div id="updateEventTypeError" class="alert alert-danger d-none mt-3" role="alert"></div>
                        <div id="updateEventTypeSuccess" class="alert alert-success d-none mt-3" role="alert"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Day Events Modal -->
<div class="modal fade" id="dayEventsModal" tabindex="-1" aria-labelledby="dayEventsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="dayEventsModalLabel"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <div id="dayEventsContent">
                    <div class="text-center py-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Event Modal -->
<div class="modal fade" id="editEventModal" tabindex="-1" aria-labelledby="editEventModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editEventModalLabel">Edit Event</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editEventForm">
                    <input type="hidden" id="editEventId">
                    <div class="mb-3">
                        <label for="editEventName" class="form-label">Event Name</label>
                        <input type="text" class="form-control" id="editEventName" required>
                    </div>
                    <div class="mb-3">
                        <label for="editEventType" class="form-label">Event Type</label>
                        <select class="form-select" id="editEventType" required>
                            <option value="">Select event type...</option>
                            {% for event_type in event_types %}
                            <option value="{{ event_type.id }}">{{ event_type.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editEventLocation" class="form-label">Location (Optional)</label>
                        <input type="text" class="form-control" id="editEventLocation">
                    </div>
                    <div class="mb-3">
                        <label for="editEventDate" class="form-label">
                            Date
                            <i class="bi bi-info-circle text-muted"
                               data-bs-toggle="tooltip"
                               data-bs-placement="right"
                               title="Enter date in {{ display_timezone_name }} timezone"></i>
                        </label>
                        <input type="date" class="form-control" id="editEventDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="editEventTime" class="form-label">Time (Optional)</label>
                        <input type="time" class="form-control" id="editEventTime">
                    </div>
                    <div class="mb-3">
                        <label for="editEventDescription" class="form-label">Description (Optional)</label>
                        <textarea class="form-control" id="editEventDescription" rows="3"></textarea>
                    </div>
                </form>
                <div id="editEventError" class="alert alert-danger d-none" role="alert"></div>
                <div id="editEventSuccess" class="alert alert-success d-none" role="alert"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" id="deleteEventBtn">Delete Event</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="updateEventBtn">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<script>
// Check if master password cookie exists and show admin buttons
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Bootstrap tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    });

    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    }

    // Show admin buttons if master password cookie exists
    const hasMasterPassword = !!getCookie('master_password');
    if (hasMasterPassword) {
        document.getElementById('adminButtons').style.display = 'block';

        // Enable drag-and-drop for events
        enableEventDragDrop();
    }

    // Handle color swatch selection for new event types
    const newColorSwatches = document.querySelectorAll('#newColorSwatches .color-swatch');
    const newEventTypeColorInput = document.getElementById('newEventTypeColor');
    const newCustomColorToggle = document.getElementById('newCustomColorToggle');
    const newCustomColorInput = document.getElementById('newCustomColorInput');

    newColorSwatches.forEach(swatch => {
        swatch.addEventListener('click', function() {
            if (!newCustomColorToggle.checked) {
                newColorSwatches.forEach(s => s.classList.remove('selected'));
                this.classList.add('selected');
                newEventTypeColorInput.value = this.dataset.color;
            }
        });
    });

    // Select first color by default
    newColorSwatches[0].classList.add('selected');

    newCustomColorToggle.addEventListener('change', function() {
        if (this.checked) {
            newColorSwatches.forEach(s => s.classList.remove('selected'));
            newCustomColorInput.classList.remove('d-none');
            newCustomColorInput.required = true;
        } else {
            newCustomColorInput.classList.add('d-none');
            newCustomColorInput.required = false;
            newColorSwatches[0].classList.add('selected');
            newEventTypeColorInput.value = newColorSwatches[0].dataset.color;
        }
    });

    newCustomColorInput.addEventListener('input', function() {
        if (this.value.match(/^#[0-9A-Fa-f]{6}$/)) {
            newEventTypeColorInput.value = this.value;
        }
    });

    // Function to refresh event types dropdown in Create Event modal
    async function refreshEventTypesDropdown() {
        const eventTypeSelect = document.getElementById('eventType');
        const currentValue = eventTypeSelect.value; // Preserve current selection if any

        try {
            const response = await fetch('{% url "players:get_event_types" %}');
            const result = await response.json();

            if (response.ok && result.success) {
                // Clear existing options except the first placeholder
                eventTypeSelect.innerHTML = '<option value="">Select event type...</option>';

                // Add new options
                result.event_types.forEach(et => {
                    const option = document.createElement('option');
                    option.value = et.id;
                    option.textContent = et.name;
                    eventTypeSelect.appendChild(option);
                });

                // Restore previous selection if it still exists
                if (currentValue) {
                    eventTypeSelect.value = currentValue;
                }
            }
        } catch (error) {
            console.error('Failed to refresh event types dropdown:', error);
        }
    }

    // Load event types when modal is opened
    const modifyEventTypesModal = document.getElementById('modifyEventTypesModal');
    modifyEventTypesModal.addEventListener('show.bs.modal', loadEventTypes);

    async function loadEventTypes() {
        const listContainer = document.getElementById('existingEventTypesList');
        listContainer.innerHTML = '<div class="text-center py-3"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';

        try {
            const response = await fetch('{% url "players:get_event_types" %}');
            const result = await response.json();

            if (response.ok && result.success) {
                if (result.event_types.length === 0) {
                    listContainer.innerHTML = '<p class="text-muted text-center">No event types found. Create one above!</p>';
                } else {
                    const presetColors = ['#0d6efd', '#6610f2', '#6f42c1', '#d63384', '#dc3545', '#fd7e14', '#ffc107', '#198754', '#20c997', '#0dcaf0', '#6c757d', '#495057'];

                    let html = '';
                    result.event_types.forEach(et => {
                        const swatchesHtml = presetColors.map(color =>
                            `<div class="color-swatch ${et.color === color ? 'selected' : ''}" data-color="${color}" style="background-color: ${color};"></div>`
                        ).join('');

                        const isCustomColor = !presetColors.includes(et.color);

                        html += `
                            <div class="border rounded p-3 mb-3" data-event-type-id="${et.id}">
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label small text-muted">Name</label>
                                        <input type="text" class="form-control form-control-sm" value="${et.name}" data-field="name">
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label small text-muted">
                                            Icon ID
                                            <i class="bi bi-info-circle text-muted"
                                               data-bs-toggle="tooltip"
                                               data-bs-placement="top"
                                               data-bs-html="true"
                                               title="Visit <a href='https://icons.getbootstrap.com/' target='_blank'>Bootstrap Icons</a>, find your icon, and copy its class name.<br><br><strong>Example:</strong> For the calendar icon, enter <code>bi-calendar-event</code>"></i>
                                        </label>
                                        <input type="text" class="form-control form-control-sm" value="${et.bootstrap_icon_id}" data-field="icon">
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label small text-muted">Preview</label>
                                        <div>
                                            <span class="badge text-white" style="background-color: ${et.color};">
                                                <i class="bi ${et.bootstrap_icon_id}"></i> ${et.name}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label small text-muted">Display Color</label>
                                    <div class="color-swatches-${et.id} d-flex flex-wrap gap-2 mb-2">
                                        ${swatchesHtml}
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input custom-color-toggle" type="checkbox" id="customColorToggle${et.id}" ${isCustomColor ? 'checked' : ''}>
                                        <label class="form-check-label" for="customColorToggle${et.id}">
                                            Use custom color code
                                        </label>
                                    </div>
                                    <input type="text" class="form-control form-control-sm mt-2 custom-color-input ${isCustomColor ? '' : 'd-none'}"
                                           value="${isCustomColor ? et.color : '#0d6efd'}"
                                           placeholder="#0d6efd"
                                           pattern="^#[0-9A-Fa-f]{6}$">
                                    <input type="hidden" data-field="color" value="${et.color}">
                                </div>
                                <button type="button" class="btn btn-primary btn-sm" onclick="updateEventType(${et.id})">
                                    <i class="bi bi-check-circle me-1"></i>Save Changes
                                </button>
                            </div>
                        `;
                    });
                    listContainer.innerHTML = html;

                    // Reinitialize Bootstrap tooltips for dynamically generated content
                    const tooltipTriggerList = [].slice.call(listContainer.querySelectorAll('[data-bs-toggle="tooltip"]'));
                    tooltipTriggerList.map(function (tooltipTriggerEl) {
                        return new bootstrap.Tooltip(tooltipTriggerEl);
                    });

                    // Setup color swatch handlers for each event type
                    result.event_types.forEach(et => {
                        setupColorSwatchHandlers(et.id);
                    });
                }
            } else {
                listContainer.innerHTML = '<p class="text-danger">Failed to load event types.</p>';
            }
        } catch (error) {
            listContainer.innerHTML = '<p class="text-danger">An error occurred while loading event types.</p>';
        }
    }

    // Setup color swatch handlers for existing event types
    function setupColorSwatchHandlers(eventTypeId) {
        const container = document.querySelector(`[data-event-type-id="${eventTypeId}"]`);
        const swatches = container.querySelectorAll('.color-swatch');
        const colorInput = container.querySelector('[data-field="color"]');
        const customToggle = container.querySelector('.custom-color-toggle');
        const customInput = container.querySelector('.custom-color-input');

        swatches.forEach(swatch => {
            swatch.addEventListener('click', function() {
                if (!customToggle.checked) {
                    swatches.forEach(s => s.classList.remove('selected'));
                    this.classList.add('selected');
                    colorInput.value = this.dataset.color;
                    // Update preview
                    const preview = container.querySelector('.badge');
                    preview.style.backgroundColor = this.dataset.color;
                }
            });
        });

        customToggle.addEventListener('change', function() {
            if (this.checked) {
                swatches.forEach(s => s.classList.remove('selected'));
                customInput.classList.remove('d-none');
                customInput.required = true;
            } else {
                customInput.classList.add('d-none');
                customInput.required = false;
                const firstSwatch = swatches[0];
                firstSwatch.classList.add('selected');
                colorInput.value = firstSwatch.dataset.color;
                // Update preview
                const preview = container.querySelector('.badge');
                preview.style.backgroundColor = firstSwatch.dataset.color;
            }
        });

        customInput.addEventListener('input', function() {
            if (this.value.match(/^#[0-9A-Fa-f]{6}$/)) {
                colorInput.value = this.value;
                // Update preview
                const preview = container.querySelector('.badge');
                preview.style.backgroundColor = this.value;
            }
        });
    }

    // Create New Event Type
    document.getElementById('createNewEventTypeBtn').addEventListener('click', async function() {
        const name = document.getElementById('newEventTypeName').value.trim();
        const icon = document.getElementById('newEventTypeIcon').value.trim();
        const color = document.getElementById('newEventTypeColor').value;
        const errorDiv = document.getElementById('createEventTypeError');
        const successDiv = document.getElementById('createEventTypeSuccess');
        const btn = this;

        errorDiv.classList.add('d-none');
        successDiv.classList.add('d-none');

        if (!name || !icon) {
            errorDiv.textContent = 'Please fill in all fields.';
            errorDiv.classList.remove('d-none');
            return;
        }

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Creating...';

        try {
            const formData = new FormData();
            formData.append('name', name);
            formData.append('bootstrap_icon_id', icon);
            formData.append('color', color);

            const response = await fetch('{% url "players:create_event_type" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: formData
            });

            const result = await response.json();

            if (response.ok && result.success) {
                successDiv.textContent = result.message;
                successDiv.classList.remove('d-none');
                document.getElementById('createEventTypeForm').reset();
                document.getElementById('newEventTypeColor').value = '#0d6efd';

                // Reload the event types list in the modal
                await loadEventTypes();

                // Refresh the event types dropdown in the Create Event modal
                await refreshEventTypesDropdown();

                // Clear success message after 3 seconds
                setTimeout(() => {
                    successDiv.classList.add('d-none');
                }, 3000);
            } else {
                errorDiv.textContent = result.error || 'Failed to create event type.';
                errorDiv.classList.remove('d-none');
            }
        } catch (error) {
            errorDiv.textContent = 'An error occurred. Please try again.';
            errorDiv.classList.remove('d-none');
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-plus-circle me-1"></i>Create Event Type';
        }
    });

    // Hide error messages when user interacts with form
    const createEventForm = document.getElementById('createEventForm');
    createEventForm.addEventListener('input', function() {
        const errorDiv = document.getElementById('createEventError');
        errorDiv.classList.add('d-none');
    });

    // Create Event
    document.getElementById('saveEventBtn').addEventListener('click', async function() {
        const name = document.getElementById('eventName').value.trim();
        const eventType = document.getElementById('eventType').value;
        const location = document.getElementById('eventLocation').value.trim();
        const eventDate = document.getElementById('eventDate').value;
        const eventTime = document.getElementById('eventTime').value;
        const description = document.getElementById('eventDescription').value.trim();
        const errorDiv = document.getElementById('createEventError');
        const successDiv = document.getElementById('createEventSuccess');
        const btn = this;

        errorDiv.classList.add('d-none');
        successDiv.classList.add('d-none');

        if (!name || !eventType || !eventDate) {
            errorDiv.textContent = 'Please fill in all required fields (Name, Event Type, and Date).';
            errorDiv.classList.remove('d-none');
            return;
        }

        // Combine date and time - if no time provided, use midnight
        const timestamp = eventTime ? `${eventDate}T${eventTime}` : `${eventDate}T00:00`;

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Creating...';

        try {
            const formData = new FormData();
            formData.append('name', name);
            formData.append('event_type_id', eventType);
            formData.append('location', location);
            formData.append('timestamp', timestamp);
            formData.append('description', description);

            const response = await fetch('{% url "players:create_event" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: formData
            });

            const result = await response.json();

            if (response.ok && result.success) {
                successDiv.textContent = result.message;
                successDiv.classList.remove('d-none');
                document.getElementById('createEventForm').reset();

                // Reload page to show new event
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                errorDiv.textContent = result.error || 'Failed to create event.';
                errorDiv.classList.remove('d-none');
            }
        } catch (error) {
            errorDiv.textContent = 'An error occurred. Please try again.';
            errorDiv.classList.remove('d-none');
        } finally {
            btn.disabled = false;
            btn.innerHTML = 'Create Event';
        }
    });
});

// Global function to update event type (called from dynamically generated HTML)
async function updateEventType(eventTypeId) {
    const container = document.querySelector(`[data-event-type-id="${eventTypeId}"]`);
    const name = container.querySelector('[data-field="name"]').value.trim();
    const icon = container.querySelector('[data-field="icon"]').value.trim();
    const color = container.querySelector('[data-field="color"]').value;
    const errorDiv = document.getElementById('updateEventTypeError');
    const successDiv = document.getElementById('updateEventTypeSuccess');
    const btn = container.querySelector('button');

    errorDiv.classList.add('d-none');
    successDiv.classList.add('d-none');

    if (!name || !icon) {
        errorDiv.textContent = 'Please fill in all fields.';
        errorDiv.classList.remove('d-none');
        return;
    }

    const originalHTML = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';

    try {
        const formData = new FormData();
        formData.append('id', eventTypeId);
        formData.append('name', name);
        formData.append('bootstrap_icon_id', icon);
        formData.append('color', color);

        const response = await fetch('{% url "players:update_event_type" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: formData
        });

        const result = await response.json();

        if (response.ok && result.success) {
            successDiv.textContent = result.message;
            successDiv.classList.remove('d-none');

            // Update the preview badge
            const preview = container.querySelector('.badge');
            preview.style.backgroundColor = color;
            preview.innerHTML = `<i class="bi ${icon}"></i> ${name}`;

            // Clear success message after 3 seconds
            setTimeout(() => {
                successDiv.classList.add('d-none');
            }, 3000);
        } else {
            errorDiv.textContent = result.error || 'Failed to update event type.';
            errorDiv.classList.remove('d-none');
        }
    } catch (error) {
        errorDiv.textContent = 'An error occurred. Please try again.';
        errorDiv.classList.remove('d-none');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalHTML;
    }
}

// Global function to open Create Event modal with date pre-filled
function openCreateEventModal(year, month, day) {
    const modal = new bootstrap.Modal(document.getElementById('createEventModal'));

    // Format the date as YYYY-MM-DD
    const monthStr = String(month).padStart(2, '0');
    const dayStr = String(day).padStart(2, '0');
    const dateStr = `${year}-${monthStr}-${dayStr}`;

    // Set the date input value
    document.getElementById('eventDate').value = dateStr;

    // Clear time field (make it optional)
    document.getElementById('eventTime').value = '';

    // Clear other fields
    document.getElementById('eventName').value = '';
    document.getElementById('eventType').value = '';
    document.getElementById('eventLocation').value = '';
    document.getElementById('eventDescription').value = '';

    // Hide any error/success messages
    document.getElementById('createEventError').classList.add('d-none');
    document.getElementById('createEventSuccess').classList.add('d-none');

    modal.show();
}

// Global function to show all events for a specific day
function showDayEvents(day, monthName, year) {
    const modal = new bootstrap.Modal(document.getElementById('dayEventsModal'));
    const modalTitle = document.getElementById('dayEventsModalLabel');
    const contentDiv = document.getElementById('dayEventsContent');

    // Set modal title
    modalTitle.textContent = `Events for ${monthName} ${day}, ${year}`;

    // Get all events for this day from the template data
    const eventsData = {{ events_by_day_json|safe }};
    const dayEvents = eventsData[day] || [];

    if (dayEvents.length === 0) {
        contentDiv.innerHTML = '<p class="text-muted">No events for this day.</p>';
    } else {
        const hasMasterPassword = {% if needs_master_password_challenge == False %}true{% else %}false{% endif %};
        let html = '<div class="list-group">';
        dayEvents.forEach(eventData => {
            const event = eventData.event;
            const localTime = new Date(eventData.local_time);
            const timeStr = localTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            const hasTime = eventData.has_time;

            html += `
                <div class="list-group-item ${hasMasterPassword ? 'list-group-item-action' : ''}" ${hasMasterPassword ? `style="cursor: pointer;" onclick="openEditEventModal(${event.id});"` : ''}>
                    <div class="d-flex w-100 justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-2">
                                <span class="badge text-white me-2" style="background-color: ${event.event_type ? event.event_type.color : '#0d6efd'};">
                                    <i class="bi ${event.event_type ? event.event_type.bootstrap_icon_id : 'bi-calendar-event'}"></i>
                                </span>
                                <h6 class="mb-0">${event.name}</h6>
                            </div>
                            ${event.event_type ? `<p class="mb-1 text-muted small"><i class="bi ${event.event_type.bootstrap_icon_id}"></i> ${event.event_type.name}</p>` : ''}
                            ${hasTime ? `<p class="mb-1"><i class="bi bi-clock"></i> ${timeStr}</p>` : ''}
                            ${event.location ? `<p class="mb-1"><i class="bi bi-geo-alt"></i> ${event.location}</p>` : ''}
                            ${event.description ? `<p class="mb-0 text-muted small">${event.description}</p>` : ''}
                        </div>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        contentDiv.innerHTML = html;
    }

    modal.show();
}

// Global function to open Edit Event modal
async function openEditEventModal(eventId) {
    const modal = new bootstrap.Modal(document.getElementById('editEventModal'));
    const errorDiv = document.getElementById('editEventError');
    const successDiv = document.getElementById('editEventSuccess');

    // Hide error/success messages
    errorDiv.classList.add('d-none');
    successDiv.classList.add('d-none');

    try {
        // Fetch event data from the server
        const response = await fetch(`{% url "players:get_event" %}?id=${eventId}`);
        const result = await response.json();

        if (!response.ok || !result.success) {
            errorDiv.textContent = result.error || 'Failed to load event data.';
            errorDiv.classList.remove('d-none');
            return;
        }

        // Populate the form with event data
        const event = result.event;
        document.getElementById('editEventId').value = event.id;
        document.getElementById('editEventName').value = event.name;
        document.getElementById('editEventType').value = event.event_type_id || '';
        document.getElementById('editEventLocation').value = event.location;

        // Split timestamp into date and time
        const timestampParts = event.timestamp.split('T');
        document.getElementById('editEventDate').value = timestampParts[0];
        // Only set time if it's not midnight (00:00:00)
        if (timestampParts[1] && !timestampParts[1].startsWith('00:00')) {
            document.getElementById('editEventTime').value = timestampParts[1].substring(0, 5); // HH:MM
        } else {
            document.getElementById('editEventTime').value = '';
        }

        document.getElementById('editEventDescription').value = event.description;

        // Show the modal
        modal.show();

    } catch (error) {
        errorDiv.textContent = 'An error occurred loading the event.';
        errorDiv.classList.remove('d-none');
    }
}

// Handle Update Event button click
document.getElementById('updateEventBtn').addEventListener('click', async function() {
    const btn = this;
    const originalHTML = btn.innerHTML;
    const errorDiv = document.getElementById('editEventError');
    const successDiv = document.getElementById('editEventSuccess');

    // Hide previous messages
    errorDiv.classList.add('d-none');
    successDiv.classList.add('d-none');

    // Get form values
    const eventId = document.getElementById('editEventId').value;
    const name = document.getElementById('editEventName').value.trim();
    const eventType = document.getElementById('editEventType').value;
    const location = document.getElementById('editEventLocation').value.trim();
    const eventDate = document.getElementById('editEventDate').value;
    const eventTime = document.getElementById('editEventTime').value;
    const description = document.getElementById('editEventDescription').value.trim();

    if (!name || !eventDate) {
        errorDiv.textContent = 'Event name and date are required.';
        errorDiv.classList.remove('d-none');
        return;
    }

    // Combine date and time - if no time provided, use midnight
    const timestamp = eventTime ? `${eventDate}T${eventTime}` : `${eventDate}T00:00`;

    // Show loading state
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';

    try {
        const formData = new FormData();
        formData.append('id', eventId);
        formData.append('name', name);
        formData.append('event_type', eventType);
        formData.append('location', location);
        formData.append('timestamp', timestamp);
        formData.append('description', description);

        const response = await fetch('{% url "players:update_event" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: formData
        });

        const result = await response.json();

        if (response.ok && result.success) {
            successDiv.textContent = result.message;
            successDiv.classList.remove('d-none');

            // Reload the page after a short delay
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            errorDiv.textContent = result.error || 'Failed to update event.';
            errorDiv.classList.remove('d-none');
        }
    } catch (error) {
        errorDiv.textContent = 'An error occurred. Please try again.';
        errorDiv.classList.remove('d-none');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalHTML;
    }
});

// Handle Delete Event button click
document.getElementById('deleteEventBtn').addEventListener('click', async function() {
    const eventName = document.getElementById('editEventName').value.trim();

    if (!confirm(`Are you sure you want to delete the event "${eventName}"? This action cannot be undone.`)) {
        return;
    }

    const btn = this;
    const originalHTML = btn.innerHTML;
    const errorDiv = document.getElementById('editEventError');
    const successDiv = document.getElementById('editEventSuccess');

    // Hide previous messages
    errorDiv.classList.add('d-none');
    successDiv.classList.add('d-none');

    const eventId = document.getElementById('editEventId').value;

    // Show loading state
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Deleting...';

    try {
        const formData = new FormData();
        formData.append('id', eventId);

        const response = await fetch('{% url "players:delete_event" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: formData
        });

        const result = await response.json();

        if (response.ok && result.success) {
            successDiv.textContent = result.message;
            successDiv.classList.remove('d-none');

            // Reload the page after a short delay
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            errorDiv.textContent = result.error || 'Failed to delete event.';
            errorDiv.classList.remove('d-none');
        }
    } catch (error) {
        errorDiv.textContent = 'An error occurred. Please try again.';
        errorDiv.classList.remove('d-none');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalHTML;
    }
});

// Enable drag-and-drop for calendar events
function enableEventDragDrop() {
    const eventBadges = document.querySelectorAll('.event-badge');
    const calendarDays = document.querySelectorAll('.calendar-day:not(.empty-day)');

    console.log('Enabling drag-drop for', eventBadges.length, 'event badges');

    // Make event badges draggable
    eventBadges.forEach(badge => {
        badge.setAttribute('draggable', 'true');
        badge.style.cursor = 'move';

        // Disable Bootstrap tooltip during drag to prevent interference
        badge.addEventListener('mousedown', function(e) {
            // Dispose tooltip if it exists
            const tooltip = bootstrap.Tooltip.getInstance(this);
            if (tooltip) {
                tooltip.dispose();
            }
        });

        // Add click handler for editing (only if not dragging)
        let isDragging = false;
        badge.addEventListener('click', function(e) {
            if (!isDragging) {
                e.stopPropagation();
                const eventId = this.getAttribute('data-event-id');
                if (eventId) {
                    openEditEventModal(eventId);
                }
            }
            isDragging = false;
        });

        badge.addEventListener('dragstart', function(e) {
            isDragging = true;
            e.stopPropagation();
            // Store event ID in the drag data
            const eventId = this.getAttribute('data-event-id');
            console.log('Drag started for event ID:', eventId);
            if (!eventId) {
                e.preventDefault();
                return;
            }
            e.dataTransfer.setData('eventId', eventId);
            e.dataTransfer.effectAllowed = 'move';
            this.style.opacity = '0.5';
        });

        badge.addEventListener('dragend', function(e) {
            this.style.opacity = '1';
            // Reinitialize tooltip after drag
            setTimeout(() => {
                new bootstrap.Tooltip(this);
            }, 100);
        });
    });

    // Make calendar days drop targets
    calendarDays.forEach(day => {
        day.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            e.dataTransfer.dropEffect = 'move';
            this.style.backgroundColor = '#d0e8ff';
        });

        day.addEventListener('dragleave', function(e) {
            this.style.backgroundColor = '';
        });

        day.addEventListener('drop', async function(e) {
            e.preventDefault();
            e.stopPropagation();
            this.style.backgroundColor = '';

            const eventId = e.dataTransfer.getData('eventId');
            if (!eventId) return;

            // Extract day, month, year from the cell
            const dayNumber = this.querySelector('.day-number').textContent.trim();
            const month = {{ month }};
            const year = {{ year }};

            // Format date as YYYY-MM-DD
            const monthStr = String(month).padStart(2, '0');
            const dayStr = String(dayNumber).padStart(2, '0');
            const newDate = `${year}-${monthStr}-${dayStr}`;

            // Update event date via API
            try {
                const formData = new FormData();
                formData.append('event_id', eventId);
                formData.append('new_date', newDate);

                const response = await fetch('{% url "players:move_event_date" %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: formData
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    // Reload the page to show updated calendar
                    window.location.reload();
                } else {
                    alert('Failed to move event: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('An error occurred while moving the event.');
                console.error(error);
            }
        });
    });
}
</script>
{% endblock %}
