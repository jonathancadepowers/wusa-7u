{% extends "base.html" %}
{% load static %}

{% block title %}Calendar - WUSA 7U{% endblock %}

{% block page_title %}WUSA 7U - Calendar{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Admin Action Buttons (only shown if master password cookie exists) -->
    <div id="adminButtons" class="mb-3 d-flex justify-content-end" style="display: none;">
        <button type="button" class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#createEventModal">
            <i class="bi bi-plus-circle"></i> Create Event
        </button>
        <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#modifyEventTypesModal">
            <i class="bi bi-tags"></i> Manage Event Types
        </button>
    </div>

    <!-- FullCalendar Container -->
    <div id="calendar"></div>
</div>

<!-- Create Event Modal -->
<div class="modal fade" id="createEventModal" tabindex="-1" aria-labelledby="createEventModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createEventModalLabel">Create New Event</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger d-none" id="createEventError"></div>
                <form id="createEventForm">
                    <div class="mb-3">
                        <label for="eventName" class="form-label">Event Name *</label>
                        <input type="text" class="form-control" id="eventName" required>
                    </div>
                    <div class="mb-3">
                        <label for="eventType" class="form-label">Event Type *</label>
                        <select class="form-control" id="eventType" required>
                            <option value="">Select event type...</option>
                            {% for event_type in event_types %}
                            <option value="{{ event_type.id }}">{{ event_type.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="eventLocation" class="form-label">Location</label>
                        <input type="text" class="form-control" id="eventLocation">
                    </div>
                    <div class="mb-3">
                        <label for="eventStartDate" class="form-label">Start Date *</label>
                        <input type="date" class="form-control" id="eventStartDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="eventStartTime" class="form-label">Start Time</label>
                        <input type="time" class="form-control" id="eventStartTime">
                    </div>
                    <div class="mb-3">
                        <label for="eventEndDate" class="form-label">End Date (for multi-day events)</label>
                        <input type="date" class="form-control" id="eventEndDate">
                    </div>
                    <div class="mb-3">
                        <label for="eventDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="eventDescription" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="createEventBtn">Create Event</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Event Modal -->
<div class="modal fade" id="editEventModal" tabindex="-1" aria-labelledby="editEventModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editEventModalLabel">Edit Event</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger d-none" id="editEventError"></div>
                <form id="editEventForm">
                    <input type="hidden" id="editEventId">
                    <div class="mb-3">
                        <label for="editEventName" class="form-label">Event Name *</label>
                        <input type="text" class="form-control" id="editEventName" required>
                    </div>
                    <div class="mb-3">
                        <label for="editEventType" class="form-label">Event Type *</label>
                        <select class="form-control" id="editEventType" required>
                            <option value="">Select event type...</option>
                            {% for event_type in event_types %}
                            <option value="{{ event_type.id }}">{{ event_type.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editEventLocation" class="form-label">Location</label>
                        <input type="text" class="form-control" id="editEventLocation">
                    </div>
                    <div class="mb-3">
                        <label for="editEventStartDate" class="form-label">Start Date *</label>
                        <input type="date" class="form-control" id="editEventStartDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="editEventStartTime" class="form-label">Start Time</label>
                        <input type="time" class="form-control" id="editEventStartTime">
                    </div>
                    <div class="mb-3">
                        <label for="editEventEndDate" class="form-label">End Date (for multi-day events)</label>
                        <input type="date" class="form-control" id="editEventEndDate">
                    </div>
                    <div class="mb-3">
                        <label for="editEventDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="editEventDescription" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" id="deleteEventBtn">Delete</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="updateEventBtn">Update Event</button>
            </div>
        </div>
    </div>
</div>

<!-- Manage Event Types Modal (keeping existing functionality) -->
<div class="modal fade" id="modifyEventTypesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Manage Event Types</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <button type="button" class="btn btn-success btn-sm" id="createNewEventTypeBtn">
                        <i class="bi bi-plus-circle"></i> Create New Event Type
                    </button>
                </div>
                <div id="eventTypesList"></div>
            </div>
        </div>
    </div>
</div>

<style>
#calendar {
    max-width: 1200px;
    margin: 0 auto;
}
</style>

<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Check for master password and show admin buttons
    const masterPasswordCookie = document.cookie.split('; ').find(row => row.startsWith('master_password='));
    console.log('Master password cookie:', masterPasswordCookie);
    if (masterPasswordCookie) {
        document.getElementById('adminButtons').style.display = 'flex';
    }

    // Initialize FullCalendar
    const calendarEl = document.getElementById('calendar');
    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        editable: masterPasswordCookie ? true : false,
        selectable: masterPasswordCookie ? true : false,
        selectMirror: true,
        dayMaxEvents: true,
        events: '{% url "players:calendar_events_api" %}',

        // When user clicks on a date (creates new event)
        select: function(info) {
            console.log('Select event triggered:', info);
            const modal = new bootstrap.Modal(document.getElementById('createEventModal'));
            modal.show();
            document.getElementById('eventStartDate').value = info.startStr;
            if (info.endStr && info.endStr !== info.startStr) {
                // Multi-day selection
                const endDate = new Date(info.endStr);
                endDate.setDate(endDate.getDate() - 1); // FullCalendar end is exclusive
                document.getElementById('eventEndDate').value = endDate.toISOString().split('T')[0];
            }
        },

        // When user clicks on an existing event
        eventClick: function(info) {
            console.log('Event clicked:', info.event.id, 'Has master password:', !!masterPasswordCookie);
            if (masterPasswordCookie) {
                loadEventForEdit(info.event.id);
            }
        },

        // When user drags an event to a new date/time
        eventDrop: function(info) {
            console.log('Event dropped:', info.event.id);
            updateEventDateTime(info.event);
        },

        // When user resizes an event
        eventResize: function(info) {
            console.log('Event resized:', info.event.id);
            updateEventDateTime(info.event);
        }
    });

    calendar.render();

    // Create Event
    document.getElementById('createEventBtn').addEventListener('click', async function() {
        const name = document.getElementById('eventName').value;
        const eventType = document.getElementById('eventType').value;
        const location = document.getElementById('eventLocation').value;
        const startDate = document.getElementById('eventStartDate').value;
        const startTime = document.getElementById('eventStartTime').value;
        const endDate = document.getElementById('eventEndDate').value;
        const description = document.getElementById('eventDescription').value;

        if (!name || !eventType || !startDate) {
            alert('Please fill in all required fields');
            return;
        }

        const formData = new FormData();
        formData.append('name', name);
        formData.append('event_type_id', eventType);
        formData.append('location', location);
        formData.append('timestamp', startDate + (startTime ? 'T' + startTime : 'T00:00'));
        if (endDate) formData.append('end_date', endDate);
        formData.append('description', description);

        try {
            const response = await fetch('{% url "players:create_event" %}', {
                method: 'POST',
                headers: {'X-CSRFToken': getCookie('csrftoken')},
                body: formData
            });

            const result = await response.json();
            if (result.success) {
                const modal = bootstrap.Modal.getInstance(document.getElementById('createEventModal'));
                modal.hide();
                calendar.refetchEvents();
                document.getElementById('createEventForm').reset();
            } else {
                document.getElementById('createEventError').textContent = result.error;
                document.getElementById('createEventError').classList.remove('d-none');
            }
        } catch (error) {
            alert('Error creating event: ' + error.message);
        }
    });

    // Load event for editing
    async function loadEventForEdit(eventId) {
        try {
            console.log('Loading event for edit:', eventId);
            const response = await fetch(`{% url "players:get_event" %}?id=${eventId}`);
            const result = await response.json();
            console.log('Get event result:', result);

            if (result.success) {
                const event = result.event;
                document.getElementById('editEventId').value = event.id;
                document.getElementById('editEventName').value = event.name;
                document.getElementById('editEventType').value = event.event_type_id || '';
                document.getElementById('editEventLocation').value = event.location || '';

                const timestamp = new Date(event.timestamp);
                document.getElementById('editEventStartDate').value = timestamp.toISOString().split('T')[0];
                const timeStr = timestamp.toISOString().split('T')[1].substring(0, 5);
                if (timeStr !== '00:00') {
                    document.getElementById('editEventStartTime').value = timeStr;
                }

                document.getElementById('editEventEndDate').value = event.end_date || '';
                document.getElementById('editEventDescription').value = event.description || '';

                const modal = new bootstrap.Modal(document.getElementById('editEventModal'));
                modal.show();
            }
        } catch (error) {
            alert('Error loading event: ' + error.message);
        }
    }

    // Update Event
    document.getElementById('updateEventBtn').addEventListener('click', async function() {
        const eventId = document.getElementById('editEventId').value;
        const name = document.getElementById('editEventName').value;
        const eventType = document.getElementById('editEventType').value;
        const location = document.getElementById('editEventLocation').value;
        const startDate = document.getElementById('editEventStartDate').value;
        const startTime = document.getElementById('editEventStartTime').value;
        const endDate = document.getElementById('editEventEndDate').value;
        const description = document.getElementById('editEventDescription').value;

        const formData = new FormData();
        formData.append('event_id', eventId);
        formData.append('name', name);
        formData.append('event_type_id', eventType);
        formData.append('location', location);
        formData.append('timestamp', startDate + (startTime ? 'T' + startTime : 'T00:00'));
        if (endDate) formData.append('end_date', endDate);
        formData.append('description', description);

        try {
            const response = await fetch('{% url "players:update_event" %}', {
                method: 'POST',
                headers: {'X-CSRFToken': getCookie('csrftoken')},
                body: formData
            });

            const result = await response.json();
            if (result.success) {
                const modal = bootstrap.Modal.getInstance(document.getElementById('editEventModal'));
                modal.hide();
                calendar.refetchEvents();
            } else {
                document.getElementById('editEventError').textContent = result.error;
                document.getElementById('editEventError').classList.remove('d-none');
            }
        } catch (error) {
            alert('Error updating event: ' + error.message);
        }
    });

    // Delete Event
    document.getElementById('deleteEventBtn').addEventListener('click', async function() {
        if (!confirm('Are you sure you want to delete this event?')) return;

        const eventId = document.getElementById('editEventId').value;
        const formData = new FormData();
        formData.append('event_id', eventId);

        try {
            const response = await fetch('{% url "players:delete_event" %}', {
                method: 'POST',
                headers: {'X-CSRFToken': getCookie('csrftoken')},
                body: formData
            });

            const result = await response.json();
            if (result.success) {
                const modal = bootstrap.Modal.getInstance(document.getElementById('editEventModal'));
                modal.hide();
                calendar.refetchEvents();
            } else {
                alert('Error deleting event: ' + result.error);
            }
        } catch (error) {
            alert('Error deleting event: ' + error.message);
        }
    });

    // Update event date/time after drag or resize
    async function updateEventDateTime(event) {
        const formData = new FormData();
        formData.append('event_id', event.id);
        formData.append('timestamp', event.start.toISOString());
        if (event.end) {
            const endDate = new Date(event.end);
            endDate.setDate(endDate.getDate() - 1); // FullCalendar end is exclusive
            formData.append('end_date', endDate.toISOString().split('T')[0]);
        }

        try {
            const response = await fetch('{% url "players:move_event_date" %}', {
                method: 'POST',
                headers: {'X-CSRFToken': getCookie('csrftoken')},
                body: formData
            });

            const result = await response.json();
            if (!result.success) {
                alert('Error moving event: ' + result.error);
                calendar.refetchEvents(); // Revert
            }
        } catch (error) {
            alert('Error moving event: ' + error.message);
            calendar.refetchEvents(); // Revert
        }
    }

    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %}
