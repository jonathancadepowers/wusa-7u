{% extends "base.html" %}

{% block title %}Team Portal - WUSA 7U{% endblock %}

{% block page_title %}WUSA 7U - Team Portal{% endblock %}

{% block content %}
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0"><i class="bi bi-trophy-fill me-2"></i>Select Your Team</h4>
                    </div>
                    <div class="card-body">
                        {% if teams %}
                            <div class="list-group">
                                {% for team in teams %}
                                    <a href="#" class="list-group-item list-group-item-action d-flex align-items-center py-3" onclick="showSecretModal('{{ team.name }}', {{ team.pk }}); return false;">
                                        <div class="me-3 text-primary" style="font-size: 1.5rem;">
                                            <i class="bi bi-shield-lock-fill"></i>
                                        </div>
                                        <div class="flex-grow-1">
                                            <h5 class="mb-0">{{ team.name }}</h5>
                                        </div>
                                        <div class="ms-auto">
                                            <i class="bi bi-chevron-right"></i>
                                        </div>
                                    </a>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                No teams available at this time.
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Team Secret Modal -->
    <div class="modal fade" id="secretModal" tabindex="-1" aria-labelledby="secretModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="secretModalLabel">
                        <i class="bi bi-lock-fill me-2"></i>Enter Team Secret
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted">Team: <strong id="selectedTeamName"></strong></p>
                    <div class="mb-3">
                        <label for="teamSecret" class="form-label">Team Secret</label>
                        <input type="text" class="form-control" id="teamSecret" placeholder="Enter your team secret" autocomplete="off">
                    </div>
                    <div id="errorMessage" class="alert alert-danger d-none">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <span id="errorText"></span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="accessButton" onclick="validateSecret()">
                        <i class="bi bi-unlock-fill me-1"></i>Access Team Page
                    </button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script>
        let currentTeamId = null;
        let secretModal = null;

        document.addEventListener('DOMContentLoaded', function() {
            secretModal = new bootstrap.Modal(document.getElementById('secretModal'));

            // Allow Enter key to submit
            document.getElementById('teamSecret').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    validateSecret();
                }
            });

            // Clear error and input when modal is closed
            document.getElementById('secretModal').addEventListener('hidden.bs.modal', function() {
                document.getElementById('teamSecret').value = '';
                document.getElementById('errorMessage').classList.add('d-none');
            });
        });

        function showSecretModal(teamName, teamId) {
            currentTeamId = teamId;
            document.getElementById('selectedTeamName').textContent = teamName;
            document.getElementById('teamSecret').value = '';
            document.getElementById('errorMessage').classList.add('d-none');
            secretModal.show();

            // Focus on input after modal is shown
            setTimeout(function() {
                document.getElementById('teamSecret').focus();
            }, 500);
        }

        async function validateSecret() {
            const secretInput = document.getElementById('teamSecret');
            const secret = secretInput.value.trim();
            const errorMessage = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            const accessButton = document.getElementById('accessButton');

            if (!secret) {
                errorText.textContent = 'Please enter a team secret.';
                errorMessage.classList.remove('d-none');
                return;
            }

            // Show loading state
            const originalButtonHTML = accessButton.innerHTML;
            accessButton.disabled = true;
            accessButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Validating...';

            // Hide previous errors
            errorMessage.classList.add('d-none');

            try {
                const formData = new FormData();
                formData.append('team_secret', secret);
                formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

                const response = await fetch('/api/validate-team-secret/', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    // Redirect to the team page
                    window.location.href = data.team_url;
                } else {
                    // Show error message
                    errorText.textContent = data.error;
                    errorMessage.classList.remove('d-none');

                    // Reset button
                    accessButton.disabled = false;
                    accessButton.innerHTML = originalButtonHTML;
                }
            } catch (error) {
                errorText.textContent = 'An error occurred. Please try again.';
                errorMessage.classList.remove('d-none');

                // Reset button
                accessButton.disabled = false;
                accessButton.innerHTML = originalButtonHTML;
            }
        }
    </script>
{% endblock %}
