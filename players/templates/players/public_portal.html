{% extends "base.html" %}

{% block title %}Team Portal - WUSA 7U{% endblock %}

{% block page_title %}WUSA 7U - Team Portal{% endblock %}

{% block extra_css %}
<style>
    .hover-card {
        transition: transform 0.2s, box-shadow 0.2s;
        cursor: pointer;
    }
    .hover-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
    }
</style>
{% endblock %}

{% block content %}
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-10">
                <!-- Quick Links Section -->
                <div class="mb-4">
                    <h5 class="mb-3"><i class="bi bi-link-45deg me-2"></i>Quick Links</h5>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <a href="{% url 'players:team_preferences' %}" class="text-decoration-none">
                                <div class="card h-100 shadow-sm hover-card">
                                    <div class="card-body py-2">
                                        <div class="d-flex align-items-center">
                                            <div class="text-primary me-3" style="font-size: 2rem;">
                                                <i class="bi bi-clipboard-check"></i>
                                            </div>
                                            <div>
                                                <h6 class="mb-0">Submit Team Preferences</h6>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </a>
                        </div>
                        <div class="col-md-6">
                            <a href="#" onclick="showManagerDataModal(); return false;" class="text-decoration-none">
                                <div class="card h-100 shadow-sm hover-card">
                                    <div class="card-body py-2">
                                        <div class="d-flex align-items-center">
                                            <div class="text-primary me-3" style="font-size: 2rem;">
                                                <i class="bi bi-people-fill"></i>
                                            </div>
                                            <div>
                                                <h6 class="mb-0">Manager Data</h6>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </a>
                        </div>
                        <div class="col-md-6">
                            <a href="https://docs.google.com/presentation/d/1NdUP0QAdI8vp_TmofHwIEyrsXc5GKPEP8b_yEoDk1VQ/edit?usp=sharing" target="_blank" class="text-decoration-none">
                                <div class="card h-100 shadow-sm hover-card">
                                    <div class="card-body py-2">
                                        <div class="d-flex align-items-center">
                                            <div class="text-primary me-3" style="font-size: 2rem;">
                                                <i class="bi bi-file-earmark-slides"></i>
                                            </div>
                                            <div>
                                                <h6 class="mb-0">Pre-Season Info Deck</h6>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </a>
                        </div>
                        <div class="col-md-6">
                            <a href="https://docs.google.com/spreadsheets/d/1eo7L0w6liR51sMMBjkwuxvdPCPKYLsFR/edit?usp=sharing&ouid=106177974752139787465&rtpof=true&sd=true" target="_blank" class="text-decoration-none">
                                <div class="card h-100 shadow-sm hover-card">
                                    <div class="card-body py-2">
                                        <div class="d-flex align-items-center">
                                            <div class="text-primary me-3" style="font-size: 2rem;">
                                                <i class="bi bi-table"></i>
                                            </div>
                                            <div>
                                                <h6 class="mb-0">Player Data & Eval Template</h6>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </a>
                        </div>
                        <div class="col-md-6">
                            <a href="https://docs.google.com/spreadsheets/d/1Kdw5pIWtB9i2cjqwVGx6Iry5fJgojsUj/edit?usp=sharing&ouid=106177974752139787465&rtpof=true&sd=true" target="_blank" class="text-decoration-none">
                                <div class="card h-100 shadow-sm hover-card">
                                    <div class="card-body py-2">
                                        <div class="d-flex align-items-center">
                                            <div class="text-primary me-3" style="font-size: 2rem;">
                                                <i class="bi bi-clipboard-data"></i>
                                            </div>
                                            <div>
                                                <h6 class="mb-0">Try Out Registrations</h6>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </a>
                        </div>
                        <div class="col-md-6">
                            <a href="https://www.wusa.org/locations" target="_blank" class="text-decoration-none">
                                <div class="card h-100 shadow-sm hover-card">
                                    <div class="card-body py-2">
                                        <div class="d-flex align-items-center">
                                            <div class="text-primary me-3" style="font-size: 2rem;">
                                                <i class="bi bi-geo-alt"></i>
                                            </div>
                                            <div>
                                                <h6 class="mb-0">WUSA Field Locations</h6>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Team Access Section -->
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0"><i class="bi bi-trophy-fill me-2"></i>Select Your Team to Open Its Portal:</h4>
                    </div>
                    <div class="card-body">
                        {% if teams %}
                            <div class="list-group">
                                {% for team in teams %}
                                    <a href="#" class="list-group-item list-group-item-action d-flex align-items-center py-3" onclick="showSecretModal('{{ team.name }}', {{ team.pk }}); return false;">
                                        <div class="me-3 text-primary" style="font-size: 1.5rem;">
                                            <i class="bi bi-shield-lock-fill"></i>
                                        </div>
                                        <div class="flex-grow-1">
                                            <h5 class="mb-0">{{ team.name }}</h5>
                                        </div>
                                        <div class="ms-auto">
                                            <i class="bi bi-chevron-right"></i>
                                        </div>
                                    </a>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                No teams available at this time.
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Team Secret Modal -->
    <div class="modal fade" id="secretModal" tabindex="-1" aria-labelledby="secretModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="secretModalLabel">
                        <i class="bi bi-lock-fill me-2"></i>Enter Team Secret
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted">Team: <strong id="selectedTeamName"></strong></p>
                    <div class="mb-3">
                        <label for="teamSecret" class="form-label">Team Secret</label>
                        <input type="password" class="form-control" id="teamSecret" placeholder="Enter your team secret" autocomplete="off">
                    </div>
                    <div id="errorMessage" class="alert alert-danger d-none">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <span id="errorText"></span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="accessButton" onclick="validateSecret()">
                        <i class="bi bi-unlock-fill me-1"></i>Access Team Page
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Manager Data Modal -->
    <div class="modal fade" id="managerDataModal" tabindex="-1" aria-labelledby="managerDataModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="managerDataModalLabel">
                        <i class="bi bi-people-fill me-2"></i>Manager Data
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        All data below is editable -- just make a change and hit ENTER (no save button). It's critical that we have the correct email/phone for each manager.
                    </div>
                    <div id="managerDataLoading" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                    <div id="managerDataTable" style="display: none;">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Team</th>
                                        <th>Phone</th>
                                        <th>Email</th>
                                    </tr>
                                </thead>
                                <tbody id="managerTableBody">
                                    <!-- Populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script>
        let currentTeamId = null;
        let secretModal = null;

        let managerDataModal = null;

        document.addEventListener('DOMContentLoaded', function() {
            secretModal = new bootstrap.Modal(document.getElementById('secretModal'));
            managerDataModal = new bootstrap.Modal(document.getElementById('managerDataModal'));

            // Allow Enter key to submit
            document.getElementById('teamSecret').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    validateSecret();
                }
            });

            // Clear error and input when modal is closed
            document.getElementById('secretModal').addEventListener('hidden.bs.modal', function() {
                document.getElementById('teamSecret').value = '';
                document.getElementById('errorMessage').classList.add('d-none');
            });
        });

        function showSecretModal(teamName, teamId) {
            currentTeamId = teamId;
            document.getElementById('selectedTeamName').textContent = teamName;
            document.getElementById('teamSecret').value = '';
            document.getElementById('errorMessage').classList.add('d-none');
            secretModal.show();

            // Focus on input after modal is shown
            setTimeout(function() {
                document.getElementById('teamSecret').focus();
            }, 500);
        }

        async function validateSecret() {
            const secretInput = document.getElementById('teamSecret');
            const secret = secretInput.value.trim();
            const errorMessage = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            const accessButton = document.getElementById('accessButton');

            if (!secret) {
                errorText.textContent = 'Please enter a team secret.';
                errorMessage.classList.remove('d-none');
                return;
            }

            // Show loading state
            const originalButtonHTML = accessButton.innerHTML;
            accessButton.disabled = true;
            accessButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Validating...';

            // Hide previous errors
            errorMessage.classList.add('d-none');

            try {
                const formData = new FormData();
                formData.append('team_secret', secret);
                formData.append('team_id', currentTeamId);
                formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

                const response = await fetch('/api/validate-team-secret/', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    // Redirect to the team page
                    window.location.href = data.team_url;
                } else {
                    // Show error message
                    errorText.textContent = data.error;
                    errorMessage.classList.remove('d-none');

                    // Reset button
                    accessButton.disabled = false;
                    accessButton.innerHTML = originalButtonHTML;
                }
            } catch (error) {
                errorText.textContent = 'An error occurred. Please try again.';
                errorMessage.classList.remove('d-none');

                // Reset button
                accessButton.disabled = false;
                accessButton.innerHTML = originalButtonHTML;
            }
        }

        // Manager Data Modal Functions
        async function showManagerDataModal() {
            managerDataModal.show();

            // Show loading state
            document.getElementById('managerDataLoading').style.display = 'block';
            document.getElementById('managerDataTable').style.display = 'none';

            // Load manager data
            try {
                const response = await fetch('/api/managers-list/');
                const data = await response.json();

                if (data.success) {
                    renderManagerTable(data.managers);
                    document.getElementById('managerDataLoading').style.display = 'none';
                    document.getElementById('managerDataTable').style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading managers:', error);
                document.getElementById('managerDataLoading').innerHTML =
                    '<div class="alert alert-danger">Error loading manager data. Please try again.</div>';
            }
        }

        function renderManagerTable(managers) {
            const tbody = document.getElementById('managerTableBody');
            tbody.innerHTML = '';

            managers.forEach(manager => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="editable" data-manager-id="${manager.id}" data-field="name" contenteditable="true">
                        ${manager.name}
                    </td>
                    <td>${manager.team || '-'}</td>
                    <td class="editable" data-manager-id="${manager.id}" data-field="phone" contenteditable="true">
                        ${manager.phone || ''}
                    </td>
                    <td class="editable" data-manager-id="${manager.id}" data-field="email" contenteditable="true">
                        ${manager.email || ''}
                    </td>
                `;
                tbody.appendChild(row);
            });

            // Add event listeners for editable cells
            document.querySelectorAll('.editable').forEach(cell => {
                cell.addEventListener('blur', handleCellEdit);
                cell.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.blur();
                    }
                });
            });
        }

        async function handleCellEdit(event) {
            const cell = event.target;
            const managerId = cell.getAttribute('data-manager-id');
            const field = cell.getAttribute('data-field');
            const newValue = cell.textContent.trim();

            // Show saving indicator
            const originalContent = cell.innerHTML;
            cell.style.opacity = '0.5';

            try {
                const formData = new FormData();
                formData.append('manager_id', managerId);
                formData.append('field', field);
                formData.append('value', newValue);
                formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

                const response = await fetch('/api/update-manager/', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    // Success - flash green
                    cell.style.opacity = '1';
                    cell.style.backgroundColor = '#d4edda';
                    setTimeout(() => {
                        cell.style.backgroundColor = '';
                    }, 1000);
                } else {
                    // Error - flash red and revert
                    cell.style.opacity = '1';
                    cell.style.backgroundColor = '#f8d7da';
                    setTimeout(() => {
                        cell.style.backgroundColor = '';
                    }, 2000);
                    alert('Error saving: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error updating manager:', error);
                cell.style.opacity = '1';
                cell.style.backgroundColor = '#f8d7da';
                setTimeout(() => {
                    cell.style.backgroundColor = '';
                }, 2000);
                alert('Error saving changes. Please try again.');
            }
        }
    </script>
{% endblock %}
