{% extends "base.html" %}
{% load custom_filters %}

{% block title %}{% if is_create %}Create Draft{% else %}Edit Draft{% endif %} - WUSA 7U{% endblock %}

{% block page_title %}WUSA 7U - {% if is_create %}Create Draft{% else %}Edit Draft{% endif %}{% endblock %}

{% block extra_css %}
    <style>
        .team-drop-zone {
            min-height: 100px;
            padding: 10px;
            border: 2px dashed #dee2e6;
            border-radius: 4px;
            flex: 1;
        }
        .draft-order-row {
            display: flex;
            align-items: stretch;
        }
        .draft-order-col {
            display: flex;
        }
        .draft-order-card {
            display: flex;
            flex-direction: column;
            width: 100%;
        }
        .draft-order-card .card-body {
            display: flex;
            flex-direction: column;
            flex: 1;
        }
        .team-item {
            background-color: #fff;
            border: 1px solid #dee2e6;
            padding: 10px 15px;
            margin-bottom: 8px;
            border-radius: 4px;
            cursor: move;
            transition: all 0.2s;
            display: flex;
            align-items: center;
        }
        .team-item:hover {
            background-color: #f8f9fa;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .team-item.dragging {
            visibility: hidden;
        }
        .team-item.drag-over-item {
            margin-top: 50px;
        }
        .team-drop-zone.drag-over {
            background-color: #e3f2fd;
            border-color: #2196f3;
        }
        .rank-badge {
            background-color: #0d6efd;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
            flex-shrink: 0;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="container mt-4">
        <div class="row">
            <div class="col-lg-8 offset-lg-2">
                {% if messages %}
                    {% for message in messages %}
                        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    {% endfor %}
                {% endif %}

                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">
                            <i class="bi bi-calendar-event me-2"></i>
                            {% if is_create %}Create New Draft{% else %}Edit Draft{% endif %}
                        </h4>
                    </div>
                    <div class="card-body">
                        <!-- Draft In Progress Warning -->
                        {% if has_draft_picks %}
                        <div class="alert alert-danger mb-4">
                            <strong>Warning:</strong> There is either a draft currently in progress or the draft has been completed. You cannot modify the draft's settings below while in this state. To modify the draft settings, you must first <a href="#" data-bs-toggle="modal" data-bs-target="#resetDraftModal" class="alert-link">reset the draft</a>.
                        </div>
                        {% endif %}

                        <!-- Try-Out No-Shows Section -->
                        {% if no_show_players %}
                        <h5 class="mb-3">Try-Out No-Shows</h5>

                        <div class="alert alert-info mb-4">
                            <strong>Note:</strong> Select players below who should be marked as "not draftable". As you check/uncheck boxes, the Draft Statistics will update automatically to show how this affects the draft rounds.
                        </div>

                        <div class="card bg-light mb-4">
                            <div class="card-body">
                                <p class="mb-3"><strong>Select players who should be declared NOT draftable:</strong></p>
                                <div class="row">
                                    {% for player in no_show_players %}
                                    <div class="col-md-6 mb-2">
                                        <div class="form-check">
                                            <input
                                                class="form-check-input non-draftable-checkbox"
                                                type="checkbox"
                                                name="non_draftable_players"
                                                value="{{ player.id }}"
                                                id="noshow_{{ player.id }}"
                                                {% if not player.draftable %}checked{% endif %}>
                                            <label class="form-check-label" for="noshow_{{ player.id }}">
                                                {{ player.first_name }} {{ player.last_name }}
                                            </label>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Draft Statistics -->
                        <div class="alert alert-warning mb-4" id="picks-warning-alert" style="display: none;">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>Warning:</strong> Total draft picks (<span id="warning-draft-picks"></span>) does not equal total players (<span id="warning-player-count"></span>). Please review the player counts and draft settings.
                        </div>

                        <div class="card mb-4 bg-light">
                            <div class="card-header bg-secondary text-white">
                                <strong><i class="bi bi-bar-chart me-2"></i>Draft Statistics</strong>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <label class="form-label text-muted fw-bold">1. Draftable Players</label>
                                        <p class="fs-4 mb-1 text-primary" id="stat-draftable-players">{{ draftable_player_count }}</p>
                                        <small class="text-muted">Players with "Draftable" flag = true</small>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label text-muted fw-bold">2. Draftable Rounds</label>
                                        <p class="fs-4 mb-1 text-primary" id="stat-draftable-rounds">{{ draftable_rounds }}</p>
                                        <small class="text-muted" id="stat-draftable-rounds-help">{{ draftable_player_count }} draftable players ÷ {{ team_count }} teams = {{ draftable_rounds }} (rounded down, no partial rounds)</small>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label text-muted fw-bold">3. Non-Draftable Players</label>
                                        <p class="fs-4 mb-1 text-primary" id="stat-nondraftable-players">{{ nondraftable_player_count }}</p>
                                        <small class="text-muted">Players with "Draftable" flag = false</small>
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <label class="form-label text-muted fw-bold">4. Hat Pick Rounds</label>
                                        <p class="fs-4 mb-1 text-primary" id="stat-nondraftable-rounds">{{ nondraftable_rounds }}</p>
                                        <small class="text-muted" id="stat-nondraftable-rounds-help">{% if nondraftable_rounds > 0 %}1 hat pick round exists ({{ nondraftable_player_count }} non-draftable + {{ leftover_draftable_players }} leftover draftable = {{ players_in_final_round }} players){% else %}No hat pick rounds needed{% endif %}</small>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label text-muted fw-bold">5. Players in Hat Pick Round</label>
                                        <p class="fs-4 mb-1 text-primary" id="stat-final-round-players">{{ players_in_final_round }}</p>
                                        <small class="text-muted" id="stat-final-round-players-help">{% if players_in_final_round > 0 %}{{ nondraftable_player_count }} non-draftable + {{ leftover_draftable_players }} leftover draftable = {{ players_in_final_round }} players{% else %}No players in hat pick round{% endif %}</small>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label text-muted fw-bold">6. Total Draft Picks</label>
                                        <p class="fs-4 mb-1 text-primary" id="stat-total-picks">{{ total_draft_picks }}</p>
                                        <small class="text-muted">{{ draftable_rounds }} draftable rounds × {{ team_count }} teams + {{ players_in_final_round }} hat pick players = {{ total_draft_picks }} total picks</small>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-4">
                                        <label class="form-label text-muted fw-bold">7. Total Players</label>
                                        <p class="fs-4 mb-1 text-primary" id="stat-total-players">{{ player_count }}</p>
                                        <small class="text-muted">All players currently in the database</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <form method="post">
                            {% csrf_token %}

                            <!-- Hidden field to preserve picks_per_round value -->
                            <input type="hidden" name="picks_per_round" value="{% if draft %}{{ draft.picks_per_round }}{% else %}{{ suggested_picks_per_round }}{% endif %}">

                            <!-- Draft Order Section -->
                            <h5 class="mb-3">Set Draft Order</h5>

                            <div class="row draft-order-row">
                                <div class="col-md-6 draft-order-col">
                                    <div class="card draft-order-card">
                                        <div class="card-header bg-secondary text-white">
                                            <strong>Available Teams</strong>
                                        </div>
                                        <div class="card-body">
                                            <div id="availableTeams" class="team-drop-zone">
                                                {% for team in all_teams %}
                                                    <div class="team-item" draggable="true" data-team-id="{{ team.id }}">
                                                        <i class="bi bi-grip-vertical me-2"></i>{{ team.name }}
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 draft-order-col">
                                    <div class="card draft-order-card">
                                        <div class="card-header bg-primary text-white">
                                            <strong>Draft Order</strong>
                                        </div>
                                        <div class="card-body">
                                            <div id="draftOrder" class="team-drop-zone">
                                                <!-- Teams will be dropped here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Hidden field to store draft order as comma-separated IDs -->
                            <input type="hidden" id="orderField" name="order" value="">

                            <!-- Final Round Settings Section -->
                            {% if needs_extra_round %}
                            <div class="alert alert-info mb-4">
                                <strong>Note:</strong> Since there are {{ player_count }} total players in the division, and since {{ draft.rounds }} rounds times {{ draft.picks_per_round }} picks per round will result in {{ total_regular_picks }} players drafted, we will need an additional round (a {{ final_round_number|ordinal }} round) wherein only {{ extra_picks_needed }} team{{ extra_picks_needed|pluralize }} will draft a player. These {{ extra_picks_needed }} team{{ extra_picks_needed|pluralize }} will be selected randomly when you click "Save Changes" below.
                            </div>
                            {% endif %}

                            <hr>

                            <h5 class="mb-3">Additional Pre-Draft Tasks</h5>

                            <ul>
                                <li><strong>Draftable Players:</strong> By default, all players are considered eligible for the draft. However, any player that did not attend try-outs should be marked as "not draftable" on the <a href="{% url 'players:list' %}" target="_blank">player's page</a>. If someone attempts to draft an "undraftable" player during the draft, a warning will appear (though a Division Coordinator can override it). Depending on the number of undraftable players there are, use as many picks as necessary at the end of the draft to randomly assign undraftable players to teams (using the "Random Pick" button on the draft page).</li>

                                <li><strong>Declared Players:</strong> There is an exception to the "undraftable" rule described above. Before your draft starts, ask managers to declare any player that did not attend the draft as being "draftable." For each player, have a brief discussion about the player, and ensure their "draftable" flag on the <a href="{% url 'players:list' %}" target="_blank">player's page</a> remains checked.</li>

                                <li><strong>Manager's Daughters:</strong> Based on the <a href="{% url 'players:manager_daughter_rankings_analyze' %}" target="_blank">ranking of managers' daughters</a>, before the draft starts, set all manager's daughter into a fixed draft position (by drafting them on the draft page). The higher ranked a manager's daughter is, the higher their draft position should be. This ensures managers are forced to pick their daughter, at the appropriate time in the draft.</li>
                            </ul>

                            <p class="mt-2"><strong>Do not begin the draft without doing all the above.</strong></p>

                            <div class="mt-4 d-flex justify-content-between">
                                <a href="{% url 'players:settings' %}" class="btn btn-secondary">
                                    <i class="bi bi-arrow-left me-1"></i>Cancel
                                </a>
                                <button type="submit" class="btn btn-primary" {% if has_draft_picks or validation_errors %}disabled{% endif %}>
                                    <i class="bi bi-save me-1"></i>{% if is_create %}Create Draft{% else %}Save Changes{% endif %}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reset Draft Modal -->
    <div class="modal fade" id="resetDraftModal" tabindex="-1" aria-labelledby="resetDraftModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="resetDraftModalLabel">Danger Zone: Reset Draft</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <strong>Warning:</strong> If you proceed, ALL draft picks submitted will be reset, with no record kept of any prior picks.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmResetDraftBtn">Proceed</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script>
        // Initialize Bootstrap tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        })

        // Real-time draft statistics recalculation
        const totalPlayers = {{ player_count }};
        const teamCount = {{ team_count }};

        function recalculateStatistics() {
            // Count checked non-draftable players
            const checkedBoxes = document.querySelectorAll('.non-draftable-checkbox:checked');
            const nondraftableCount = checkedBoxes.length;
            const draftableCount = totalPlayers - nondraftableCount;

            // Calculate draftable rounds (floor division, no partial rounds)
            const draftableRounds = teamCount > 0 ? Math.floor(draftableCount / teamCount) : 0;

            // Calculate leftover draftable players
            const leftoverDraftable = draftableCount - (draftableRounds * teamCount);

            // Calculate non-draftable rounds (hat pick rounds)
            // Hat pick round exists if there are ANY non-draftable or leftover players
            const totalNondraftablePool = nondraftableCount + leftoverDraftable;
            const nondraftableRounds = totalNondraftablePool > 0 ? 1 : 0;

            // Calculate players in final round (hat pick round)
            // If there's a hat pick round, all players in the pool go into that round
            const playersInFinalRound = nondraftableRounds > 0 ? totalNondraftablePool : 0;

            // Calculate total draft picks
            // Draftable rounds are full rounds, hat pick round contains remaining players
            const totalDraftPicks = (draftableRounds * teamCount) + playersInFinalRound;

            // Update the UI
            document.getElementById('stat-draftable-players').textContent = draftableCount;
            document.getElementById('stat-draftable-rounds').textContent = draftableRounds;
            document.getElementById('stat-draftable-rounds-help').textContent =
                `${draftableCount} draftable players ÷ ${teamCount} teams = ${draftableRounds} (rounded down, no partial rounds)`;

            document.getElementById('stat-nondraftable-players').textContent = nondraftableCount;
            document.getElementById('stat-nondraftable-rounds').textContent = nondraftableRounds;
            document.getElementById('stat-nondraftable-rounds-help').textContent = nondraftableRounds > 0
                ? `1 hat pick round exists (${nondraftableCount} non-draftable + ${leftoverDraftable} leftover draftable = ${playersInFinalRound} players)`
                : 'No hat pick rounds needed';

            document.getElementById('stat-final-round-players').textContent = playersInFinalRound;
            document.getElementById('stat-final-round-players-help').textContent = playersInFinalRound > 0
                ? `${nondraftableCount} non-draftable + ${leftoverDraftable} leftover draftable = ${playersInFinalRound} players`
                : 'No players in hat pick round';

            document.getElementById('stat-total-picks').textContent = totalDraftPicks;
            document.getElementById('stat-total-players').textContent = totalPlayers;

            // Update total picks help text
            const totalPicksHelp = document.querySelector('#stat-total-picks + .text-muted');
            if (totalPicksHelp) {
                totalPicksHelp.textContent = `${draftableRounds} draftable rounds × ${teamCount} teams + ${playersInFinalRound} hat pick players = ${totalDraftPicks} total picks`;
            }

            // Show/hide warning
            const warningAlert = document.getElementById('picks-warning-alert');
            if (totalDraftPicks !== totalPlayers) {
                document.getElementById('warning-draft-picks').textContent = totalDraftPicks;
                document.getElementById('warning-player-count').textContent = totalPlayers;
                warningAlert.style.display = 'block';
            } else {
                warningAlert.style.display = 'none';
            }
        }

        // Attach event listeners to checkboxes
        document.addEventListener('DOMContentLoaded', function() {
            const checkboxes = document.querySelectorAll('.non-draftable-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', recalculateStatistics);
            });

            // Initial calculation to ensure warning is shown if needed
            recalculateStatistics();
        });

        // Drag and Drop functionality
        let draggedElement = null;
        let insertBeforeElement = null;

        function initializeDragAndDrop() {
            const teamItems = document.querySelectorAll('.team-item');
            const dropZones = document.querySelectorAll('.team-drop-zone');

            teamItems.forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragend', handleDragEnd);
                item.addEventListener('dragover', handleItemDragOver);
            });

            dropZones.forEach(zone => {
                zone.addEventListener('dragover', handleDragOver);
                zone.addEventListener('drop', handleDrop);
                zone.addEventListener('dragleave', handleDragLeave);
                zone.addEventListener('dragenter', handleDragEnter);
            });
        }

        function handleDragStart(e) {
            draggedElement = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            // Remove any lingering drag-over classes
            document.querySelectorAll('.drag-over').forEach(el => {
                el.classList.remove('drag-over');
            });
            document.querySelectorAll('.drag-over-item').forEach(el => {
                el.classList.remove('drag-over-item');
            });
            insertBeforeElement = null;
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleItemDragOver(e) {
            e.preventDefault();
            e.stopPropagation();

            if (this === draggedElement) {
                return false;
            }

            // Store which element we should insert before
            insertBeforeElement = this;

            // Remove drag-over-item class from all items
            document.querySelectorAll('.team-item').forEach(item => {
                item.classList.remove('drag-over-item');
            });

            // Add class to this item to show visual feedback
            this.classList.add('drag-over-item');

            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e) {
            if (e.target.classList.contains('team-drop-zone')) {
                e.target.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            if (e.target.classList.contains('team-drop-zone')) {
                e.target.classList.remove('drag-over');
            }
        }

        function handleDrop(e) {
            e.stopPropagation();
            e.preventDefault();

            this.classList.remove('drag-over');

            if (!draggedElement) {
                return false;
            }

            // Clone the dragged element
            const clone = draggedElement.cloneNode(true);

            // Remove the dragging class from the clone to ensure visibility
            clone.classList.remove('dragging');

            // Re-add event listeners to the clone
            clone.addEventListener('dragstart', handleDragStart);
            clone.addEventListener('dragend', handleDragEnd);
            clone.addEventListener('dragover', handleItemDragOver);

            // Remove from old location
            draggedElement.remove();

            // If we have a specific insert point, use it; otherwise append to end
            if (insertBeforeElement && insertBeforeElement.parentNode === this) {
                this.insertBefore(clone, insertBeforeElement);
            } else {
                this.appendChild(clone);
            }

            // Update the hidden field and badges
            updateOrderField();
            updateOrderBadges();

            return false;
        }

        function updateOrderField() {
            const draftOrder = document.getElementById('draftOrder');
            const teamItems = draftOrder.querySelectorAll('.team-item');
            const teamIds = Array.from(teamItems).map(item => item.getAttribute('data-team-id'));
            document.getElementById('orderField').value = teamIds.join(',');
        }

        function updateOrderBadges() {
            const draftOrder = document.getElementById('draftOrder');
            const teamItems = draftOrder.querySelectorAll('.team-item');

            teamItems.forEach((item, index) => {
                // Remove existing rank badge if any
                const existingBadge = item.querySelector('.rank-badge');
                if (existingBadge) {
                    existingBadge.remove();
                }

                // Add new rank badge
                const badge = document.createElement('span');
                badge.className = 'rank-badge';
                badge.textContent = index + 1;
                item.insertBefore(badge, item.firstChild);
            });
        }

        // Auto-resize textarea to fit content
        function autoResizeTextarea(textarea) {
            if (!textarea) return;
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        // Initialize existing draft order if editing
        document.addEventListener('DOMContentLoaded', function() {
            const hasDraftPicks = {{ has_draft_picks|yesno:"true,false" }};
            const hasValidationErrors = {{ validation_errors|length }} > 0;

            // Only initialize drag and drop if there are no draft picks and no validation errors
            if (!hasDraftPicks && !hasValidationErrors) {
                initializeDragAndDrop();
            }

            // If there's an existing order, populate the draft order zone
            const existingOrder = {{ ordered_team_ids|safe }};
            if (existingOrder && existingOrder.length > 0) {
                const availableTeams = document.getElementById('availableTeams');
                const draftOrder = document.getElementById('draftOrder');

                existingOrder.forEach(teamId => {
                    const teamItem = availableTeams.querySelector(`[data-team-id="${teamId}"]`);
                    if (teamItem) {
                        draftOrder.appendChild(teamItem);
                    }
                });

                updateOrderField();
                updateOrderBadges();
            }

            // Auto-resize final round order textarea
            const finalRoundTextarea = document.getElementById('finalRoundOrder');
            if (finalRoundTextarea) {
                autoResizeTextarea(finalRoundTextarea);
            }

            // Update order field before form submission
            document.querySelector('form').addEventListener('submit', function(e) {
                updateOrderField();
            });
        });

        // Handle confirm reset draft button
        document.getElementById('confirmResetDraftBtn').addEventListener('click', function() {
            const btn = this;
            btn.disabled = true;
            btn.textContent = 'Resetting...';

            fetch('/draft/reset/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Reload the page to remove the warning
                    window.location.reload();
                } else {
                    alert('Error resetting draft: ' + (data.error || 'Unknown error'));
                    btn.disabled = false;
                    btn.textContent = 'Proceed';
                }
            })
            .catch(error => {
                alert('Error resetting draft');
                console.error('Error:', error);
                btn.disabled = false;
                btn.textContent = 'Proceed';
            });
        });

        // Helper function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
{% endblock %}
