{% extends "base.html" %}

{% block title %}Settings - WUSA 7U{% endblock %}

{% block page_title %}WUSA 7U - Settings{% endblock %}

{% block extra_css %}
    <!-- Quill CSS -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        #emailBodyEditor {
            height: 300px;
            background-color: white;
        }
        .ql-container {
            font-family: inherit;
        }
        .ql-editor p {
            margin-bottom: 0.5em;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0"><i class="bi bi-gear-fill me-2"></i>Application Settings</h4>
                    </div>
                    <div class="card-body">
                        <h5 class="card-title">Draft</h5>

                        <div class="d-flex gap-2">
                            {% if draft_exists %}
                                <a href="{% url 'players:edit_draft' %}" class="btn btn-primary">
                                    <i class="bi bi-pencil me-2"></i>Edit Draft
                                </a>
                                <a href="{% url 'players:run_draft' %}" class="btn btn-success">
                                    <i class="bi bi-play-circle me-2"></i>Run Draft
                                </a>
                            {% else %}
                                <a href="{% url 'players:edit_draft' %}" class="btn btn-success">
                                    <i class="bi bi-plus-circle me-2"></i>Create New Draft
                                </a>
                            {% endif %}
                        </div>

                        <hr class="my-4">

                        <h5 class="card-title">Team Preferences</h5>
                        <p class="text-muted">Analyze manager team preferences and assign managers to teams.</p>

                        <div class="d-flex gap-2">
                            <a href="{% url 'players:team_preferences' %}" class="btn btn-primary">
                                <i class="bi bi-card-checklist me-2"></i>Submission Form
                            </a>
                            <a href="{% url 'players:team_preferences_analyze' %}" class="btn btn-info">
                                <i class="bi bi-bar-chart-fill me-2"></i>Analyze Data
                            </a>
                        </div>

                        <hr class="my-4">

                        <h5 class="card-title">Emails</h5>
                        <p class="text-muted">Send emails to managers for various purposes.</p>

                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#teamPreferencesEmailModal">
                            <i class="bi bi-envelope me-2"></i>Send Team Preferences Email
                        </button>

                        <hr class="my-4">

                        <h5 class="card-title">Player Data Import</h5>
                        <p class="text-muted">Upload an Excel file (.xlsx) to import player data into the database.</p>

                        <form id="importForm" enctype="multipart/form-data">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label for="excelFile" class="form-label">Select Excel File</label>
                                <input class="form-control" type="file" id="excelFile" name="excel_file" accept=".xlsx" required>
                                <div class="form-text">Only .xlsx files are supported</div>
                            </div>

                            <div class="mb-3">
                                <div id="fileInfo" class="alert alert-info d-none">
                                    <i class="bi bi-info-circle me-2"></i>
                                    <span id="fileName"></span>
                                </div>
                            </div>

                            <button type="submit" class="btn btn-primary" id="importBtn">
                                <i class="bi bi-upload me-2"></i>Upload and Import Players
                            </button>
                            <button type="button" class="btn btn-secondary d-none" id="loadingBtn" disabled>
                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                Processing...
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Result Modal -->
    <div class="modal fade" id="resultModal" tabindex="-1" aria-labelledby="resultModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header" id="modalHeader">
                    <h5 class="modal-title" id="resultModalLabel">Import Results</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="modalBody">
                    <!-- Results will be inserted here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Team Preferences Email Modal -->
    <div class="modal fade" id="teamPreferencesEmailModal" tabindex="-1" aria-labelledby="teamPreferencesEmailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="teamPreferencesEmailModalLabel">Manager Email Information</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="allManagerEmails" class="form-label d-flex align-items-center">
                            All Manager Emails
                            <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="copyToClipboard('allManagerEmails')" title="Copy to clipboard">
                                <i class="bi bi-clipboard"></i>
                            </button>
                        </label>
                        <textarea class="form-control" id="allManagerEmails" rows="4" readonly></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="emailBodyEditor" class="form-label d-flex align-items-center">
                            Email Body
                            <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="copyEmailBody()" title="Copy to clipboard">
                                <i class="bi bi-clipboard"></i>
                            </button>
                        </label>
                        <div id="emailBodyEditor"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <!-- Quill JS -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script>
        // Show file name when selected
        document.getElementById('excelFile').addEventListener('change', function(e) {
            const fileInfo = document.getElementById('fileInfo');
            const fileName = document.getElementById('fileName');

            if (this.files.length > 0) {
                fileName.textContent = 'Selected file: ' + this.files[0].name;
                fileInfo.classList.remove('d-none');
            } else {
                fileInfo.classList.add('d-none');
            }
        });

        // Handle form submission
        document.getElementById('importForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const fileInput = document.getElementById('excelFile');
            const importBtn = document.getElementById('importBtn');
            const loadingBtn = document.getElementById('loadingBtn');

            if (!fileInput.files.length) {
                alert('Please select a file');
                return;
            }

            // Show loading state
            importBtn.classList.add('d-none');
            loadingBtn.classList.remove('d-none');

            const formData = new FormData();
            formData.append('excel_file', fileInput.files[0]);
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

            try {
                const response = await fetch('/api/import-players/', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                // Show results in modal
                showResults(data, response.ok);

            } catch (error) {
                showResults({
                    success: false,
                    error: 'Network error: ' + error.message
                }, false);
            } finally {
                // Reset buttons
                importBtn.classList.remove('d-none');
                loadingBtn.classList.add('d-none');

                // Clear file input
                fileInput.value = '';
                document.getElementById('fileInfo').classList.add('d-none');
            }
        });

        function showResults(data, success) {
            const modal = new bootstrap.Modal(document.getElementById('resultModal'));
            const modalHeader = document.getElementById('modalHeader');
            const modalBody = document.getElementById('modalBody');

            if (success && data.success) {
                // Success
                modalHeader.className = 'modal-header bg-success text-white';
                modalBody.innerHTML = `
                    <div class="alert alert-success">
                        <h5><i class="bi bi-check-circle-fill me-2"></i>Import Successful!</h5>
                    </div>
                    <table class="table">
                        <tbody>
                            <tr>
                                <th>Total Rows in Excel:</th>
                                <td>${data.total_rows}</td>
                            </tr>
                            <tr>
                                <th>Successfully Imported:</th>
                                <td class="text-success fw-bold">${data.imported}</td>
                            </tr>
                            <tr>
                                <th>Errors/Skipped:</th>
                                <td class="${data.errors.length > 0 ? 'text-warning' : 'text-muted'} fw-bold">${data.errors.length}</td>
                            </tr>
                            <tr>
                                <th>Total Players in Database:</th>
                                <td class="text-primary fw-bold">${data.total_players}</td>
                            </tr>
                        </tbody>
                    </table>
                    ${data.errors.length > 0 ? `
                        <div class="mt-3">
                            <h6>Errors:</h6>
                            <div class="alert alert-warning">
                                <ul class="mb-0">
                                    ${data.errors.map(err => `<li>Row ${err.row}: ${err.name} - ${err.error}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    ` : ''}
                `;
            } else {
                // Error
                modalHeader.className = 'modal-header bg-danger text-white';
                modalBody.innerHTML = `
                    <div class="alert alert-danger">
                        <h5><i class="bi bi-exclamation-triangle-fill me-2"></i>Import Failed</h5>
                        <p class="mb-0">${data.error || 'An unknown error occurred'}</p>
                    </div>
                `;
            }

            modal.show();
        }

        // Team Preferences Email Modal
        let quillEditor = null;

        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Quill
            quillEditor = new Quill('#emailBodyEditor', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline'],
                        ['link'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        ['clean']
                    ]
                }
            });

            // Set default email body and load manager emails when modal opens
            const teamPreferencesModal = document.getElementById('teamPreferencesEmailModal');
            teamPreferencesModal.addEventListener('show.bs.modal', function() {
                // Set default email body
                if (quillEditor && quillEditor.root.innerHTML === '<p><br></p>') {
                    const currentDomain = window.location.origin;
                    const defaultHtml = `<p>Hello WUSA Managers-</p><p>As mentioned, we need to collect your preferences for team names. To submit your choices, go to the following URL: <a href="${currentDomain}/team_preferences/" target="_blank">${currentDomain}/team_preferences/</a></p><p>Please have your choices submitted within the next 24 hours, and let us know if you have any questions.</p><p>Thanks,<br>-Your Division Managers</p>`;
                    quillEditor.root.innerHTML = defaultHtml;
                }

                // Load all manager emails
                fetch('{% url "players:get_manager_emails" %}')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            document.getElementById('allManagerEmails').value = data.emails.join(', ');
                        }
                    })
                    .catch(error => {
                        console.error('Error loading manager emails:', error);
                    });
            });
        });

        // Copy to clipboard functions
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            element.select();
            document.execCommand('copy');

            // Visual feedback
            const btn = event.target.closest('button');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-check"></i>';
            setTimeout(() => {
                btn.innerHTML = originalHTML;
            }, 1500);
        }

        function copyEmailBody() {
            if (quillEditor) {
                // Get HTML content from Quill
                const html = quillEditor.root.innerHTML;

                // Create temporary textarea to copy HTML
                const tempTextarea = document.createElement('textarea');
                tempTextarea.value = html;
                document.body.appendChild(tempTextarea);
                tempTextarea.select();
                document.execCommand('copy');
                document.body.removeChild(tempTextarea);

                // Visual feedback
                const btn = event.target.closest('button');
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<i class="bi bi-check"></i>';
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                }, 1500);
            }
        }
    </script>
{% endblock %}
