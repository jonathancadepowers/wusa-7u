{% extends "base.html" %}

{% block title %}Settings - WUSA 7U{% endblock %}

{% block page_title %}WUSA 7U - Settings{% endblock %}

{% block extra_css %}
    <!-- Quill CSS -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        #emailBodyEditor {
            height: 300px;
            background-color: white;
        }
        .ql-container {
            font-family: inherit;
        }
        .ql-editor p {
            margin-bottom: 0.5em;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0"><i class="bi bi-gear-fill me-2"></i>Application Settings</h4>
                    </div>
                    <div class="card-body">
                        <h5 class="card-title">Division Setup</h5>
                        <p class="text-muted">Complete the division setup steps to prepare for the season.</p>

                        <div class="d-flex gap-2">
                            <a href="{% url 'players:division_setup_checklist' %}" class="btn btn-primary">
                                <i class="bi bi-list-check me-2"></i>Checklist
                            </a>
                        </div>

                        <hr class="my-4">

                        <h5 class="card-title" id="player-data-import">Player Data Import</h5>
                        <p class="text-muted">Upload the player registration Excel file exported out of TeamSideline to import player data.</p>

                        <form id="importForm" enctype="multipart/form-data">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label for="excelFile" class="form-label">Select Excel File</label>
                                <input class="form-control" type="file" id="excelFile" name="excel_file" accept=".xlsx,.xls" required>
                                <div class="form-text">Both .xlsx and .xls files are supported</div>
                            </div>

                            <div class="mb-3">
                                <div id="fileInfo" class="alert alert-info d-none">
                                    <i class="bi bi-info-circle me-2"></i>
                                    <span id="fileName"></span>
                                </div>
                            </div>

                            <button type="submit" class="btn btn-primary" id="importBtn">
                                <i class="bi bi-upload me-2"></i>Upload and Import Players
                            </button>
                            <button type="button" class="btn btn-secondary d-none" id="loadingBtn" disabled>
                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                Processing...
                            </button>
                        </form>

                        <hr class="my-4">

                        <h5 class="card-title">Team Preferences</h5>
                        <p class="text-muted">Analyze manager team preferences and assign managers to teams.</p>

                        <div class="d-flex gap-2">
                            <a href="{% url 'players:team_preferences' %}" class="btn btn-primary">
                                <i class="bi bi-card-checklist me-2"></i>Submission Form
                            </a>
                            <a href="{% url 'players:team_preferences_analyze' %}" class="btn btn-info">
                                <i class="bi bi-bar-chart-fill me-2"></i>Analyze Data
                            </a>
                        </div>

                        <hr class="my-4">

                        <h5 class="card-title" id="emails">Emails</h5>
                        <p class="text-muted">Send emails to managers for various purposes.</p>

                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#teamPreferencesEmailModal">
                                <i class="bi bi-envelope me-2"></i>Send Team Preferences Email
                            </button>
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#teamPagesEmailModal">
                                <i class="bi bi-envelope me-2"></i>Send Team Pages to Managers
                            </button>
                        </div>

                        <hr class="my-4">

                        <h5 class="card-title">Practice Slots</h5>
                        <p class="text-muted">Manage available practice slot times.</p>

                        <a href="{% url 'players:manage_practice_slots' %}" class="btn btn-primary">
                            <i class="bi bi-calendar-week me-2"></i>Manage Slots
                        </a>
                        <a href="{% url 'players:practice_slots_analyze' %}" class="btn btn-info ms-2">
                            <i class="bi bi-graph-up me-2"></i>Analyze Data
                        </a>
                        <a href="{% url 'players:pre_season_practice_slot_selector' %}" class="btn btn-success ms-2">
                            <i class="bi bi-shuffle me-2"></i>Random Selection Order
                        </a>

                        <hr class="my-4">

                        <h5 class="card-title">Draft</h5>

                        <div class="d-flex gap-2 flex-wrap">
                            {% if draft_exists %}
                                <a href="{% url 'players:edit_draft' %}" class="btn btn-primary">
                                    <i class="bi bi-pencil me-2"></i>Edit Draft
                                </a>
                                <a href="{% url 'players:run_draft' %}" class="btn btn-success">
                                    <i class="bi bi-play-circle me-2"></i>Run Draft
                                </a>
                            {% else %}
                                <a href="{% url 'players:edit_draft' %}" class="btn btn-success">
                                    <i class="bi bi-plus-circle me-2"></i>Create New Draft
                                </a>
                            {% endif %}
                            <a href="{% url 'players:player_rankings_analyze' %}" class="btn btn-info">
                                <i class="bi bi-bar-chart-fill me-2"></i>Analyze Manager Rankings
                            </a>
                            <a href="{% url 'players:manager_daughter_rankings_analyze' %}" class="btn btn-info">
                                <i class="bi bi-bar-chart-fill me-2"></i>Analyze Manager Daughter Rankings
                            </a>
                            <a href="{% url 'players:sibling_rankings_analyze' %}" class="btn btn-info">
                                <i class="bi bi-bar-chart-fill me-2"></i>Analyze Sibling Rankings
                            </a>
                            <a href="{% url 'players:try_out_check_in' %}" class="btn btn-secondary">
                                <i class="bi bi-clipboard-check me-2"></i>Try Out Check In Form
                            </a>
                        </div>

                        <hr class="my-4">

                        <h5 class="card-title">Developer Settings</h5>
                        <p class="text-muted">Advanced settings for developers and administrators.</p>

                        <div class="row g-2">
                            <div class="col-auto">
                                <a href="{% url 'players:division_validation_registry' %}" class="btn btn-secondary">
                                    <i class="bi bi-diagram-3 me-2"></i>Validation Registry
                                </a>
                            </div>
                            <div class="col-auto">
                                <button id="exportDivisionConfigBtn" class="btn btn-primary">
                                    <i class="bi bi-download me-2"></i>Export Division Configuration
                                </button>
                            </div>
                            <div class="col-auto">
                                <button id="importDivisionConfigBtn" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#importConfigModal">
                                    <i class="bi bi-upload me-2"></i>Import Division Configuration
                                </button>
                            </div>
                            <div class="col-auto">
                                <button id="masterPasswordBtn" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#masterPasswordModal">
                                    <i class="bi bi-key me-2"></i>Master Password
                                </button>
                            </div>
                            <div class="col-auto">
                                <button id="removeCookieBtn" class="btn btn-danger">
                                    <i class="bi bi-trash me-2"></i>Remove Master Password Cookie
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Master Password Modal -->
    <div class="modal fade" id="masterPasswordModal" tabindex="-1" aria-labelledby="masterPasswordModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="masterPasswordModalLabel">Master Password Settings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info" role="alert">
                        <i class="bi bi-info-circle-fill me-2"></i>
                        The master password provides administrative access to various features of the application.
                    </div>

                    <div class="mb-3">
                        <label for="currentMasterPasswordDisplay" class="form-label">Current Master Password</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="currentMasterPasswordDisplay" readonly>
                            <button class="btn btn-outline-secondary" type="button" id="togglePasswordBtn">
                                <i class="bi bi-eye" id="togglePasswordIcon"></i>
                            </button>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="newMasterPassword" class="form-label">New Master Password</label>
                        <input type="text" class="form-control" id="newMasterPassword" placeholder="Enter new master password">
                        <div class="form-text">Leave blank to keep current password unchanged.</div>
                    </div>

                    <div id="masterPasswordStatusSection" style="display: none;">
                        <!-- Status messages will be displayed here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveMasterPasswordBtn">
                        <i class="bi bi-save me-2"></i>Save Password
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Division Configuration Modal -->
    <div class="modal fade" id="importConfigModal" tabindex="-1" aria-labelledby="importConfigModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="importConfigModalLabel">Import Division Configuration</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning" role="alert">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <strong>Warning:</strong> Uploading a configuration file will <strong>permanently delete</strong> all existing records in the following tables:
                        <ul class="mt-2 mb-0">
                            <li>Validation Code</li>
                            <li>Division Validation Registry</li>
                            <li>General Settings</li>
                        </ul>
                        <p class="mt-2 mb-0">These tables will then be repopulated with the data from the uploaded file. This action cannot be undone.</p>
                    </div>

                    <div id="importFileUploadSection">
                        <div class="mb-3">
                            <label for="configFileInput" class="form-label">Select Configuration File (JSON)</label>
                            <input type="file" class="form-control" id="configFileInput" accept=".json">
                            <div class="form-text">Upload a JSON file exported from another instance of this application.</div>
                        </div>
                    </div>

                    <div id="importStatusSection" style="display: none;">
                        <!-- Status messages will be displayed here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmImportBtn" disabled>
                        <i class="bi bi-upload me-2"></i>Confirm Import
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Result Modal -->
    <div class="modal fade" id="resultModal" tabindex="-1" aria-labelledby="resultModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header" id="modalHeader">
                    <h5 class="modal-title" id="resultModalLabel">Import Results</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="modalBody">
                    <!-- Results will be inserted here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Team Preferences Email Modal -->
    <div class="modal fade" id="teamPreferencesEmailModal" tabindex="-1" aria-labelledby="teamPreferencesEmailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="teamPreferencesEmailModalLabel">Manager Email Information</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info mb-3" role="alert">
                        <strong>Note:</strong> Copy and paste the details below into your email application and send the email from there.
                    </div>
                    <div class="mb-3">
                        <label for="allManagerEmails" class="form-label d-flex align-items-center">
                            All Manager Emails
                            <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="copyToClipboard('allManagerEmails')" title="Copy to clipboard">
                                <i class="bi bi-clipboard"></i>
                            </button>
                        </label>
                        <textarea class="form-control" id="allManagerEmails" rows="4" readonly></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="emailBodyEditor" class="form-label d-flex align-items-center">
                            Email Body
                            <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="copyEmailBody()" title="Copy to clipboard">
                                <i class="bi bi-clipboard"></i>
                            </button>
                        </label>
                        <div id="emailBodyEditor"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Team Pages Email Modal -->
    <div class="modal fade" id="teamPagesEmailModal" tabindex="-1" aria-labelledby="teamPagesEmailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="teamPagesEmailModalLabel">Team Pages Email Information</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info mb-3" role="alert">
                        <strong>Note:</strong> Copy and paste the details below into your email application and send the email from there.
                    </div>
                    <div class="mb-3">
                        <label for="allManagerEmailsTeamPages" class="form-label d-flex align-items-center">
                            All Manager Emails
                            <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="copyToClipboard('allManagerEmailsTeamPages')" title="Copy to clipboard">
                                <i class="bi bi-clipboard"></i>
                            </button>
                        </label>
                        <textarea class="form-control" id="allManagerEmailsTeamPages" rows="4" readonly></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="teamPagesEmailBodyEditor" class="form-label d-flex align-items-center">
                            Email Body
                            <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="copyTeamPagesEmailBody()" title="Copy to clipboard">
                                <i class="bi bi-clipboard"></i>
                            </button>
                        </label>
                        <div id="teamPagesEmailBodyEditor"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block extra_js %}
    <!-- Quill JS -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script>
        // Show file name when selected
        document.getElementById('excelFile').addEventListener('change', function(e) {
            const fileInfo = document.getElementById('fileInfo');
            const fileName = document.getElementById('fileName');

            if (this.files.length > 0) {
                fileName.textContent = 'Selected file: ' + this.files[0].name;
                fileInfo.classList.remove('d-none');
            } else {
                fileInfo.classList.add('d-none');
            }
        });

        // Handle form submission
        document.getElementById('importForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const fileInput = document.getElementById('excelFile');
            const importBtn = document.getElementById('importBtn');
            const loadingBtn = document.getElementById('loadingBtn');

            if (!fileInput.files.length) {
                alert('Please select a file');
                return;
            }

            // Show loading state
            importBtn.classList.add('d-none');
            loadingBtn.classList.remove('d-none');

            const formData = new FormData();
            formData.append('excel_file', fileInput.files[0]);
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

            try {
                const response = await fetch('/api/import-players/', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                // Show results in modal
                showResults(data, response.ok);

            } catch (error) {
                showResults({
                    success: false,
                    error: 'Network error: ' + error.message
                }, false);
            } finally {
                // Reset buttons
                importBtn.classList.remove('d-none');
                loadingBtn.classList.add('d-none');

                // Clear file input
                fileInput.value = '';
                document.getElementById('fileInfo').classList.add('d-none');
            }
        });

        function showResults(data, success) {
            const modal = new bootstrap.Modal(document.getElementById('resultModal'));
            const modalHeader = document.getElementById('modalHeader');
            const modalBody = document.getElementById('modalBody');

            if (success && data.success) {
                // Success
                modalHeader.className = 'modal-header bg-success text-white';
                modalBody.innerHTML = `
                    <div class="alert alert-success">
                        <h5><i class="bi bi-check-circle-fill me-2"></i>Import Successful!</h5>
                    </div>
                    <table class="table">
                        <tbody>
                            <tr>
                                <th>Total Rows in Excel:</th>
                                <td>${data.total_rows}</td>
                            </tr>
                            <tr>
                                <th>Successfully Imported:</th>
                                <td class="text-success fw-bold">${data.imported}</td>
                            </tr>
                            <tr>
                                <th>Errors/Skipped:</th>
                                <td class="${data.errors.length > 0 ? 'text-warning' : 'text-muted'} fw-bold">${data.errors.length}</td>
                            </tr>
                            <tr>
                                <th>Total Players in Database:</th>
                                <td class="text-primary fw-bold">${data.total_players}</td>
                            </tr>
                        </tbody>
                    </table>
                    ${data.errors.length > 0 ? `
                        <div class="mt-3">
                            <h6>Errors:</h6>
                            <div class="alert alert-warning">
                                <ul class="mb-0">
                                    ${data.errors.map(err => `<li>Row ${err.row}: ${err.name} - ${err.error}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    ` : ''}
                `;
            } else {
                // Error
                modalHeader.className = 'modal-header bg-danger text-white';
                modalBody.innerHTML = `
                    <div class="alert alert-danger">
                        <h5><i class="bi bi-exclamation-triangle-fill me-2"></i>Import Failed</h5>
                        <p class="mb-0">${data.error || 'An unknown error occurred'}</p>
                    </div>
                `;
            }

            modal.show();
        }

        // Team Preferences Email Modal
        let quillEditor = null;
        let teamPagesQuillEditor = null;

        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Quill for Team Preferences
            quillEditor = new Quill('#emailBodyEditor', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline'],
                        ['link'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        ['clean']
                    ]
                }
            });

            // Initialize Quill for Team Pages
            teamPagesQuillEditor = new Quill('#teamPagesEmailBodyEditor', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline'],
                        ['link'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        ['clean']
                    ]
                }
            });

            // Set default email body and load manager emails for Team Preferences modal
            const teamPreferencesModal = document.getElementById('teamPreferencesEmailModal');
            teamPreferencesModal.addEventListener('show.bs.modal', function() {
                // Set default email body
                if (quillEditor && quillEditor.root.innerHTML === '<p><br></p>') {
                    const currentDomain = window.location.origin;
                    const defaultHtml = `<p>Hello WUSA Managers-</p><p>As mentioned, we need to collect your preferences for team names. To submit your choices, go to the following URL: <a href="${currentDomain}/team_preferences/" target="_blank">${currentDomain}/team_preferences/</a></p><p>Please have your choices submitted within the next 24 hours, and let us know if you have any questions.</p><p>Thanks,</p><p>-Your Division Managers</p>`;
                    quillEditor.root.innerHTML = defaultHtml;
                }

                // Load all manager emails
                fetch('{% url "players:get_manager_emails" %}')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            document.getElementById('allManagerEmails').value = data.emails.join(', ');
                        }
                    })
                    .catch(error => {
                        console.error('Error loading manager emails:', error);
                    });
            });

            // Set default email body and load manager emails for Team Pages modal
            const teamPagesModal = document.getElementById('teamPagesEmailModal');
            teamPagesModal.addEventListener('show.bs.modal', function() {
                // Set default email body
                if (teamPagesQuillEditor && teamPagesQuillEditor.root.innerHTML === '<p><br></p>') {
                    const currentDomain = window.location.origin;
                    const defaultHtml = `<p>Hello WUSA Managers-</p><p>As mentioned, we've created a basic website where you can view your team roster and perform other tasks. To access it, go here: <a href="${currentDomain}/public_portal/" target="_blank">${currentDomain}/public_portal/</a></p><p>Select your team and, when prompted, enter the "Team Secret" that was provided to you by your Division Manager.</p><p>Once you view your dashboard, complete the tasks listed at the top.</p><p>Thanks,</p><p>-Your Division Managers</p>`;
                    teamPagesQuillEditor.root.innerHTML = defaultHtml;
                }

                // Load all manager emails
                fetch('{% url "players:get_manager_emails" %}')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            document.getElementById('allManagerEmailsTeamPages').value = data.emails.join(', ');
                        }
                    })
                    .catch(error => {
                        console.error('Error loading manager emails:', error);
                    });
            });
        });

        // Copy to clipboard functions
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            element.select();
            document.execCommand('copy');

            // Visual feedback
            const btn = event.target.closest('button');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-check"></i>';
            setTimeout(() => {
                btn.innerHTML = originalHTML;
            }, 1500);
        }

        function copyEmailBody() {
            if (quillEditor) {
                // Get HTML content from Quill
                const html = quillEditor.root.innerHTML;

                // Use Clipboard API if available, otherwise fall back to execCommand
                if (navigator.clipboard && navigator.clipboard.write) {
                    const blob = new Blob([html], { type: 'text/html' });
                    const clipboardItem = new ClipboardItem({
                        'text/html': blob,
                        'text/plain': new Blob([quillEditor.getText()], { type: 'text/plain' })
                    });
                    navigator.clipboard.write([clipboardItem]).then(() => {
                        // Visual feedback
                        const btn = event.target.closest('button');
                        const originalHTML = btn.innerHTML;
                        btn.innerHTML = '<i class="bi bi-check"></i>';
                        setTimeout(() => {
                            btn.innerHTML = originalHTML;
                        }, 1500);
                    });
                } else {
                    // Fallback for older browsers
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = html;
                    tempDiv.style.position = 'absolute';
                    tempDiv.style.left = '-9999px';
                    document.body.appendChild(tempDiv);

                    const range = document.createRange();
                    range.selectNodeContents(tempDiv);
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);

                    document.execCommand('copy');
                    document.body.removeChild(tempDiv);

                    // Visual feedback
                    const btn = event.target.closest('button');
                    const originalHTML = btn.innerHTML;
                    btn.innerHTML = '<i class="bi bi-check"></i>';
                    setTimeout(() => {
                        btn.innerHTML = originalHTML;
                    }, 1500);
                }
            }
        }

        function copyTeamPagesEmailBody() {
            if (teamPagesQuillEditor) {
                // Get HTML content from Quill
                const html = teamPagesQuillEditor.root.innerHTML;

                // Use Clipboard API if available, otherwise fall back to execCommand
                if (navigator.clipboard && navigator.clipboard.write) {
                    const blob = new Blob([html], { type: 'text/html' });
                    const clipboardItem = new ClipboardItem({
                        'text/html': blob,
                        'text/plain': new Blob([teamPagesQuillEditor.getText()], { type: 'text/plain' })
                    });
                    navigator.clipboard.write([clipboardItem]).then(() => {
                        // Visual feedback
                        const btn = event.target.closest('button');
                        const originalHTML = btn.innerHTML;
                        btn.innerHTML = '<i class="bi bi-check"></i>';
                        setTimeout(() => {
                            btn.innerHTML = originalHTML;
                        }, 1500);
                    });
                } else {
                    // Fallback for older browsers
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = html;
                    tempDiv.style.position = 'absolute';
                    tempDiv.style.left = '-9999px';
                    document.body.appendChild(tempDiv);

                    const range = document.createRange();
                    range.selectNodeContents(tempDiv);
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);

                    document.execCommand('copy');
                    document.body.removeChild(tempDiv);

                    // Visual feedback
                    const btn = event.target.closest('button');
                    const originalHTML = btn.innerHTML;
                    btn.innerHTML = '<i class="bi bi-check"></i>';
                    setTimeout(() => {
                        btn.innerHTML = originalHTML;
                    }, 1500);
                }
            }
        }

        // Export Division Configuration button handler
        document.getElementById('exportDivisionConfigBtn').addEventListener('click', async function() {
            const btn = this;
            const originalHTML = btn.innerHTML;

            try {
                // Show loading state
                btn.disabled = true;
                btn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Exporting...';

                // Call the export API
                const response = await fetch('{% url "players:export_division_configuration" %}', {
                    method: 'GET',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                });

                if (!response.ok) {
                    throw new Error('Export failed');
                }

                // Get the JSON data and trigger download
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `division_configuration_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                // Show success state
                btn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Exported!';
                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = originalHTML;
                }, 2000);

            } catch (error) {
                console.error('Export error:', error);
                btn.innerHTML = '<i class="bi bi-x-circle me-2"></i>Export Failed';
                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = originalHTML;
                }, 2000);
            }
        });

        // Import Division Configuration modal handler
        let selectedConfigFile = null;
        let validatedConfigData = null;

        // File input change handler
        document.getElementById('configFileInput').addEventListener('change', async function(event) {
            const file = event.target.files[0];
            const confirmBtn = document.getElementById('confirmImportBtn');
            const statusSection = document.getElementById('importStatusSection');

            if (!file) {
                confirmBtn.disabled = true;
                selectedConfigFile = null;
                validatedConfigData = null;
                statusSection.style.display = 'none';
                return;
            }

            selectedConfigFile = file;

            try {
                // Read and parse the file
                const fileContent = await file.text();
                const configData = JSON.parse(fileContent);

                // Validate the JSON structure
                const isValid = validateConfigStructure(configData);

                if (isValid) {
                    validatedConfigData = configData;
                    confirmBtn.disabled = false;

                    // Show success message
                    statusSection.style.display = 'block';
                    statusSection.innerHTML = `
                        <div class="alert alert-success" role="alert">
                            <i class="bi bi-check-circle-fill me-2"></i>
                            <strong>File validated successfully!</strong>
                            <p class="mb-0 mt-2">Found:</p>
                            <ul class="mb-0">
                                <li>${configData.validation_codes?.length || 0} validation code(s)</li>
                                <li>${configData.division_validation_registry?.length || 0} division validation registry record(s)</li>
                                <li>${configData.general_settings?.length || 0} general setting(s)</li>
                            </ul>
                        </div>
                    `;
                } else {
                    throw new Error('Invalid configuration file structure');
                }

            } catch (error) {
                confirmBtn.disabled = true;
                validatedConfigData = null;

                // Show error message
                statusSection.style.display = 'block';
                statusSection.innerHTML = `
                    <div class="alert alert-danger" role="alert">
                        <i class="bi bi-x-circle-fill me-2"></i>
                        <strong>Invalid file format</strong>
                        <p class="mb-0 mt-2">The uploaded file is not a valid division configuration file. Please ensure you're uploading a JSON file exported from this application.</p>
                        <p class="mb-0 mt-2"><small>Error: ${error.message}</small></p>
                    </div>
                `;
            }
        });

        // Validate configuration file structure
        function validateConfigStructure(data) {
            // Check for required top-level keys
            if (!data.validation_codes || !data.division_validation_registry || !data.general_settings) {
                return false;
            }

            // Check that they are arrays
            if (!Array.isArray(data.validation_codes) ||
                !Array.isArray(data.division_validation_registry) ||
                !Array.isArray(data.general_settings)) {
                return false;
            }

            // Validate validation_codes structure
            if (data.validation_codes.length > 0) {
                const validationCodeSample = data.validation_codes[0];
                if (!validationCodeSample.code || validationCodeSample.value === undefined) {
                    return false;
                }
            }

            // Validate division_validation_registry structure
            if (data.division_validation_registry.length > 0) {
                const registrySample = data.division_validation_registry[0];
                if (!registrySample.page) {
                    return false;
                }
            }

            // Validate general_settings structure
            if (data.general_settings.length > 0) {
                const settingSample = data.general_settings[0];
                if (!settingSample.key || !settingSample.value) {
                    return false;
                }
            }

            return true;
        }

        // Confirm import button handler
        document.getElementById('confirmImportBtn').addEventListener('click', async function() {
            const btn = this;
            const originalHTML = btn.innerHTML;
            const statusSection = document.getElementById('importStatusSection');

            if (!validatedConfigData) {
                return;
            }

            try {
                // Show loading state
                btn.disabled = true;
                btn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Importing...';

                // Create FormData and send to server
                const formData = new FormData();
                formData.append('config_data', JSON.stringify(validatedConfigData));

                const response = await fetch('{% url "players:import_division_configuration" %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    // Show success message
                    statusSection.innerHTML = `
                        <div class="alert alert-success" role="alert">
                            <i class="bi bi-check-circle-fill me-2"></i>
                            <strong>Import successful!</strong>
                            <p class="mb-0 mt-2">Configuration has been imported successfully:</p>
                            <ul class="mb-0">
                                <li>${result.imported_counts?.validation_codes || 0} validation code(s) imported</li>
                                <li>${result.imported_counts?.division_validation_registry || 0} division validation registry record(s) imported</li>
                                <li>${result.imported_counts?.general_settings || 0} general setting(s) imported</li>
                            </ul>
                        </div>
                    `;

                    // Reset file input
                    document.getElementById('configFileInput').value = '';
                    selectedConfigFile = null;
                    validatedConfigData = null;
                    btn.disabled = true;
                    btn.innerHTML = originalHTML;

                    // Close modal after 2 seconds
                    setTimeout(() => {
                        bootstrap.Modal.getInstance(document.getElementById('importConfigModal')).hide();
                        statusSection.style.display = 'none';
                    }, 2000);

                } else {
                    throw new Error(result.message || 'Import failed');
                }

            } catch (error) {
                statusSection.innerHTML = `
                    <div class="alert alert-danger" role="alert">
                        <i class="bi bi-x-circle-fill me-2"></i>
                        <strong>Import failed</strong>
                        <p class="mb-0 mt-2">${error.message}</p>
                    </div>
                `;
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        });

        // Reset modal when closed
        document.getElementById('importConfigModal').addEventListener('hidden.bs.modal', function() {
            document.getElementById('configFileInput').value = '';
            document.getElementById('importStatusSection').style.display = 'none';
            document.getElementById('confirmImportBtn').disabled = true;
            selectedConfigFile = null;
            validatedConfigData = null;
        });

        // Master Password modal handler
        let currentMasterPassword = '';

        // Load current master password when modal opens
        document.getElementById('masterPasswordModal').addEventListener('show.bs.modal', async function() {
            const statusSection = document.getElementById('masterPasswordStatusSection');
            statusSection.style.display = 'none';

            try {
                const response = await fetch('{% url "players:get_master_password" %}', {
                    method: 'GET',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    currentMasterPassword = result.password || '';
                    document.getElementById('currentMasterPasswordDisplay').value = currentMasterPassword;
                } else {
                    currentMasterPassword = '';
                    document.getElementById('currentMasterPasswordDisplay').value = 'Not set';
                }
            } catch (error) {
                console.error('Error loading master password:', error);
                currentMasterPassword = '';
                document.getElementById('currentMasterPasswordDisplay').value = 'Error loading';
            }

            // Clear new password field
            document.getElementById('newMasterPassword').value = '';
        });

        // Toggle password visibility
        document.getElementById('togglePasswordBtn').addEventListener('click', function() {
            const passwordInput = document.getElementById('currentMasterPasswordDisplay');
            const icon = document.getElementById('togglePasswordIcon');

            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                icon.classList.remove('bi-eye');
                icon.classList.add('bi-eye-slash');
            } else {
                passwordInput.type = 'password';
                icon.classList.remove('bi-eye-slash');
                icon.classList.add('bi-eye');
            }
        });

        // Save master password
        document.getElementById('saveMasterPasswordBtn').addEventListener('click', async function() {
            const btn = this;
            const originalHTML = btn.innerHTML;
            const statusSection = document.getElementById('masterPasswordStatusSection');
            const newPassword = document.getElementById('newMasterPassword').value.trim();

            if (!newPassword) {
                statusSection.style.display = 'block';
                statusSection.innerHTML = `
                    <div class="alert alert-warning" role="alert">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        Please enter a new master password.
                    </div>
                `;
                return;
            }

            try {
                // Show loading state
                btn.disabled = true;
                btn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Saving...';

                const formData = new FormData();
                formData.append('password', newPassword);

                const response = await fetch('{% url "players:set_master_password" %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: formData
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    statusSection.style.display = 'block';
                    statusSection.innerHTML = `
                        <div class="alert alert-success" role="alert">
                            <i class="bi bi-check-circle-fill me-2"></i>
                            Master password updated successfully!
                        </div>
                    `;

                    // Update current password display
                    currentMasterPassword = newPassword;
                    document.getElementById('currentMasterPasswordDisplay').value = currentMasterPassword;
                    document.getElementById('newMasterPassword').value = '';

                    // Re-enable button
                    btn.disabled = false;
                    btn.innerHTML = originalHTML;

                    // Close modal after 1.5 seconds
                    setTimeout(() => {
                        bootstrap.Modal.getInstance(document.getElementById('masterPasswordModal')).hide();
                        statusSection.style.display = 'none';
                    }, 1500);

                } else {
                    throw new Error(result.message || 'Failed to save password');
                }

            } catch (error) {
                statusSection.style.display = 'block';
                statusSection.innerHTML = `
                    <div class="alert alert-danger" role="alert">
                        <i class="bi bi-x-circle-fill me-2"></i>
                        <strong>Error:</strong> ${error.message}
                    </div>
                `;
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        });

        // Reset modal when closed
        document.getElementById('masterPasswordModal').addEventListener('hidden.bs.modal', function() {
            document.getElementById('newMasterPassword').value = '';
            document.getElementById('masterPasswordStatusSection').style.display = 'none';
            document.getElementById('currentMasterPasswordDisplay').type = 'password';
            document.getElementById('togglePasswordIcon').classList.remove('bi-eye-slash');
            document.getElementById('togglePasswordIcon').classList.add('bi-eye');
        });

        // Remove Cookie button handler
        document.getElementById('removeCookieBtn').addEventListener('click', function() {
            const btn = this;
            const originalHTML = btn.innerHTML;

            // Delete the master_password cookie
            document.cookie = 'master_password=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';

            // Show success state
            btn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Cookie Removed!';
            btn.disabled = true;

            // Show a temporary alert
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show mt-3';
            alertDiv.role = 'alert';
            alertDiv.innerHTML = `
                <i class="bi bi-check-circle-fill me-2"></i>
                <strong>Cookie removed successfully!</strong> You will be challenged for the master password on your next page visit.
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;

            // Insert alert after the Developer Settings buttons
            const devSettingsCard = btn.closest('.card-body');
            devSettingsCard.appendChild(alertDiv);

            // Reset button after 3 seconds
            setTimeout(() => {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }, 3000);

            // Auto-dismiss alert after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.remove();
                }
            }, 5000);
        });
    </script>
{% endblock %}
