{% extends "base.html" %}

{% block title %}Settings - WUSA 7U{% endblock %}

{% block page_title %}WUSA 7U - Settings{% endblock %}

{% block content %}
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0"><i class="bi bi-gear-fill me-2"></i>Application Settings</h4>
                    </div>
                    <div class="card-body">
                        <h5 class="card-title">Draft</h5>

                        <div class="d-flex gap-2">
                            {% if draft_exists %}
                                <a href="{% url 'players:edit_draft' %}" class="btn btn-primary">
                                    <i class="bi bi-pencil me-2"></i>Edit Draft
                                </a>
                                <a href="{% url 'players:run_draft' %}" class="btn btn-success">
                                    <i class="bi bi-play-circle me-2"></i>Run Draft
                                </a>
                            {% else %}
                                <a href="{% url 'players:edit_draft' %}" class="btn btn-success">
                                    <i class="bi bi-plus-circle me-2"></i>Create New Draft
                                </a>
                            {% endif %}
                        </div>

                        <hr class="my-4">

                        <h5 class="card-title">Team Preferences</h5>
                        <p class="text-muted">Analyze manager team preferences and assign managers to teams.</p>

                        <div class="d-flex gap-2">
                            <a href="{% url 'players:team_preferences' %}" class="btn btn-primary">
                                <i class="bi bi-card-checklist me-2"></i>Submission Form
                            </a>
                            <a href="{% url 'players:team_preferences_analyze' %}" class="btn btn-info">
                                <i class="bi bi-bar-chart-fill me-2"></i>Analyze Data
                            </a>
                        </div>

                        <hr class="my-4">

                        <h5 class="card-title">Emails</h5>
                        <p class="text-muted">Send emails to managers for various purposes.</p>

                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#teamPreferencesEmailModal">
                            <i class="bi bi-envelope me-2"></i>Send Team Preferences Email
                        </button>

                        <hr class="my-4">

                        <h5 class="card-title">Player Data Import</h5>
                        <p class="text-muted">Upload an Excel file (.xlsx) to import player data into the database.</p>

                        <form id="importForm" enctype="multipart/form-data">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label for="excelFile" class="form-label">Select Excel File</label>
                                <input class="form-control" type="file" id="excelFile" name="excel_file" accept=".xlsx" required>
                                <div class="form-text">Only .xlsx files are supported</div>
                            </div>

                            <div class="mb-3">
                                <div id="fileInfo" class="alert alert-info d-none">
                                    <i class="bi bi-info-circle me-2"></i>
                                    <span id="fileName"></span>
                                </div>
                            </div>

                            <button type="submit" class="btn btn-primary" id="importBtn">
                                <i class="bi bi-upload me-2"></i>Upload and Import Players
                            </button>
                            <button type="button" class="btn btn-secondary d-none" id="loadingBtn" disabled>
                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                Processing...
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Result Modal -->
    <div class="modal fade" id="resultModal" tabindex="-1" aria-labelledby="resultModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header" id="modalHeader">
                    <h5 class="modal-title" id="resultModalLabel">Import Results</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="modalBody">
                    <!-- Results will be inserted here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Team Preferences Email Modal -->
    <div class="modal fade" id="teamPreferencesEmailModal" tabindex="-1" aria-labelledby="teamPreferencesEmailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="teamPreferencesEmailModalLabel">Send Team Preferences Email</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="emailSuccessAlert" class="alert alert-success" style="display: none;">
                        <i class="bi bi-check-circle me-2"></i>
                        <span id="emailSuccessMessage"></span>
                    </div>

                    <div id="emailErrorAlert" class="alert alert-danger" style="display: none;">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <span id="emailErrorMessage"></span>
                    </div>

                    <form id="teamPreferencesEmailForm">
                        {% csrf_token %}

                        <div class="mb-3">
                            <label for="ccEmails" class="form-label">CC Email Addresses (optional)</label>
                            <input type="text" class="form-control" id="ccEmails" name="cc_emails" placeholder="email1@example.com, email2@example.com">
                            <div class="form-text">Enter multiple email addresses separated by commas</div>
                        </div>

                        <div class="mb-3">
                            <label for="emailSubject" class="form-label">Subject</label>
                            <input type="text" class="form-control" id="emailSubject" name="subject" value="WUSA Team Preferences Submission" required>
                        </div>

                        <div class="mb-3">
                            <label for="emailBody" class="form-label">Email Body</label>
                            <textarea class="form-control" id="emailBody" name="body" rows="12" required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="sendEmailBtn">
                        <i class="bi bi-send me-1"></i>Send Email
                    </button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script>
        // Show file name when selected
        document.getElementById('excelFile').addEventListener('change', function(e) {
            const fileInfo = document.getElementById('fileInfo');
            const fileName = document.getElementById('fileName');

            if (this.files.length > 0) {
                fileName.textContent = 'Selected file: ' + this.files[0].name;
                fileInfo.classList.remove('d-none');
            } else {
                fileInfo.classList.add('d-none');
            }
        });

        // Handle form submission
        document.getElementById('importForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const fileInput = document.getElementById('excelFile');
            const importBtn = document.getElementById('importBtn');
            const loadingBtn = document.getElementById('loadingBtn');

            if (!fileInput.files.length) {
                alert('Please select a file');
                return;
            }

            // Show loading state
            importBtn.classList.add('d-none');
            loadingBtn.classList.remove('d-none');

            const formData = new FormData();
            formData.append('excel_file', fileInput.files[0]);
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

            try {
                const response = await fetch('/api/import-players/', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                // Show results in modal
                showResults(data, response.ok);

            } catch (error) {
                showResults({
                    success: false,
                    error: 'Network error: ' + error.message
                }, false);
            } finally {
                // Reset buttons
                importBtn.classList.remove('d-none');
                loadingBtn.classList.add('d-none');

                // Clear file input
                fileInput.value = '';
                document.getElementById('fileInfo').classList.add('d-none');
            }
        });

        function showResults(data, success) {
            const modal = new bootstrap.Modal(document.getElementById('resultModal'));
            const modalHeader = document.getElementById('modalHeader');
            const modalBody = document.getElementById('modalBody');

            if (success && data.success) {
                // Success
                modalHeader.className = 'modal-header bg-success text-white';
                modalBody.innerHTML = `
                    <div class="alert alert-success">
                        <h5><i class="bi bi-check-circle-fill me-2"></i>Import Successful!</h5>
                    </div>
                    <table class="table">
                        <tbody>
                            <tr>
                                <th>Total Rows in Excel:</th>
                                <td>${data.total_rows}</td>
                            </tr>
                            <tr>
                                <th>Successfully Imported:</th>
                                <td class="text-success fw-bold">${data.imported}</td>
                            </tr>
                            <tr>
                                <th>Errors/Skipped:</th>
                                <td class="${data.errors.length > 0 ? 'text-warning' : 'text-muted'} fw-bold">${data.errors.length}</td>
                            </tr>
                            <tr>
                                <th>Total Players in Database:</th>
                                <td class="text-primary fw-bold">${data.total_players}</td>
                            </tr>
                        </tbody>
                    </table>
                    ${data.errors.length > 0 ? `
                        <div class="mt-3">
                            <h6>Errors:</h6>
                            <div class="alert alert-warning">
                                <ul class="mb-0">
                                    ${data.errors.map(err => `<li>Row ${err.row}: ${err.name} - ${err.error}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    ` : ''}
                `;
            } else {
                // Error
                modalHeader.className = 'modal-header bg-danger text-white';
                modalBody.innerHTML = `
                    <div class="alert alert-danger">
                        <h5><i class="bi bi-exclamation-triangle-fill me-2"></i>Import Failed</h5>
                        <p class="mb-0">${data.error || 'An unknown error occurred'}</p>
                    </div>
                `;
            }

            modal.show();
        }

        // Team Preferences Email Modal
        document.addEventListener('DOMContentLoaded', function() {
            // Set default email body with current domain
            const teamPreferencesModal = document.getElementById('teamPreferencesEmailModal');
            teamPreferencesModal.addEventListener('show.bs.modal', function() {
                const emailBody = document.getElementById('emailBody');
                if (!emailBody.value) {
                    const currentDomain = window.location.origin;
                    const defaultText = `Hello WUSA Managers-

As mentioned, we need to collect your preferences for team names.

To submit your choices, go to the following URL: ${currentDomain}/team_preferences/

Please have your choices submitted within the next 24 hours, and let us know if you have any questions.

Thanks,

-Your Division Managers`;
                    emailBody.value = defaultText;
                }
            });

            // Handle send email button
            document.getElementById('sendEmailBtn').addEventListener('click', function() {
                const form = document.getElementById('teamPreferencesEmailForm');
                const formData = new FormData(form);

                const btn = this;
                const originalHtml = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Sending...';

                // Hide previous alerts
                document.getElementById('emailSuccessAlert').style.display = 'none';
                document.getElementById('emailErrorAlert').style.display = 'none';

                fetch('{% url "players:send_team_preferences_email" %}', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    btn.disabled = false;
                    btn.innerHTML = originalHtml;

                    if (data.success) {
                        document.getElementById('emailSuccessMessage').textContent = data.message;
                        document.getElementById('emailSuccessAlert').style.display = 'block';
                        // Clear form
                        form.reset();
                    } else {
                        document.getElementById('emailErrorMessage').textContent = data.error;
                        document.getElementById('emailErrorAlert').style.display = 'block';
                    }
                })
                .catch(error => {
                    btn.disabled = false;
                    btn.innerHTML = originalHtml;
                    document.getElementById('emailErrorMessage').textContent = 'An unexpected error occurred.';
                    document.getElementById('emailErrorAlert').style.display = 'block';
                    console.error('Error:', error);
                });
            });
        });
    </script>
{% endblock %}
