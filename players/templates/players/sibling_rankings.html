{% extends "base.html" %}

{% block title %}Sibling Rankings - WUSA 7U{% endblock %}

{% block page_title %}WUSA 7U - Sibling Rankings{% endblock %}

{% block extra_css %}
    <style>
        .player-drop-zone {
            min-height: 150px;
            padding: 10px;
            border: 2px dashed #dee2e6;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        #availablePlayers {
            max-height: 600px;
            overflow-y: auto;
        }
        .round-zones-container {
            max-height: 800px;
            overflow-y: auto;
        }
        .player-item {
            background-color: #fff;
            border: 1px solid #dee2e6;
            padding: 10px 15px;
            margin-bottom: 8px;
            border-radius: 4px;
            cursor: move;
            transition: all 0.2s;
            display: flex;
            align-items: center;
        }
        .player-item:hover {
            background-color: #f8f9fa;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .player-item.dragging {
            opacity: 0.5;
        }
        .player-item.drag-over-item {
            border-top: 3px solid #0d6efd;
            margin-top: 8px;
        }
        .player-drop-zone.drag-over {
            background-color: #e3f2fd;
            border-color: #2196f3;
        }
        .rank-badge {
            background-color: #0d6efd;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
            flex-shrink: 0;
            font-size: 0.85rem;
        }
        .round-header {
            background-color: #198754;
            color: white;
            padding: 10px 15px;
            border-radius: 4px 4px 0 0;
            margin-bottom: 0;
            font-weight: bold;
        }
        .round-bucket {
            border: 2px solid #198754;
            border-radius: 4px;
            margin-bottom: 20px;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="container mt-4">
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}

        <div class="row">
            <div class="col-lg-11 offset-lg-0">
                <div class="card shadow">
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>Instructions:</strong> Drag each sibling (who wants to stay together) into the appropriate draft round bucket on the right.
                            Within each round, arrange players from top (most preferred) to bottom (least preferred).
                            The system will use your rankings to suggest which round each player should be drafted in.
                        </div>

                        {% if separation_players %}
                        <div class="alert alert-warning">
                            <h6 class="alert-heading"><i class="bi bi-info-circle me-2"></i>Siblings Requesting Team Separation</h6>
                            <p class="mb-2">The following players have siblings but have requested to be on separate teams. They will be treated as normal players in the draft:</p>
                            <ul class="mb-0">
                                {% for player in separation_players %}
                                <li>{{ player.first_name }} {{ player.last_name }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}

                        <form method="post" id="rankingsForm">
                            {% csrf_token %}
                            <input type="hidden" id="rankingsField" name="rankings" value="">
                            {% if team_secret %}
                                <input type="hidden" name="team_secret" value="{{ team_secret }}">
                            {% endif %}

                            <div class="row">
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-header bg-secondary text-white">
                                            <strong><i class="bi bi-people me-2"></i>Available Siblings (Want to Stay Together)</strong>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <input type="text" id="playerSearch" class="form-control" placeholder="Search players by name...">
                                            </div>
                                            <div id="availablePlayers" class="player-drop-zone">
                                                {% for player in all_players %}
                                                    <div class="player-item" draggable="true" data-player-id="{{ player.id }}">
                                                        <i class="bi bi-grip-vertical me-2"></i>
                                                        <span class="player-name">{{ player.first_name }} {{ player.last_name }}</span>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-8">
                                    <div class="card">
                                        <div class="card-header bg-success text-white">
                                            <strong><i class="bi bi-trophy-fill me-2"></i>Your Rankings by Draft Round (<span id="totalRankCount">0</span>/{{ sibling_count }})</strong>
                                        </div>
                                        <div class="card-body">
                                            <div class="round-zones-container" id="roundZonesContainer">
                                                <!-- Round buckets will be generated by JavaScript -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex justify-content-between mt-4">
                                {% if team_secret %}
                                    <a href="{% url 'players:team_detail' team_secret %}" class="btn btn-secondary">
                                        <i class="bi bi-arrow-left me-1"></i>Back to Team Page
                                    </a>
                                {% else %}
                                    <a href="{% url 'players:settings' %}" class="btn btn-secondary">
                                        <i class="bi bi-arrow-left me-1"></i>Cancel
                                    </a>
                                {% endif %}
                                <button type="submit" class="btn btn-success" id="submitBtn">
                                    <i class="bi bi-check-circle me-1"></i>Save Rankings
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script>
        // Configuration
        let draggedElement = null;
        const NUM_ROUNDS = {{ num_rounds }};
        const EXISTING_RANKINGS = {{ existing_rankings_data|safe }};

        // Initialize round buckets on page load
        function initializeRoundBuckets() {
            const container = document.getElementById('roundZonesContainer');
            container.innerHTML = '';

            for (let round = 1; round <= NUM_ROUNDS; round++) {
                const roundBucket = document.createElement('div');
                roundBucket.className = 'round-bucket';
                roundBucket.innerHTML = `
                    <div class="round-header">
                        Round ${round} (<span id="roundCount${round}">0</span> players)
                    </div>
                    <div class="player-drop-zone" data-round="${round}" id="round${round}">
                        <p class="text-muted text-center mt-3">Drag players here for Round ${round}</p>
                    </div>
                `;
                container.appendChild(roundBucket);
            }

            // Add drag and drop event listeners to all drop zones
            document.querySelectorAll('.player-drop-zone').forEach(zone => {
                zone.addEventListener('dragover', handleDragOver);
                zone.addEventListener('drop', handleDrop);
                zone.addEventListener('dragleave', handleDragLeave);
                zone.addEventListener('dragenter', handleDragEnter);
            });
        }

        // Initialize drag and drop for player items
        function initializeDragAndDrop() {
            document.querySelectorAll('.player-item').forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragend', handleDragEnd);
                item.addEventListener('dragover', handleItemDragOver);
            });
        }

        function handleDragStart(e) {
            draggedElement = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('.drag-over').forEach(el => {
                el.classList.remove('drag-over');
            });
            document.querySelectorAll('.drag-over-item').forEach(el => {
                el.classList.remove('drag-over-item');
            });
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleItemDragOver(e) {
            e.preventDefault();
            e.stopPropagation();

            if (this === draggedElement) {
                return false;
            }

            // Mark this item as the insertion point
            document.querySelectorAll('.player-item').forEach(item => {
                item.classList.remove('drag-over-item');
            });
            this.classList.add('drag-over-item');

            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e) {
            if (e.target.classList.contains('player-drop-zone')) {
                e.target.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            if (e.target.classList.contains('player-drop-zone')) {
                e.target.classList.remove('drag-over');
            }
        }

        function handleDrop(e) {
            e.stopPropagation();
            e.preventDefault();

            this.classList.remove('drag-over');

            if (!draggedElement) {
                return false;
            }

            // Check if we're dropping on another player item (for reordering)
            const dropTarget = e.target.closest('.player-item');
            if (dropTarget && dropTarget !== draggedElement) {
                // Insert before the target item
                const parent = dropTarget.parentNode;
                parent.insertBefore(draggedElement, dropTarget);
                draggedElement.classList.remove('dragging');

                updateAllRankBadges();
                updateRankingsField();
                return false;
            }

            // Remove placeholder if exists
            const placeholder = this.querySelector('p.text-muted');
            if (placeholder) {
                placeholder.remove();
            }

            // Clone the dragged element
            const clone = draggedElement.cloneNode(true);
            clone.classList.remove('dragging');

            // Add drag event listeners to the clone
            clone.addEventListener('dragstart', handleDragStart);
            clone.addEventListener('dragend', handleDragEnd);
            clone.addEventListener('dragover', handleItemDragOver);

            // Remove original element
            draggedElement.remove();

            // Append to this drop zone
            this.appendChild(clone);

            // Update all displays
            updateAllRankBadges();
            updateRankingsField();

            return false;
        }

        function updateAllRankBadges() {
            let globalRank = 1;
            let totalRanked = 0;

            // Update each round
            for (let round = 1; round <= NUM_ROUNDS; round++) {
                const roundZone = document.getElementById(`round${round}`);
                const playerItems = roundZone.querySelectorAll('.player-item');

                playerItems.forEach((item) => {
                    // Remove existing rank badge if any
                    const existingBadge = item.querySelector('.rank-badge');
                    if (existingBadge) {
                        existingBadge.remove();
                    }

                    // Add new rank badge
                    const badge = document.createElement('span');
                    badge.className = 'rank-badge';
                    badge.textContent = globalRank;
                    item.insertBefore(badge, item.firstChild);

                    globalRank++;
                });

                // Update round count
                document.getElementById(`roundCount${round}`).textContent = playerItems.length;
                totalRanked += playerItems.length;
            }

            // Update total count
            document.getElementById('totalRankCount').textContent = totalRanked;

            // Enable/disable submit button
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = (totalRanked === 0);
        }

        function updateRankingsField() {
            const rankings = [];
            let globalRank = 1;

            // Collect rankings from each round
            for (let round = 1; round <= NUM_ROUNDS; round++) {
                const roundZone = document.getElementById(`round${round}`);
                const playerItems = roundZone.querySelectorAll('.player-item');

                playerItems.forEach((item) => {
                    rankings.push({
                        player_id: parseInt(item.getAttribute('data-player-id')),
                        rank: globalRank,
                        round: round
                    });
                    globalRank++;
                });
            }

            document.getElementById('rankingsField').value = JSON.stringify(rankings);
        }

        // Load existing rankings
        function loadExistingRankings() {
            if (!EXISTING_RANKINGS || EXISTING_RANKINGS.length === 0) {
                return;
            }

            const availablePlayers = document.getElementById('availablePlayers');

            EXISTING_RANKINGS.forEach(ranking => {
                const playerItem = availablePlayers.querySelector(`[data-player-id="${ranking.player_id}"]`);
                if (playerItem) {
                    const round = ranking.round || 1; // Default to round 1 if not specified
                    const roundZone = document.getElementById(`round${round}`);

                    // Remove placeholder if exists
                    const placeholder = roundZone.querySelector('p.text-muted');
                    if (placeholder) {
                        placeholder.remove();
                    }

                    // Move player to round zone
                    roundZone.appendChild(playerItem);
                }
            });

            updateAllRankBadges();
            updateRankingsField();
        }

        // Player search functionality
        function initializeSearch() {
            const searchInput = document.getElementById('playerSearch');
            const availablePlayers = document.getElementById('availablePlayers');

            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const playerItems = availablePlayers.querySelectorAll('.player-item');

                playerItems.forEach(item => {
                    const playerName = item.querySelector('.player-name').textContent.toLowerCase();
                    if (playerName.includes(searchTerm)) {
                        item.style.display = '';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });
        }

        // Form submission
        function initializeFormSubmission() {
            document.getElementById('rankingsForm').addEventListener('submit', function(e) {
                const totalRanked = parseInt(document.getElementById('totalRankCount').textContent);
                if (totalRanked === 0) {
                    e.preventDefault();
                    alert('Please rank at least one player before submitting.');
                    return false;
                }
                updateRankingsField();
            });
        }

        // Initialize everything on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeRoundBuckets();
            initializeDragAndDrop();
            initializeSearch();
            initializeFormSubmission();
            loadExistingRankings();
        });
    </script>
{% endblock %}
