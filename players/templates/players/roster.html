{% extends "base.html" %}

{% block content %}
<div class="container mt-4 mb-5">
    <h2>
        Home: {{ roster.event.home_team.name|default:"TBD" }} |
        Away: {{ roster.event.away_team.name|default:"TBD" }} |
        Time: {{ event_time_display|date:"m/d/y, g:i A" }} {{ display_tz }} |
        Location: {{ roster.event.location|default:"TBD" }}
    </h2>

    <!-- Innings Tabs -->
    <ul class="nav nav-tabs mt-4" id="inningTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="inning1-tab" data-bs-toggle="tab" data-bs-target="#inning1" type="button" role="tab">Inning 1</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="inning2-tab" data-bs-toggle="tab" data-bs-target="#inning2" type="button" role="tab">Inning 2</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="inning3-tab" data-bs-toggle="tab" data-bs-target="#inning3" type="button" role="tab">Inning 3</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="inning4-tab" data-bs-toggle="tab" data-bs-target="#inning4" type="button" role="tab">Inning 4</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="inning5-tab" data-bs-toggle="tab" data-bs-target="#inning5" type="button" role="tab">Inning 5</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="inning6-tab" data-bs-toggle="tab" data-bs-target="#inning6" type="button" role="tab">Inning 6</button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content mt-4" id="inningTabContent">
        {% for inning in "123456" %}
        <div class="tab-pane fade {% if inning == '1' %}show active{% endif %}" id="inning{{ inning }}" role="tabpanel">
            <div class="row g-3">
                <!-- Left Column: Player List -->
                <div class="col-md-6">
                    <div class="roster-section">
                        <h5 class="section-header">Available Players</h5>
                        <div class="player-list" id="playerList{{ inning }}">
                            {% for player in team.players.all %}
                            <div class="player-card" draggable="true" data-player-id="{{ player.id }}" data-player-name="{{ player.first_name }} {{ player.last_name }}">
                                {{ player.first_name }} {{ player.last_name }}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Right Column: Baseball Field -->
                <div class="col-md-6">
                    <div class="roster-section">
                        <h5 class="section-header">Field Positions</h5>
                        <div class="baseball-field" data-inning="{{ inning }}">
        <svg viewBox="0 0 600 625" class="field-svg">
            <!-- Infield dirt (90 foot diamond + extended areas) -->
            <path d="M 300 550.625 L 70 392.5 L 300 234.375 L 530 392.5 Z"
                  fill="#d4a574" stroke="none"/>

            <!-- Dirt cutout around pitcher/home plate -->
            <ellipse cx="300" cy="550.625" rx="86.25" ry="57.5" fill="#d4a574" stroke="none"/>
            <circle cx="300" cy="392.5" r="43.125" fill="#d4a574" stroke="none"/>

            <!-- Basepaths (dirt lines) -->
            <line x1="300" y1="550.625" x2="70" y2="392.5" stroke="#c19a6b" stroke-width="5"/>
            <line x1="300" y1="550.625" x2="530" y2="392.5" stroke="#c19a6b" stroke-width="5"/>
            <line x1="70" y1="392.5" x2="300" y2="234.375" stroke="#c19a6b" stroke-width="5"/>
            <line x1="530" y1="392.5" x2="300" y2="234.375" stroke="#c19a6b" stroke-width="5"/>

            <!-- Pitcher's mound -->
            <circle cx="300" cy="392.5" r="31.625" fill="#b8885c" stroke="#a67c52" stroke-width="2"/>

            <!-- Bases -->
            <rect x="295" y="229.375" width="10" height="10" fill="white" stroke="#999" stroke-width="1" transform="rotate(45 300 234.375)"/>
            <rect x="525" y="387.5" width="10" height="10" fill="white" stroke="#999" stroke-width="1" transform="rotate(45 530 392.5)"/>
            <rect x="65" y="387.5" width="10" height="10" fill="white" stroke="#999" stroke-width="1" transform="rotate(45 70 392.5)"/>

            <!-- Home plate -->
            <polygon points="300,561.875 294.25,555 294.25,550.625 305.75,550.625 305.75,555" fill="white" stroke="#999" stroke-width="1"/>

            <!-- Position markers (drop zones) -->
            <!-- Outfielders - spread far out and deeper -->
            <g class="position-marker" data-position="LF">
                <circle cx="70" cy="113.125" r="40" fill="rgba(255,255,255,0.9)" stroke="#333" stroke-width="2" class="position-circle"/>
                <text x="70" y="119.125" text-anchor="middle" font-size="14" font-weight="bold" fill="#666" class="position-label">LF</text>
                <text x="70" y="168.125" text-anchor="middle" font-size="11" fill="#333" class="player-name-display"></text>
            </g>

            <g class="position-marker" data-position="CF">
                <circle cx="300" cy="79.375" r="40" fill="rgba(255,255,255,0.9)" stroke="#333" stroke-width="2" class="position-circle"/>
                <text x="300" y="85.375" text-anchor="middle" font-size="14" font-weight="bold" fill="#666" class="position-label">CF</text>
                <text x="300" y="134.375" text-anchor="middle" font-size="11" fill="#333" class="player-name-display"></text>
            </g>

            <g class="position-marker" data-position="RF">
                <circle cx="530" cy="113.125" r="40" fill="rgba(255,255,255,0.9)" stroke="#333" stroke-width="2" class="position-circle"/>
                <text x="530" y="119.125" text-anchor="middle" font-size="14" font-weight="bold" fill="#666" class="position-label">RF</text>
                <text x="530" y="168.125" text-anchor="middle" font-size="11" fill="#333" class="player-name-display"></text>
            </g>

            <!-- Infielders - spread around diamond -->
            <g class="position-marker" data-position="3B">
                <circle cx="70" cy="392.5" r="40" fill="rgba(255,255,255,0.9)" stroke="#333" stroke-width="2" class="position-circle"/>
                <text x="70" y="398.5" text-anchor="middle" font-size="14" font-weight="bold" fill="#666" class="position-label">3B</text>
                <text x="70" y="447.5" text-anchor="middle" font-size="11" fill="#333" class="player-name-display"></text>
            </g>

            <g class="position-marker" data-position="SS">
                <circle cx="156.25" cy="284.6875" r="40" fill="rgba(255,255,255,0.9)" stroke="#333" stroke-width="2" class="position-circle"/>
                <text x="156.25" y="290.6875" text-anchor="middle" font-size="14" font-weight="bold" fill="#666" class="position-label">SS</text>
                <text x="156.25" y="339.6875" text-anchor="middle" font-size="11" fill="#333" class="player-name-display"></text>
            </g>

            <g class="position-marker" data-position="2B">
                <circle cx="443.75" cy="284.6875" r="40" fill="rgba(255,255,255,0.9)" stroke="#333" stroke-width="2" class="position-circle"/>
                <text x="443.75" y="290.6875" text-anchor="middle" font-size="14" font-weight="bold" fill="#666" class="position-label">2B</text>
                <text x="443.75" y="339.6875" text-anchor="middle" font-size="11" fill="#333" class="player-name-display"></text>
            </g>

            <g class="position-marker" data-position="1B">
                <circle cx="530" cy="392.5" r="40" fill="rgba(255,255,255,0.9)" stroke="#333" stroke-width="2" class="position-circle"/>
                <text x="530" y="398.5" text-anchor="middle" font-size="14" font-weight="bold" fill="#666" class="position-label">1B</text>
                <text x="530" y="447.5" text-anchor="middle" font-size="11" fill="#333" class="player-name-display"></text>
            </g>

            <g class="position-marker" data-position="P">
                <circle cx="300" cy="392.5" r="40" fill="rgba(255,255,255,0.9)" stroke="#333" stroke-width="2" class="position-circle"/>
                <text x="300" y="398.5" text-anchor="middle" font-size="14" font-weight="bold" fill="#666" class="position-label">P</text>
                <text x="300" y="447.5" text-anchor="middle" font-size="11" fill="#333" class="player-name-display"></text>
            </g>

            <g class="position-marker" data-position="R">
                <circle cx="300" cy="234.375" r="40" fill="rgba(255,255,255,0.9)" stroke="#333" stroke-width="2" class="position-circle"/>
                <text x="300" y="240.375" text-anchor="middle" font-size="14" font-weight="bold" fill="#666" class="position-label">R</text>
                <text x="300" y="289.375" text-anchor="middle" font-size="11" fill="#333" class="player-name-display"></text>
            </g>

            <g class="position-marker" data-position="C">
                <circle cx="300" cy="597.125" r="40" fill="rgba(255,255,255,0.9)" stroke="#333" stroke-width="2" class="position-circle"/>
                <text x="300" y="603.125" text-anchor="middle" font-size="14" font-weight="bold" fill="#666" class="position-label">C</text>
                <text x="300" y="652.125" text-anchor="middle" font-size="11" fill="#333" class="player-name-display"></text>
            </g>
        </svg>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<style>
/* Section Container Styles */
.roster-section {
    background-color: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    height: 750px;
    display: flex;
    flex-direction: column;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.section-header {
    font-size: 16px;
    font-weight: 600;
    color: #495057;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 2px solid #e9ecef;
}

/* Player List Styles */
.player-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
    flex: 1;
    overflow-y: auto;
    padding: 10px;
    background-color: #f8f9fa;
    border-radius: 4px;
}

.player-card {
    padding: 12px 16px;
    background-color: white;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    font-size: 14px;
    text-align: left;
    cursor: grab;
    transition: all 0.2s;
}

.player-card:hover {
    background-color: #f8f9fa;
    border-color: #0d6efd;
    transform: translateX(3px);
}

.player-card:active {
    cursor: grabbing;
    opacity: 0.6;
}

.player-card.dragging {
    opacity: 0;
    visibility: hidden;
}

.player-card.assigned {
    display: none;
}

/* Baseball Field Styles */
.baseball-field {
    width: 100%;
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #6ba368;
    border-radius: 4px;
    padding: 20px;
}

.field-svg {
    width: 90%;
    height: 90%;
    max-width: none;
}

.position-marker {
    cursor: pointer;
    transition: all 0.2s;
}

.position-marker:hover .position-circle {
    fill: rgba(13, 110, 253, 0.1);
    stroke: #0d6efd;
}

.position-marker.has-player .position-circle {
    fill: #d1e7dd;
    stroke: #198754;
    stroke-width: 3;
}

.position-marker.drag-over .position-circle {
    fill: #cfe2ff;
    stroke: #0d6efd;
    stroke-width: 4;
    stroke-dasharray: 5, 5;
    animation: pulse 0.5s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

.player-name-display {
    font-weight: 600;
    fill: #333;
}

/* Tab Styles - Card Style */
.nav-tabs {
    border-bottom: none;
    gap: 8px;
}

.nav-tabs .nav-link {
    color: #495057;
    background-color: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 12px 24px;
    font-weight: 500;
    transition: all 0.2s ease;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.nav-tabs .nav-link:hover {
    background-color: #f8f9fa;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    border-color: #0d6efd;
}

.nav-tabs .nav-link.active {
    color: white;
    background-color: #0d6efd;
    border-color: #0d6efd;
    font-weight: 600;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(13,110,253,0.3);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const rosterId = {{ roster.id }};
    const teamSecret = '{{ team.manager_secret }}';

    // Initialize drag and drop for each inning
    for (let inning = 1; inning <= 6; inning++) {
        initializeDragAndDrop(inning);
        loadPositions(inning);
    }

    function initializeDragAndDrop(inning) {
        const playerCards = document.querySelectorAll(`#playerList${inning} .player-card`);
        const positionMarkers = document.querySelectorAll(`[data-inning="${inning}"] .position-marker`);

        // Make player cards draggable
        playerCards.forEach(card => {
            card.addEventListener('dragstart', function(e) {
                e.dataTransfer.setData('playerId', this.dataset.playerId);
                e.dataTransfer.setData('playerName', this.dataset.playerName);

                // Create a custom drag image
                const dragImage = this.cloneNode(true);
                dragImage.style.position = 'absolute';
                dragImage.style.top = '-1000px';
                dragImage.style.opacity = '0.8';
                dragImage.style.pointerEvents = 'none';
                document.body.appendChild(dragImage);
                e.dataTransfer.setDragImage(dragImage, 0, 0);

                // Clean up drag image after drag starts
                setTimeout(() => {
                    document.body.removeChild(dragImage);
                }, 0);

                this.classList.add('dragging');
            });

            card.addEventListener('dragend', function() {
                this.classList.remove('dragging');
            });
        });

        // Make position markers droppable
        positionMarkers.forEach(marker => {
            marker.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('drag-over');
            });

            marker.addEventListener('dragleave', function(e) {
                this.classList.remove('drag-over');
            });

            marker.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('drag-over');

                const playerId = e.dataTransfer.getData('playerId');
                const playerName = e.dataTransfer.getData('playerName');
                const position = this.dataset.position;

                // Update display
                const nameDisplay = this.querySelector('.player-name-display');
                nameDisplay.textContent = playerName;
                this.classList.add('has-player');

                // Hide player card from Available Players list
                const playerCard = document.querySelector(`#playerList${inning} .player-card[data-player-id="${playerId}"]`);
                if (playerCard) {
                    playerCard.classList.add('assigned');
                }

                // Save to database
                savePosition(inning, position, playerId, playerName);
            });
        });
    }

    function savePosition(inning, position, playerId, playerName) {
        // TODO: Implement AJAX call to save position to database
        console.log(`Saving: Inning ${inning}, Position ${position}, Player ${playerId} (${playerName})`);
    }

    function loadPositions(inning) {
        // TODO: Implement AJAX call to load positions from database
        console.log(`Loading positions for inning ${inning}`);
    }
});
</script>
{% endblock %}
