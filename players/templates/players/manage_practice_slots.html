{% extends "base.html" %}

{% block title %}Manage Practice Slots - WUSA 7U{% endblock %}

{% block page_title %}{% endblock %}

{% block content %}
    <div class="container-fluid mt-5">
        <div class="row">
            <div class="col-12">
                <h2 class="mb-4"><i class="bi bi-calendar-week me-2"></i>WUSA 7U - Manage Practice Slots</h2>
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">Available Practice Slots</h4>
                    </div>
                    <div class="card-body">
                        <!-- Success/Error Messages -->
                        <div id="messageAlert" class="alert d-none" role="alert"></div>

                        <!-- Add New Slot Form -->
                        <div class="card mb-4">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0"><i class="bi bi-plus-circle me-2"></i>Add New Practice Slot</h5>
                            </div>
                            <div class="card-body">
                                <form id="addSlotForm">
                                    {% csrf_token %}
                                    <div class="row">
                                        <div class="col-md-10">
                                            <input type="text" class="form-control" id="newSlotText" name="practice_slot" placeholder="Enter practice slot time (e.g., Monday 6:00 PM - 7:00 PM)" required>
                                        </div>
                                        <div class="col-md-2">
                                            <button type="submit" class="btn btn-success w-100">
                                                <i class="bi bi-plus-circle me-1"></i>Add
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Practice Slots List -->
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i>All Practice Slots</h5>
                            </div>
                            <div class="card-body">
                                {% if practice_slots %}
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover">
                                            <thead>
                                                <tr>
                                                    <th>ID</th>
                                                    <th>Practice Slot</th>
                                                    <th>Created</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="slotsTableBody">
                                                {% for slot in practice_slots %}
                                                    <tr data-slot-id="{{ slot.id }}">
                                                        <td>{{ slot.id }}</td>
                                                        <td class="slot-text">{{ slot.practice_slot }}</td>
                                                        <td>{{ slot.created_at|date:"Y-m-d H:i" }}</td>
                                                        <td>
                                                            <button class="btn btn-sm btn-warning edit-slot-btn" data-slot-id="{{ slot.id }}" data-slot-text="{{ slot.practice_slot }}">
                                                                <i class="bi bi-pencil"></i> Edit
                                                            </button>
                                                            <button class="btn btn-sm btn-danger delete-slot-btn" data-slot-id="{{ slot.id }}">
                                                                <i class="bi bi-trash"></i> Delete
                                                            </button>
                                                        </td>
                                                    </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                {% else %}
                                    <p class="text-muted text-center">No practice slots available. Add one above to get started!</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade" id="editSlotModal" tabindex="-1" aria-labelledby="editSlotModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editSlotModalLabel">Edit Practice Slot</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editSlotForm">
                        {% csrf_token %}
                        <input type="hidden" id="editSlotId" name="slot_id">
                        <div class="mb-3">
                            <label for="editSlotText" class="form-label">Practice Slot</label>
                            <input type="text" class="form-control" id="editSlotText" name="practice_slot" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveSlotBtn">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteSlotModal" tabindex="-1" aria-labelledby="deleteSlotModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="deleteSlotModalLabel">Confirm Delete</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this practice slot?</p>
                    <p class="text-muted"><strong>This action cannot be undone.</strong></p>
                    <input type="hidden" id="deleteSlotId">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script>
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        // Show message helper
        function showMessage(message, type) {
            const messageAlert = document.getElementById('messageAlert');
            messageAlert.className = `alert alert-${type}`;
            messageAlert.textContent = message;
            messageAlert.classList.remove('d-none');

            // Auto-hide after 5 seconds
            setTimeout(() => {
                messageAlert.classList.add('d-none');
            }, 5000);
        }

        // Add new slot
        document.getElementById('addSlotForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = new FormData(this);

            try {
                const response = await fetch('{% url "players:create_practice_slot" %}', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    showMessage(data.message, 'success');
                    this.reset();
                    // Reload page to show new slot
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showMessage(data.error, 'danger');
                }
            } catch (error) {
                showMessage('An error occurred while adding the practice slot.', 'danger');
                console.error('Error:', error);
            }
        });

        // Edit slot - show modal
        document.querySelectorAll('.edit-slot-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const slotId = this.dataset.slotId;
                const slotText = this.dataset.slotText;

                document.getElementById('editSlotId').value = slotId;
                document.getElementById('editSlotText').value = slotText;

                const modal = new bootstrap.Modal(document.getElementById('editSlotModal'));
                modal.show();
            });
        });

        // Save edited slot
        document.getElementById('saveSlotBtn').addEventListener('click', async function() {
            const slotId = document.getElementById('editSlotId').value;
            const slotText = document.getElementById('editSlotText').value;

            if (!slotText.trim()) {
                showMessage('Practice slot text cannot be empty.', 'danger');
                return;
            }

            const formData = new FormData();
            formData.append('csrfmiddlewaretoken', csrfToken);
            formData.append('practice_slot', slotText);

            try {
                const response = await fetch(`/practice_slots/${slotId}/update/`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    showMessage(data.message, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('editSlotModal')).hide();
                    // Reload page to show updated slot
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showMessage(data.error, 'danger');
                }
            } catch (error) {
                showMessage('An error occurred while updating the practice slot.', 'danger');
                console.error('Error:', error);
            }
        });

        // Delete slot - show confirmation modal
        document.querySelectorAll('.delete-slot-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const slotId = this.dataset.slotId;
                document.getElementById('deleteSlotId').value = slotId;

                const modal = new bootstrap.Modal(document.getElementById('deleteSlotModal'));
                modal.show();
            });
        });

        // Confirm delete
        document.getElementById('confirmDeleteBtn').addEventListener('click', async function() {
            const slotId = document.getElementById('deleteSlotId').value;

            const formData = new FormData();
            formData.append('csrfmiddlewaretoken', csrfToken);

            try {
                const response = await fetch(`/practice_slots/${slotId}/delete/`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    showMessage(data.message, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('deleteSlotModal')).hide();
                    // Reload page to remove deleted slot
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showMessage(data.error, 'danger');
                }
            } catch (error) {
                showMessage('An error occurred while deleting the practice slot.', 'danger');
                console.error('Error:', error);
            }
        });
    </script>
{% endblock %}
