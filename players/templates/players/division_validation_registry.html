{% extends "base.html" %}

{% block title %}Division Validation Registry - WUSA 7U{% endblock %}

{% block page_title %}Division Validation Registry{% endblock %}

{% block content %}
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-11">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0"><i class="bi bi-diagram-3 me-2"></i>Division Validation Registry</h4>
                    </div>
                    <div class="card-body">
                        <p class="lead mb-4">
                            Configure which validation codes are required for each page to load.
                            Hover over validation codes to see their Python implementation.
                        </p>

                        <div class="alert alert-info mb-4">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>Frontend Only:</strong> This page is currently for visualization purposes only.
                            Changes made here are not saved to the backend yet.
                        </div>

                        <div class="table-responsive">
                            <table class="table table-hover table-bordered">
                                <thead class="table-dark">
                                    <tr>
                                        <th style="width: 25%;">Validation Code</th>
                                        {% for page in pages %}
                                            <th style="width: {{ 75|divisibleby:pages|length }}%;" class="text-center">
                                                <div><strong>{{ page.title }}</strong></div>
                                                <div><small>{{ page.url }}</small></div>
                                            </th>
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody id="registryTableBody">
                                    {% for validation in all_validation_codes %}
                                        <tr data-validation-code="{{ validation.code }}">
                                            <td>
                                                <div
                                                    class="validation-code-cell"
                                                    data-bs-toggle="tooltip"
                                                    data-bs-placement="right"
                                                    data-bs-html="true"
                                                    title="<pre style='text-align: left; margin: 0; font-size: 11px;'>{{ validation.source|escape }}</pre>"
                                                    style="cursor: help;">
                                                    <code class="text-danger">{{ validation.code }}</code>
                                                    <br>
                                                    <small class="text-muted">{{ validation.title }}</small>
                                                    <br>
                                                    <small class="text-info">
                                                        <i class="bi bi-code-square"></i> Hover for code
                                                    </small>
                                                </div>
                                            </td>
                                            {% for page in pages %}
                                                <td class="text-center">
                                                    <input
                                                        type="checkbox"
                                                        class="form-check-input validation-checkbox"
                                                        data-validation-code="{{ validation.code }}"
                                                        data-page-url="{{ page.url }}"
                                                        style="transform: scale(1.5);">
                                                </td>
                                            {% endfor %}
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <div class="mt-4">
                            <h5>Configuration Summary</h5>
                            <div class="alert alert-light">
                                <div id="configSummary" style="font-family: monospace; white-space: pre;">
Select checkboxes above to configure validation requirements for each page...
                                </div>
                            </div>
                        </div>

                        <div class="mt-4 text-end">
                            <button type="button" class="btn btn-secondary" id="resetBtn">
                                <i class="bi bi-arrow-counterclockwise me-2"></i>Reset All
                            </button>
                            <button type="button" class="btn btn-primary disabled" id="saveBtn" disabled>
                                <i class="bi bi-save me-2"></i>Save Configuration (Coming Soon)
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script>
        // Store current state of page validation requirements
        let pageValidationState = {};

        // Initialize tooltips
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Bootstrap tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl, {
                    boundary: 'window',
                    customClass: 'code-tooltip'
                });
            });

            // Initialize page validation state
            {% for page in pages %}
                pageValidationState['{{ page.url }}'] = [];
            {% endfor %}

            // Add change listeners to all checkboxes
            const checkboxes = document.querySelectorAll('.validation-checkbox');
            checkboxes.forEach(function(checkbox) {
                checkbox.addEventListener('change', function() {
                    updateValidationState();
                    updateConfigSummary();
                });
            });

            updateConfigSummary();
        });

        function updateValidationState() {
            // Reset state
            {% for page in pages %}
                pageValidationState['{{ page.url }}'] = [];
            {% endfor %}

            // Read all checkboxes
            const checkboxes = document.querySelectorAll('.validation-checkbox:checked');
            checkboxes.forEach(function(checkbox) {
                const pageUrl = checkbox.getAttribute('data-page-url');
                const validationCode = checkbox.getAttribute('data-validation-code');
                pageValidationState[pageUrl].push(validationCode);
            });

            // Log to console (for development)
            console.log('Updated validation state:', pageValidationState);
        }

        function updateConfigSummary() {
            const summaryDiv = document.getElementById('configSummary');
            let summary = 'Page Validation Requirements\n';
            summary += '='.repeat(60) + '\n\n';

            let hasAnyConfig = false;

            {% for page in pages %}
                const validations_{{ forloop.counter }} = pageValidationState['{{ page.url }}'];
                if (validations_{{ forloop.counter }}.length > 0) {
                    hasAnyConfig = true;
                    summary += '{{ page.title }} ({{ page.url }})\n';
                    summary += '├─ Required Validations: ' + validations_{{ forloop.counter }}.length + '\n';
                    validations_{{ forloop.counter }}.forEach((code, index) => {
                        const isLast = index === validations_{{ forloop.counter }}.length - 1;
                        const prefix = isLast ? '└─' : '├─';
                        const title = getValidationTitle(code);
                        summary += '│  ' + prefix + ' ' + title + '\n';
                    });
                    summary += '\n';
                }
            {% endfor %}

            if (!hasAnyConfig) {
                summary += 'No validation requirements configured yet.\n';
                summary += 'Check boxes above to require validations for specific pages.\n';
            }

            summaryDiv.textContent = summary;
        }

        function getValidationTitle(code) {
            const validationTitles = {
                {% for validation in all_validation_codes %}
                    '{{ validation.code }}': '{{ validation.title }}',
                {% endfor %}
            };
            return validationTitles[code] || code;
        }

        // Reset button
        document.getElementById('resetBtn').addEventListener('click', function() {
            if (!confirm('Are you sure you want to reset all validation requirements? This will uncheck all boxes.')) {
                return;
            }

            const checkboxes = document.querySelectorAll('.validation-checkbox');
            checkboxes.forEach(function(checkbox) {
                checkbox.checked = false;
            });

            updateValidationState();
            updateConfigSummary();

            console.log('All validation requirements reset');
        });
    </script>

    <style>
        .code-tooltip .tooltip-inner {
            max-width: 600px;
            text-align: left;
            background-color: #2d2d2d;
        }

        .validation-code-cell {
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .validation-code-cell:hover {
            background-color: #f8f9fa;
        }

        .validation-checkbox {
            cursor: pointer;
        }

        tbody tr:hover {
            background-color: #f8f9fa;
        }
    </style>
{% endblock %}
