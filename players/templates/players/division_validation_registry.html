{% extends "base.html" %}

{% block title %}Division Validation Registry - WUSA 7U{% endblock %}

{% block page_title %}Division Validation Registry{% endblock %}

{% block content %}
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-11">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0"><i class="bi bi-diagram-3 me-2"></i>Division Validation Registry</h4>
                    </div>
                    <div class="card-body">
                        <p class="lead mb-4">
                            Configure which validation codes are required for each page to load.
                            When a page has required validations, it will only be accessible if all those validations pass.
                        </p>

                        <div class="alert alert-info mb-4">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>Frontend Only:</strong> This page is currently for visualization purposes only.
                            Changes made here are not saved to the backend yet.
                        </div>

                        <div class="mb-4">
                            <h5>How it works:</h5>
                            <ol>
                                <li><strong>Select validations</strong> for each page that must pass before the page can be accessed</li>
                                <li><strong>Multiple selections allowed</strong> - hold Ctrl/Cmd to select multiple validation codes</li>
                                <li><strong>No selection</strong> means the page has no validation requirements (always accessible)</li>
                            </ol>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-hover table-bordered">
                                <thead class="table-dark">
                                    <tr>
                                        <th style="width: 18%;">Page URL</th>
                                        <th style="width: 18%;">Page Title</th>
                                        <th style="width: 20%;">View Function</th>
                                        <th style="width: 44%;">Required Validations</th>
                                    </tr>
                                </thead>
                                <tbody id="registryTableBody">
                                    {% for page in pages %}
                                        <tr data-url="{{ page.url }}">
                                            <td>
                                                <code>{{ page.url }}</code>
                                            </td>
                                            <td>
                                                <strong>{{ page.title }}</strong>
                                                <br>
                                                <small class="text-muted">{{ page.description }}</small>
                                            </td>
                                            <td>
                                                <code class="text-danger">{{ page.view_name }}</code>
                                            </td>
                                            <td>
                                                <select
                                                    class="form-select form-select-sm validation-select"
                                                    multiple
                                                    data-page-url="{{ page.url }}"
                                                    style="height: 180px;">
                                                    {% for validation in all_validation_codes %}
                                                        <option value="{{ validation.code }}">
                                                            {{ validation.title }}
                                                        </option>
                                                    {% endfor %}
                                                </select>
                                                <small class="text-muted d-block mt-1">
                                                    <i class="bi bi-info-circle me-1"></i>Hold Ctrl/Cmd to select multiple
                                                </small>
                                                <div class="mt-2">
                                                    <span class="badge bg-secondary validation-count" data-url="{{ page.url }}">
                                                        0 validations required
                                                    </span>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <div class="mt-4">
                            <h5>Configuration Summary</h5>
                            <div class="alert alert-light">
                                <div id="configSummary" style="font-family: monospace; white-space: pre;">
Select a page above to see its configuration summary here...
                                </div>
                            </div>
                        </div>

                        <div class="mt-4 text-end">
                            <button type="button" class="btn btn-secondary" id="resetBtn">
                                <i class="bi bi-arrow-counterclockwise me-2"></i>Reset All
                            </button>
                            <button type="button" class="btn btn-primary disabled" id="saveBtn" disabled>
                                <i class="bi bi-save me-2"></i>Save Configuration (Coming Soon)
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script>
        // Store current state of page validation requirements
        let pageValidationState = {};

        // Initialize page validation state
        document.addEventListener('DOMContentLoaded', function() {
            const selects = document.querySelectorAll('.validation-select');

            selects.forEach(function(select) {
                const pageUrl = select.getAttribute('data-page-url');
                pageValidationState[pageUrl] = [];

                // Update count badge
                updateValidationCount(pageUrl);

                // Add change listener
                select.addEventListener('change', function() {
                    const selectedOptions = Array.from(this.selectedOptions).map(opt => opt.value);
                    pageValidationState[pageUrl] = selectedOptions;
                    updateValidationCount(pageUrl);
                    updateConfigSummary(pageUrl);

                    // Log to console (for development)
                    console.log('Updated validations for', pageUrl, ':', selectedOptions);
                });

                // Add click listener to highlight row and show summary
                select.addEventListener('focus', function() {
                    // Remove highlight from all rows
                    document.querySelectorAll('#registryTableBody tr').forEach(row => {
                        row.classList.remove('table-active');
                    });

                    // Highlight current row
                    const row = this.closest('tr');
                    row.classList.add('table-active');

                    // Update summary
                    updateConfigSummary(pageUrl);
                });
            });
        });

        function updateValidationCount(pageUrl) {
            const badge = document.querySelector(`.validation-count[data-url="${pageUrl}"]`);
            const count = pageValidationState[pageUrl].length;

            if (count === 0) {
                badge.className = 'badge bg-secondary validation-count';
                badge.textContent = '0 validations required';
            } else if (count === 1) {
                badge.className = 'badge bg-warning text-dark validation-count';
                badge.textContent = '1 validation required';
            } else {
                badge.className = 'badge bg-danger validation-count';
                badge.textContent = `${count} validations required`;
            }
        }

        function updateConfigSummary(pageUrl) {
            const summaryDiv = document.getElementById('configSummary');
            const pageTitle = getPageTitle(pageUrl);
            const viewName = getViewName(pageUrl);

            let summary = `Configuration for: ${pageTitle}\n`;
            summary += `URL: ${pageUrl}\n`;
            summary += `View: ${viewName}\n`;
            summary += `${'='.repeat(60)}\n\n`;

            const validations = pageValidationState[pageUrl];

            if (validations.length === 0) {
                summary += 'Required Validations: NONE\n';
                summary += '└─ This page is always accessible (no validation checks)\n';
            } else {
                summary += `Required Validations: ${validations.length}\n\n`;
                validations.forEach((validationCode, index) => {
                    const isLast = index === validations.length - 1;
                    const prefix = isLast ? '└─' : '├─';
                    const validationTitle = getValidationTitle(validationCode);
                    summary += `${prefix} ${validationTitle}\n`;
                    summary += `   Code: ${validationCode}\n`;
                });

                summary += `\nBehavior:\n`;
                summary += `└─ Page will only load if ALL ${validations.length} validation(s) pass\n`;
                summary += `   If any validation fails, show warning and block access\n`;
            }

            summaryDiv.textContent = summary;
        }

        function getPageTitle(url) {
            const select = document.querySelector(`.validation-select[data-page-url="${url}"]`);
            if (select) {
                const row = select.closest('tr');
                const titleCell = row.querySelector('td:nth-child(2) strong');
                return titleCell ? titleCell.textContent.trim() : url;
            }
            return url;
        }

        function getViewName(url) {
            const select = document.querySelector(`.validation-select[data-page-url="${url}"]`);
            if (select) {
                const row = select.closest('tr');
                const viewCell = row.querySelector('td:nth-child(3) code');
                return viewCell ? viewCell.textContent : 'unknown';
            }
            return 'unknown';
        }

        function getValidationTitle(code) {
            const option = document.querySelector(`option[value="${code}"]`);
            if (option) {
                return option.textContent.trim();
            }
            return code;
        }

        // Reset button
        document.getElementById('resetBtn').addEventListener('click', function() {
            if (!confirm('Are you sure you want to reset all page validation requirements? This will clear all selections.')) {
                return;
            }

            const selects = document.querySelectorAll('.validation-select');
            selects.forEach(function(select) {
                select.selectedIndex = -1;
                const pageUrl = select.getAttribute('data-page-url');
                pageValidationState[pageUrl] = [];
                updateValidationCount(pageUrl);
            });

            document.getElementById('configSummary').textContent = 'Select a page above to see its configuration summary here...';

            console.log('All page validation requirements reset');
        });

        // Add hover effects to table rows
        document.addEventListener('DOMContentLoaded', function() {
            const rows = document.querySelectorAll('#registryTableBody tr');
            rows.forEach(function(row) {
                row.addEventListener('mouseenter', function() {
                    this.style.cursor = 'pointer';
                });
            });
        });
    </script>
{% endblock %}
