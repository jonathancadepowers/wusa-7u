{% extends "base.html" %}

{% block title %}Division Validation Registry - WUSA 7U{% endblock %}

{% block page_title %}Division Validation Registry{% endblock %}

{% block content %}
    {% csrf_token %}
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-11">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0"><i class="bi bi-diagram-3 me-2"></i>Division Validation Registry</h4>
                    </div>
                    <div class="card-body">
                        <p class="lead mb-4">
                            Configure which validation codes are required for each page to load, and which validations should be triggered when CRUD actions occur on each page.
                        </p>

                        <div class="alert alert-info mb-4">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>Configuration Mode:</strong> Select validations for each page and click "Save Configuration" to persist your changes to the database.
                        </div>

                        <div class="table-responsive">
                            <table class="table table-hover table-bordered">
                                <thead class="table-dark">
                                    <tr>
                                        <th style="width: 25%;">URL</th>
                                        <th style="width: 37.5%;">
                                            Validations to Run on Page Load
                                            <i class="bi bi-info-circle ms-1"
                                               data-bs-toggle="tooltip"
                                               data-bs-placement="top"
                                               title="These validations must pass before the page can load"
                                               style="cursor: help; font-size: 0.9em;"></i>
                                        </th>
                                        <th style="width: 37.5%;">
                                            Validation Code Triggers
                                            <i class="bi bi-info-circle ms-1"
                                               data-bs-toggle="tooltip"
                                               data-bs-placement="top"
                                               title="These validations will be re-evaluated after any CRUD action on this page"
                                               style="cursor: help; font-size: 0.9em;"></i>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="registryTableBody">
                                    {% for page in pages %}
                                        <tr data-page-url="{{ page.url }}">
                                            <td><code><a href="{{ page.url }}" target="_blank">{{ page.url }}</a></code></td>
                                            <td>
                                                <select
                                                    class="form-select validation-multiselect-load"
                                                    multiple
                                                    data-page-url="{{ page.url }}"
                                                    size="8"
                                                    style="width: 100%;">
                                                    {% for validation in all_validation_codes %}
                                                        <option
                                                            value="{{ validation.code }}"
                                                            data-bs-toggle="tooltip"
                                                            data-bs-placement="right"
                                                            data-bs-html="true"
                                                            title="<pre style='text-align: left; margin: 0; font-size: 11px; white-space: pre; max-width: none;'>{{ validation.source|escape }}</pre>">
                                                            {{ validation.code }}
                                                        </option>
                                                    {% endfor %}
                                                </select>
                                            </td>
                                            <td>
                                                <select
                                                    class="form-select validation-multiselect-trigger"
                                                    multiple
                                                    data-page-url="{{ page.url }}"
                                                    size="8"
                                                    style="width: 100%;">
                                                    {% for validation in all_validation_codes %}
                                                        <option
                                                            value="{{ validation.code }}"
                                                            data-bs-toggle="tooltip"
                                                            data-bs-placement="right"
                                                            data-bs-html="true"
                                                            title="<pre style='text-align: left; margin: 0; font-size: 11px; white-space: pre; max-width: none;'>{{ validation.source|escape }}</pre>">
                                                            {{ validation.code }}
                                                        </option>
                                                    {% endfor %}
                                                </select>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <div class="mt-4 text-end">
                            <button type="button" class="btn btn-secondary" id="resetBtn">
                                <i class="bi bi-arrow-counterclockwise me-2"></i>Reset All
                            </button>
                            <button type="button" class="btn btn-primary" id="saveBtn">
                                <i class="bi bi-save me-2"></i>Save Configuration
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script>
        // Store current state of page validation requirements
        let pageValidationState = {};

        // Initialize tooltips
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Bootstrap tooltips on select options
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl, {
                    boundary: 'window',
                    customClass: 'code-tooltip'
                });
            });

            // Initialize page validation state
            {% for page in pages %}
                pageValidationState['{{ page.url }}'] = {
                    validations_to_run_on_page_load: [],
                    validation_code_triggers: []
                };
            {% endfor %}

            // Add change listeners to all multi-selects
            const loadSelects = document.querySelectorAll('.validation-multiselect-load');
            loadSelects.forEach(function(select) {
                select.addEventListener('change', function() {
                    updateValidationState();
                });
            });

            const triggerSelects = document.querySelectorAll('.validation-multiselect-trigger');
            triggerSelects.forEach(function(select) {
                select.addEventListener('change', function() {
                    updateValidationState();
                });
            });
        });

        function updateValidationState() {
            // Reset state
            {% for page in pages %}
                pageValidationState['{{ page.url }}'] = {
                    validations_to_run_on_page_load: [],
                    validation_code_triggers: []
                };
            {% endfor %}

            // Read all "load" multi-selects
            const loadSelects = document.querySelectorAll('.validation-multiselect-load');
            loadSelects.forEach(function(select) {
                const pageUrl = select.getAttribute('data-page-url');
                const selectedOptions = Array.from(select.selectedOptions);
                selectedOptions.forEach(function(option) {
                    pageValidationState[pageUrl].validations_to_run_on_page_load.push(option.value);
                });
            });

            // Read all "trigger" multi-selects
            const triggerSelects = document.querySelectorAll('.validation-multiselect-trigger');
            triggerSelects.forEach(function(select) {
                const pageUrl = select.getAttribute('data-page-url');
                const selectedOptions = Array.from(select.selectedOptions);
                selectedOptions.forEach(function(option) {
                    pageValidationState[pageUrl].validation_code_triggers.push(option.value);
                });
            });

            // Log to console (for development)
            console.log('Updated validation state:', pageValidationState);
        }

        // Load existing configurations from database
        function loadExistingConfigs() {
            const existingConfigs = JSON.parse('{{ existing_configs|safe }}');

            // Pre-select options based on saved configurations
            for (const pageUrl in existingConfigs) {
                const config = existingConfigs[pageUrl];

                // Load "validations_to_run_on_page_load"
                const loadSelect = document.querySelector(`.validation-multiselect-load[data-page-url="${pageUrl}"]`);
                if (loadSelect && config.validations_to_run_on_page_load) {
                    Array.from(loadSelect.options).forEach(option => {
                        if (config.validations_to_run_on_page_load.includes(option.value)) {
                            option.selected = true;
                        }
                    });
                }

                // Load "validation_code_triggers"
                const triggerSelect = document.querySelector(`.validation-multiselect-trigger[data-page-url="${pageUrl}"]`);
                if (triggerSelect && config.validation_code_triggers) {
                    Array.from(triggerSelect.options).forEach(option => {
                        if (config.validation_code_triggers.includes(option.value)) {
                            option.selected = true;
                        }
                    });
                }
            }

            // Update the state after loading
            updateValidationState();
        }

        // Load configurations on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadExistingConfigs();
        });

        // Reset button
        document.getElementById('resetBtn').addEventListener('click', function() {
            if (!confirm('Are you sure you want to reset all validation requirements? This will clear all selections.')) {
                return;
            }

            const loadSelects = document.querySelectorAll('.validation-multiselect-load');
            loadSelects.forEach(function(select) {
                select.selectedIndex = -1;
            });

            const triggerSelects = document.querySelectorAll('.validation-multiselect-trigger');
            triggerSelects.forEach(function(select) {
                select.selectedIndex = -1;
            });

            updateValidationState();

            console.log('All validation requirements reset');
        });

        // Save button
        document.getElementById('saveBtn').addEventListener('click', function() {
            // Update state before saving
            updateValidationState();

            // Get CSRF token
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]') ?
                             document.querySelector('[name=csrfmiddlewaretoken]').value :
                             getCookie('csrftoken');

            // Disable save button during request
            const saveBtn = document.getElementById('saveBtn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';

            // Send AJAX request to save configuration
            fetch(window.location.href, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify(pageValidationState)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Configuration saved successfully!');
                } else {
                    alert('Error saving configuration: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error saving configuration: ' + error);
            })
            .finally(() => {
                // Re-enable save button
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="bi bi-save me-2"></i>Save Configuration';
            });
        });

        // Helper function to get CSRF token from cookie
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>

    <style>
        .code-tooltip .tooltip-inner {
            max-width: 90vw;
            text-align: left;
            background-color: #2d2d2d;
            overflow-x: auto;
        }

        .code-tooltip pre {
            white-space: pre;
            margin: 0;
            max-width: none;
        }

        .validation-multiselect-load,
        .validation-multiselect-trigger {
            cursor: pointer;
            font-family: monospace;
            font-size: 0.9em;
        }

        .validation-multiselect-load option,
        .validation-multiselect-trigger option {
            padding: 8px;
        }

        .validation-multiselect-load option:hover,
        .validation-multiselect-trigger option:hover {
            background-color: #e9ecef;
        }

        tbody tr:hover {
            background-color: #f8f9fa;
        }
    </style>
{% endblock %}
